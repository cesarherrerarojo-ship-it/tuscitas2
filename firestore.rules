rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ============ HELPERS con CUSTOM CLAIMS ============
    function isAuthed() { return request.auth != null; }
    function uid() { return request.auth.uid; }
    function role() { return request.auth.token.role != null ? request.auth.token.role : 'regular'; }
    function gender() { return request.auth.token.gender; }

    function isAdmin() { return isAuthed() && role() == 'admin'; }
    function isConcierge() { return isAuthed() && role() == 'concierge'; }
    function isMale() { return isAuthed() && gender() == 'masculino'; }
    function isFemale() { return isAuthed() && gender() == 'femenino'; }

    // ============ USERS ============
    match /users/{userId} {
      // Creación: Durante registro inicial
      allow create: if isAuthed()
                    && uid() == userId
                    && request.resource.data.gender in ['masculino','femenino']
                    && request.resource.data.userRole in ['regular']  // Solo pueden crear cuenta regular
                    && request.resource.data.keys().hasAll(['alias','gender','userRole','birthDate','email','createdAt']);

      // Lectura: Usuarios autenticados pueden ver perfiles
      allow read: if isAuthed();

      // Actualización: El dueño puede actualizar su perfil (menos userRole que solo admin cambia)
      allow update: if isAuthed() && (
        // Usuario actualizando su propio perfil
        (uid() == userId && !request.resource.data.diff(resource.data).affectedKeys().hasAny(['userRole','email','createdAt'])) ||
        // Admin puede cambiar userRole y otros campos
        isAdmin()
      );

      // Borrado: Solo admin
      allow delete: if isAdmin();
    }

    // ============ VIP EVENTS (Concierge System) ============
    match /vip_events/{eventId} {
      // Lectura: Solo mujeres, concierges y admins
      allow read: if isAuthed() && (isFemale() || isConcierge() || isAdmin());

      // Creación: Solo concierges aprobados
      allow create: if isConcierge()
                    && request.resource.data.conciergeId == uid()
                    && request.resource.data.status == 'published';

      // Actualización: Solo el concierge dueño del evento o admin
      allow update: if isAuthed() && (
        (isConcierge() && resource.data.conciergeId == uid()) ||
        isAdmin()
      );

      // Borrado: Solo el concierge dueño o admin
      allow delete: if isAuthed() && (
        (isConcierge() && resource.data.conciergeId == uid()) ||
        isAdmin()
      );
    }

    // ============ VIP APPLICATIONS ============
    match /vip_applications/{applicationId} {
      // Lectura:
      // - La mujer que aplicó
      // - El concierge del evento
      // - Admins
      allow read: if isAuthed() && (
        resource.data.userId == uid() ||
        (isConcierge() && get(/databases/$(database)/documents/vip_events/$(resource.data.eventId)).data.conciergeId == uid()) ||
        isAdmin()
      );

      // Creación: Solo mujeres aplicando a eventos
      allow create: if isFemale()
                    && request.resource.data.userId == uid()
                    && request.resource.data.status == 'pending'
                    && exists(/databases/$(database)/documents/vip_events/$(request.resource.data.eventId));

      // Actualización: El concierge del evento puede cambiar status a 'selected' o 'rejected'
      allow update: if isAuthed() && (
        (isConcierge() &&
         get(/databases/$(database)/documents/vip_events/$(resource.data.eventId)).data.conciergeId == uid() &&
         request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status','updatedAt']) &&
         request.resource.data.status in ['selected','rejected']) ||
        isAdmin()
      );

      // Borrado: Solo admin
      allow delete: if isAdmin();
    }

    // ============ MATCHES (Date Requests) ============
    match /matches/{matchId} {
      // Lectura: El que envió o el que recibió
      allow read: if isAuthed() && (
        resource.data.senderId == uid() ||
        resource.data.receiverId == uid() ||
        isAdmin()
      );

      // Creación: Usuario autenticado enviando solicitud
      allow create: if isAuthed()
                    && request.resource.data.senderId == uid()
                    && request.resource.data.status == 'pending';

      // Actualización: El receptor puede aceptar/rechazar
      allow update: if isAuthed() && (
        (resource.data.receiverId == uid() &&
         request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status','updatedAt']) &&
         request.resource.data.status in ['accepted','rejected']) ||
        isAdmin()
      );

      // Borrado: Solo quien envió o admin
      allow delete: if isAuthed() && (
        resource.data.senderId == uid() ||
        isAdmin()
      );
    }

    // ============ CONVERSATIONS ============
    match /conversations/{conversationId} {
      // Lectura: Participantes, admin, concierge
      allow read: if isAuthed() && (
        uid() in resource.data.participants ||
        isAdmin() ||
        isConcierge()
      );

      // Creación: El creador debe estar en participants
      allow create: if isAuthed()
                    && request.resource.data.participants is list
                    && uid() in request.resource.data.participants;

      // Actualización: Participantes, admin, concierge
      allow update: if isAuthed() && (
        uid() in resource.data.participants ||
        isAdmin() ||
        isConcierge()
      );

      // Borrado: Solo admin
      allow delete: if isAdmin();

      // Mensajes (si usas subcolección)
      match /messages/{messageId} {
        allow read: if isAuthed() && (
          uid() in get(/databases/$(database)/documents/conversations/$(conversationId)).data.participants ||
          isAdmin() ||
          isConcierge()
        );

        allow create: if isAuthed() &&
          uid() in get(/databases/$(database)/documents/conversations/$(conversationId)).data.participants &&
          request.resource.data.senderId == uid();

        allow update, delete: if isAdmin();
      }
    }

    // ============ REPORTS ============
    match /reports/{reportId} {
      // Lectura: Solo admins y el que reportó
      allow read: if isAuthed() && (
        resource.data.reporterId == uid() ||
        isAdmin()
      );

      // Creación: Usuario autenticado reportando
      allow create: if isAuthed()
                    && request.resource.data.reporterId == uid()
                    && request.resource.data.status == 'pending';

      // Actualización: Solo admin (para cambiar status a 'reviewed', 'resolved', etc.)
      allow update: if isAdmin();

      // Borrado: Solo admin
      allow delete: if isAdmin();
    }

    // ============ SOS ALERTS ============
    match /sos_alerts/{alertId} {
      // Lectura: Solo admins y el usuario que activó SOS
      allow read: if isAuthed() && (
        resource.data.userId == uid() ||
        isAdmin()
      );

      // Creación: Usuario en emergencia
      allow create: if isAuthed()
                    && request.resource.data.userId == uid()
                    && request.resource.data.status == 'active';

      // Actualización: El usuario puede desactivar, admin puede todo
      allow update: if isAuthed() && (
        (resource.data.userId == uid() &&
         request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status','deactivatedAt']) &&
         request.resource.data.status == 'deactivated') ||
        isAdmin()
      );

      // Borrado: Solo admin
      allow delete: if isAdmin();
    }

    // ============ PAYMENTS / SUBSCRIPTIONS ============
    match /subscriptions/{subscriptionId} {
      // Lectura: Solo el dueño y admin
      allow read: if isAuthed() && (
        resource.data.userId == uid() ||
        isAdmin()
      );

      // Creación: Backend o admin (cuando procesa pago con Stripe)
      allow create: if isAdmin();

      // Actualización: Backend o admin (cuando actualiza status)
      allow update: if isAdmin();

      // Borrado: Solo admin
      allow delete: if isAdmin();
    }

    // ============ INSURANCE (Anti-Ghosting) ============
    match /insurances/{insuranceId} {
      // Lectura: Solo el dueño y admin
      allow read: if isAuthed() && (
        resource.data.userId == uid() ||
        isAdmin()
      );

      // Creación/Actualización: Backend o admin
      allow create, update: if isAdmin();

      // Borrado: Solo admin
      allow delete: if isAdmin();
    }

    // ============ BLOCKED USERS ============
    match /users/{userId}/blocked_users/{blockedUserId} {
      // Lectura: Solo el dueño
      allow read: if isAuthed() && uid() == userId;

      // Creación: El usuario puede bloquear
      allow create: if isAuthed() && uid() == userId;

      // Borrado: El usuario puede desbloquear
      allow delete: if isAuthed() && uid() == userId;
    }

    // ============ ADMIN LOGS ============
    match /admin_logs/{logId} {
      // Solo lectura para admins
      allow read: if isAdmin();

      // Solo creación por admin (o backend con privilegios admin)
      allow create: if isAdmin();

      // No se pueden modificar ni borrar logs
      allow update, delete: if false;
    }

    // ============ DEFAULT DENY ============
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
