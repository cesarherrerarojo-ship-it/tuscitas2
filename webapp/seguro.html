<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Seguro Anti-Plantón - TuCitaSegura</title>

  <!-- Tailwind CSS -->
  <link rel="stylesheet" href="./css/output.css">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- PayPal SDK with Vault -->
  <script src="https://www.paypal.com/sdk/js?client-id=YOUR_PAYPAL_CLIENT_ID&currency=EUR&vault=true&intent=tokenize"></script>

  <style>
    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
      min-height: 100vh;
    }

    .glass {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .glass-strong {
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .shimmer {
      animation: shimmer 2s infinite;
    }

    @keyframes shimmer {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .fade-in {
      animation: fadeIn 0.5s ease-out;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
  </style>
</head>
<body class="text-white">

  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="fixed inset-0 bg-black/80 flex items-center justify-center z-[100]">
    <div class="text-center">
      <div class="inline-block animate-spin rounded-full h-16 w-16 border-4 border-white border-t-transparent mb-4"></div>
      <p class="text-xl font-semibold">Cargando...</p>
    </div>
  </div>

  <!-- Success Modal -->
  <div id="successModal" class="hidden fixed inset-0 bg-black/80 flex items-center justify-center z-[100] p-4">
    <div class="glass-strong rounded-2xl max-w-md w-full p-8 text-center fade-in">
      <div class="w-20 h-20 bg-gradient-to-r from-green-400 to-emerald-500 rounded-full flex items-center justify-center mx-auto mb-6">
        <i class="fas fa-shield-check text-4xl text-white"></i>
      </div>
      <h3 class="text-3xl font-bold mb-4">¡Seguro Activado!</h3>
      <p class="text-slate-200 mb-6">Tu seguro anti-plantón ha sido activado exitosamente. Ahora puedes agendar citas con total confianza.</p>
      <button onclick="redirectToSearch()" class="w-full bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white font-bold py-3 px-6 rounded-xl transition transform hover:scale-105">
        Comenzar a Buscar
      </button>
    </div>
  </div>

  <!-- Error Modal -->
  <div id="errorModal" class="hidden fixed inset-0 bg-black/80 flex items-center justify-center z-[100] p-4">
    <div class="glass-strong rounded-2xl max-w-md w-full p-8 text-center fade-in">
      <div class="w-20 h-20 bg-gradient-to-r from-red-400 to-red-600 rounded-full flex items-center justify-center mx-auto mb-6">
        <i class="fas fa-exclamation-circle text-4xl text-white"></i>
      </div>
      <h3 class="text-3xl font-bold mb-4">Error en el Pago</h3>
      <p id="errorMessage" class="text-slate-200 mb-6">Hubo un problema al procesar tu pago. Por favor, intenta nuevamente.</p>
      <button onclick="closeErrorModal()" class="w-full bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white font-bold py-3 px-6 rounded-xl transition transform hover:scale-105">
        Intentar Nuevamente
      </button>
      <button onclick="redirectToSearch()" class="w-full mt-3 glass hover:glass-strong text-white font-semibold py-3 px-6 rounded-xl transition">
        Volver a Buscar
      </button>
    </div>
  </div>

  <!-- Main Content -->
  <div class="container mx-auto px-4 py-8 max-w-4xl">

    <!-- Header -->
    <div class="text-center mb-8">
      <a href="/webapp/buscar-usuarios.html" class="inline-flex items-center gap-2 text-white/80 hover:text-white mb-6 transition">
        <i class="fas fa-arrow-left"></i>
        <span>Volver a búsqueda</span>
      </a>
      <h1 class="text-4xl md:text-5xl font-bold mb-4">
        <i class="fas fa-shield-check text-green-400"></i>
        Seguro Anti-Plantón
      </h1>
      <p class="text-xl text-slate-200">Protección garantizada para tus citas</p>
    </div>

    <!-- Pricing Card -->
    <div class="glass-strong rounded-2xl p-8 mb-8 fade-in">
      <div class="text-center mb-8">
        <div class="inline-block bg-gradient-to-r from-green-400 to-emerald-500 text-white px-4 py-2 rounded-full text-sm font-bold mb-4">
          AUTORIZACIÓN - NO PAGO INMEDIATO
        </div>
        <div class="text-6xl font-bold mb-2">
          €120
        </div>
        <p class="text-slate-300 text-lg">Solo se cobra si plantas a alguien - válido para siempre</p>
      </div>

      <!-- Features List -->
      <div class="space-y-4 mb-8">
        <div class="flex items-start gap-3">
          <div class="w-8 h-8 bg-green-500/20 rounded-full flex items-center justify-center flex-shrink-0 mt-1">
            <i class="fas fa-check text-green-400"></i>
          </div>
          <div>
            <h4 class="font-bold text-lg">Agenda Citas sin Límites</h4>
            <p class="text-slate-300">Organiza todas las citas que quieras con total libertad</p>
          </div>
        </div>

        <div class="flex items-start gap-3">
          <div class="w-8 h-8 bg-green-500/20 rounded-full flex items-center justify-center flex-shrink-0 mt-1">
            <i class="fas fa-check text-green-400"></i>
          </div>
          <div>
            <h4 class="font-bold text-lg">Protección Económica</h4>
            <p class="text-slate-300">Si tu cita no se presenta, recuperas tu inversión</p>
          </div>
        </div>

        <div class="flex items-start gap-3">
          <div class="w-8 h-8 bg-green-500/20 rounded-full flex items-center justify-center flex-shrink-0 mt-1">
            <i class="fas fa-check text-green-400"></i>
          </div>
          <div>
            <h4 class="font-bold text-lg">Sistema de Verificación</h4>
            <p class="text-slate-300">Confirmación de asistencia en tiempo real</p>
          </div>
        </div>

        <div class="flex items-start gap-3">
          <div class="w-8 h-8 bg-green-500/20 rounded-full flex items-center justify-center flex-shrink-0 mt-1">
            <i class="fas fa-check text-green-400"></i>
          </div>
          <div>
            <h4 class="font-bold text-lg">Reputación Protegida</h4>
            <p class="text-slate-300">Los plantones afectan negativamente la reputación del otro usuario</p>
          </div>
        </div>

        <div class="flex items-start gap-3">
          <div class="w-8 h-8 bg-green-500/20 rounded-full flex items-center justify-center flex-shrink-0 mt-1">
            <i class="fas fa-check text-green-400"></i>
          </div>
          <div>
            <h4 class="font-bold text-lg">Válido Para Siempre</h4>
            <p class="text-slate-300">Pago único sin renovaciones ni cargos adicionales</p>
          </div>
        </div>

        <div class="flex items-start gap-3">
          <div class="w-8 h-8 bg-green-500/20 rounded-full flex items-center justify-center flex-shrink-0 mt-1">
            <i class="fas fa-check text-green-400"></i>
          </div>
          <div>
            <h4 class="font-bold text-lg">Soporte Dedicado</h4>
            <p class="text-slate-300">Asistencia prioritaria para cualquier incidencia</p>
          </div>
        </div>
      </div>

      <!-- How It Works -->
      <div class="glass rounded-xl p-6 mb-6">
        <h4 class="font-bold text-xl mb-4 text-center">
          <i class="fas fa-info-circle text-blue-400 mr-2"></i>
          ¿Cómo Funciona?
        </h4>
        <ol class="space-y-3 text-slate-300">
          <li class="flex gap-3">
            <span class="font-bold text-white">1.</span>
            <span><strong class="text-white">Autorizas el método de pago</strong> - No se cobra nada ahora, solo guardamos tu método de pago de forma segura</span>
          </li>
          <li class="flex gap-3">
            <span class="font-bold text-white">2.</span>
            <span><strong class="text-white">Agendar citas libremente</strong> - Puedes programar todas las citas que quieras sin límites</span>
          </li>
          <li class="flex gap-3">
            <span class="font-bold text-white">3.</span>
            <span><strong class="text-white">Verificación al llegar</strong> - Ambos confirman asistencia al llegar al lugar de la cita</span>
          </li>
          <li class="flex gap-3">
            <span class="font-bold text-white">4.</span>
            <span><strong class="text-white">Solo se cobra si plantas</strong> - Si no asistes a una cita confirmada, se cobran los €120 de tu método de pago guardado</span>
          </li>
        </ol>
      </div>

      <!-- Important Notice about Payment -->
      <div class="bg-green-500/20 border-2 border-green-400 rounded-xl p-4 mb-6 text-center">
        <i class="fas fa-shield-check text-green-400 text-2xl mb-2"></i>
        <p class="text-sm text-green-100">
          <strong>⚠️ IMPORTANTE:</strong> No se te cobrará nada al activar el seguro. Solo autorizas tu método de pago.
          <br>
          El cargo de €120 solo se realizará si plantas a alguien en una cita confirmada.
        </p>
      </div>

      <!-- PayPal Button Container -->
      <div id="paypal-button-container" class="mb-4"></div>

      <!-- Security Notice -->
      <div class="glass rounded-xl p-4 text-center text-sm text-slate-300">
        <i class="fas fa-lock mr-2"></i>
        Método de pago seguro guardado por PayPal. No se realiza ningún cargo al activar el seguro.
        <br>
        Solo se cobrará €120 si plantas a alguien en una cita confirmada.
      </div>
    </div>

    <!-- Important Notice -->
    <div class="glass-strong rounded-2xl p-6 mb-8 border-2 border-yellow-500/50 fade-in">
      <div class="flex items-start gap-4">
        <div class="w-12 h-12 bg-yellow-500/20 rounded-full flex items-center justify-center flex-shrink-0">
          <i class="fas fa-exclamation-triangle text-yellow-400 text-xl"></i>
        </div>
        <div>
          <h4 class="font-bold text-xl mb-2 text-yellow-400">Requisito Importante</h4>
          <p class="text-slate-200">Para agendar citas necesitas tanto la <strong>membresía premium</strong> (€29.99/mes) como el <strong>seguro anti-plantón</strong> (€120 pago único).</p>
          <p class="text-slate-300 mt-2">Si aún no tienes la membresía premium, puedes contratarla <a href="/webapp/suscripcion.html" class="text-yellow-400 hover:text-yellow-300 underline">aquí</a>.</p>
        </div>
      </div>
    </div>

    <!-- FAQ Section -->
    <div class="glass-strong rounded-2xl p-8 fade-in">
      <h3 class="text-2xl font-bold mb-6 text-center">Preguntas Frecuentes</h3>

      <div class="space-y-4">
        <details class="glass rounded-xl p-4 cursor-pointer">
          <summary class="font-bold text-lg">¿Me cobran €120 ahora?</summary>
          <p class="mt-3 text-slate-300"><strong class="text-white">NO.</strong> Al activar el seguro solo autorizas tu método de pago (tarjeta o cuenta PayPal). No se te cobra nada. El cargo de €120 solo se realiza si plantas a alguien en una cita confirmada. Si asistes a todas tus citas, nunca se te cobrará.</p>
        </details>

        <details class="glass rounded-xl p-4 cursor-pointer">
          <summary class="font-bold text-lg">¿Cuándo se cobra exactamente?</summary>
          <p class="mt-3 text-slate-300">Los €120 solo se cobran automáticamente de tu método de pago guardado cuando nuestro sistema verifica que no asististe a una cita confirmada. Esto sucede cuando la otra persona verifica su asistencia y tú no. El cargo se procesa inmediatamente después de la verificación.</p>
        </details>

        <details class="glass rounded-xl p-4 cursor-pointer">
          <summary class="font-bold text-lg">¿Qué pasa si me plantan?</summary>
          <p class="mt-3 text-slate-300">Si tu cita no se presenta y no verifica su asistencia, a ella se le cobrará €120 de su método de pago guardado. Su reputación bajará significativamente y podrías recibir compensación según las políticas de la plataforma.</p>
        </details>

        <details class="glass rounded-xl p-4 cursor-pointer">
          <summary class="font-bold text-lg">¿La autorización caduca?</summary>
          <p class="mt-3 text-slate-300">No, la autorización de pago es válida para siempre mientras mantengas tu cuenta activa. Puedes revocarla en cualquier momento desde tu perfil, pero perderás la capacidad de agendar citas.</p>
        </details>

        <details class="glass rounded-xl p-4 cursor-pointer">
          <summary class="font-bold text-lg">¿Puedo usar saldo de PayPal?</summary>
          <p class="mt-3 text-slate-300">No, para autorizaciones de pago futuro PayPal requiere una tarjeta de crédito o débito vinculada. El saldo de PayPal no permite este tipo de autorizaciones. Debes tener una tarjeta registrada en tu cuenta de PayPal.</p>
        </details>

        <details class="glass rounded-xl p-4 cursor-pointer">
          <summary class="font-bold text-lg">¿Es seguro guardar mi método de pago?</summary>
          <p class="mt-3 text-slate-300">Absolutamente. PayPal guarda tu método de pago de forma encriptada en sus servidores. Nosotros solo recibimos un token seguro, nunca vemos ni almacenamos los datos de tu tarjeta. Solo PayPal puede procesar cobros con este token.</p>
        </details>

        <details class="glass rounded-xl p-4 cursor-pointer">
          <summary class="font-bold text-lg">¿También necesito la membresía?</summary>
          <p class="mt-3 text-slate-300">Sí, para agendar citas necesitas tanto la membresía premium (€29.99/mes) para enviar solicitudes y chatear, como el seguro anti-plantón (autorización de €120) para confirmar las citas.</p>
        </details>
      </div>
    </div>

  </div>

  <!-- Error Fixes -->
  <script src="/webapp/js/error-fixes.js"></script>

  <!-- Firebase SDK -->
  <script type="module">
    // Import App Check FIRST (must be before firebase-config.js)
    // TEMP DISABLED (throttling): import './js/firebase-appcheck.js';

    // Then import Firebase services
    import { auth, db, functions } from './js/firebase-config.js';
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { doc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { httpsCallable } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-functions.js";
    import { showToast } from './js/utils.js';
    import { loadTheme } from './js/theme.js';

    let currentUser = null;

    // Check authentication
    onAuthStateChanged(auth, (user) => {
      if (user) {
        currentUser = user;
        document.getElementById('loadingOverlay').classList.add('hidden');
        initPayPalButton();
      } else {
        // Redirect to login if not authenticated
        window.location.href = '/login.html';
      }
    });

    // Initialize PayPal Button with Vault
    function initPayPalButton() {
      paypal.Buttons({
        style: {
          shape: 'rect',
          color: 'gold',
          layout: 'vertical',
          label: 'paypal',
          height: 50
        },

        // Create Vault Setup Token (saves payment method, doesn't charge)
        createVaultSetupToken: async function(data, actions) {
          try {
            // Call Cloud Function to create vault setup token
            const createVaultSetup = httpsCallable(functions, 'createInsuranceVaultSetup');
            const result = await createVaultSetup();

            console.log('Vault setup token created:', result.data.setupToken);
            return result.data.setupToken;

          } catch (error) {
            console.error('Error creating vault setup:', error);
            showError('Error al configurar el método de pago. Por favor intenta nuevamente.');
            throw error;
          }
        },

        // When user approves, PayPal returns a payment token
        onApprove: async function(data, actions) {
          // Mostrar overlay de carga
          document.getElementById('loadingOverlay').classList.remove('hidden');

          try {
            console.log('Payment method approved:', data);

            // Get the payment token from PayPal's response
            // The payment token is in data.vaultSetupToken
            const paymentToken = data.vaultSetupToken;

            if (!paymentToken) {
              throw new Error('No payment token received from PayPal');
            }

            console.log('Payment token received:', paymentToken);

            // Save payment token to Firestore
            const userRef = doc(db, 'users', currentUser.uid);

            await updateDoc(userRef, {
              hasAntiGhostingInsurance: true,
              insurancePaymentToken: paymentToken, // Save payment token for future charges
              insurancePurchaseDate: serverTimestamp(),
              insuranceAmount: 120,
              insuranceType: 'vault', // Indicate this is a vault-based insurance
              updatedAt: serverTimestamp()
            });

            console.log('Firestore updated successfully with payment token');

            // Ocultar overlay de carga
            document.getElementById('loadingOverlay').classList.add('hidden');

            // Mostrar modal de éxito
            document.getElementById('successModal').classList.remove('hidden');

          } catch (error) {
            console.error('Error saving payment method:', error);
            document.getElementById('loadingOverlay').classList.add('hidden');
            showError('Error al activar tu seguro. Por favor contacta soporte.');
          }
        },

        onError: function(err) {
          console.error('PayPal error:', err);
          document.getElementById('loadingOverlay').classList.add('hidden');
          showError('Hubo un error al procesar el pago. Por favor intenta nuevamente.');
        },

        onCancel: function(data) {
          console.log('Payment cancelled:', data);
          document.getElementById('loadingOverlay').classList.add('hidden');
          showError('Cancelaste el proceso de pago. Tu seguro no fue activado.');
        }

      }).render('#paypal-button-container');
    }

    // Show error modal
    function showError(message) {
      document.getElementById('errorMessage').textContent = message;
      document.getElementById('errorModal').classList.remove('hidden');
    }

    // Close error modal
    window.closeErrorModal = function() {
      document.getElementById('errorModal').classList.add('hidden');
    };

    // Redirect to search page
    window.redirectToSearch = function() {
      window.location.href = '/webapp/buscar-usuarios.html';
    };

  </script>

</body>
</html>
