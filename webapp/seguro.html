<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Seguro Anti-Plantón - TuCitaSegura</title>

  <!-- Tailwind CSS -->
  <link rel="stylesheet" href="./css/output.css">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- PayPal SDK -->
  <script src="https://www.paypal.com/sdk/js?client-id=YOUR_PAYPAL_CLIENT_ID&currency=EUR"></script>

  <style>
    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
      min-height: 100vh;
    }

    .glass {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .glass-strong {
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .shimmer {
      animation: shimmer 2s infinite;
    }

    @keyframes shimmer {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .fade-in {
      animation: fadeIn 0.5s ease-out;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
  </style>
</head>
<body class="text-white">

  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="fixed inset-0 bg-black/80 flex items-center justify-center z-[100]">
    <div class="text-center">
      <div class="inline-block animate-spin rounded-full h-16 w-16 border-4 border-white border-t-transparent mb-4"></div>
      <p class="text-xl font-semibold">Cargando...</p>
    </div>
  </div>

  <!-- Success Modal -->
  <div id="successModal" class="hidden fixed inset-0 bg-black/80 flex items-center justify-center z-[100] p-4">
    <div class="glass-strong rounded-2xl max-w-md w-full p-8 text-center fade-in">
      <div class="w-20 h-20 bg-gradient-to-r from-green-400 to-emerald-500 rounded-full flex items-center justify-center mx-auto mb-6">
        <i class="fas fa-shield-check text-4xl text-white"></i>
      </div>
      <h3 class="text-3xl font-bold mb-4">¡Seguro Activado!</h3>
      <p class="text-slate-200 mb-6">Tu seguro anti-plantón ha sido activado exitosamente. Ahora puedes agendar citas con total confianza.</p>
      <button onclick="redirectToSearch()" class="w-full bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white font-bold py-3 px-6 rounded-xl transition transform hover:scale-105">
        Comenzar a Buscar
      </button>
    </div>
  </div>

  <!-- Error Modal -->
  <div id="errorModal" class="hidden fixed inset-0 bg-black/80 flex items-center justify-center z-[100] p-4">
    <div class="glass-strong rounded-2xl max-w-md w-full p-8 text-center fade-in">
      <div class="w-20 h-20 bg-gradient-to-r from-red-400 to-red-600 rounded-full flex items-center justify-center mx-auto mb-6">
        <i class="fas fa-exclamation-circle text-4xl text-white"></i>
      </div>
      <h3 class="text-3xl font-bold mb-4">Error en el Pago</h3>
      <p id="errorMessage" class="text-slate-200 mb-6">Hubo un problema al procesar tu pago. Por favor, intenta nuevamente.</p>
      <button onclick="closeErrorModal()" class="w-full bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white font-bold py-3 px-6 rounded-xl transition transform hover:scale-105">
        Intentar Nuevamente
      </button>
      <button onclick="redirectToSearch()" class="w-full mt-3 glass hover:glass-strong text-white font-semibold py-3 px-6 rounded-xl transition">
        Volver a Buscar
      </button>
    </div>
  </div>

  <!-- Main Content -->
  <div class="container mx-auto px-4 py-8 max-w-4xl">

    <!-- Header -->
    <div class="text-center mb-8">
      <a href="/webapp/buscar-usuarios.html" class="inline-flex items-center gap-2 text-white/80 hover:text-white mb-6 transition">
        <i class="fas fa-arrow-left"></i>
        <span>Volver a búsqueda</span>
      </a>
      <h1 class="text-4xl md:text-5xl font-bold mb-4">
        <i class="fas fa-shield-check text-green-400"></i>
        Seguro Anti-Plantón
      </h1>
      <p class="text-xl text-slate-200">Protección garantizada para tus citas</p>
    </div>

    <!-- Pricing Card -->
    <div class="glass-strong rounded-2xl p-8 mb-8 fade-in">
      <div class="text-center mb-8">
        <div class="inline-block bg-gradient-to-r from-green-400 to-emerald-500 text-white px-4 py-2 rounded-full text-sm font-bold mb-4">
          PAGO ÚNICO
        </div>
        <div class="text-6xl font-bold mb-2">
          €120
        </div>
        <p class="text-slate-300 text-lg">pago único - válido para siempre</p>
      </div>

      <!-- Features List -->
      <div class="space-y-4 mb-8">
        <div class="flex items-start gap-3">
          <div class="w-8 h-8 bg-green-500/20 rounded-full flex items-center justify-center flex-shrink-0 mt-1">
            <i class="fas fa-check text-green-400"></i>
          </div>
          <div>
            <h4 class="font-bold text-lg">Agenda Citas sin Límites</h4>
            <p class="text-slate-300">Organiza todas las citas que quieras con total libertad</p>
          </div>
        </div>

        <div class="flex items-start gap-3">
          <div class="w-8 h-8 bg-green-500/20 rounded-full flex items-center justify-center flex-shrink-0 mt-1">
            <i class="fas fa-check text-green-400"></i>
          </div>
          <div>
            <h4 class="font-bold text-lg">Protección Económica</h4>
            <p class="text-slate-300">Si tu cita no se presenta, recuperas tu inversión</p>
          </div>
        </div>

        <div class="flex items-start gap-3">
          <div class="w-8 h-8 bg-green-500/20 rounded-full flex items-center justify-center flex-shrink-0 mt-1">
            <i class="fas fa-check text-green-400"></i>
          </div>
          <div>
            <h4 class="font-bold text-lg">Sistema de Verificación</h4>
            <p class="text-slate-300">Confirmación de asistencia en tiempo real</p>
          </div>
        </div>

        <div class="flex items-start gap-3">
          <div class="w-8 h-8 bg-green-500/20 rounded-full flex items-center justify-center flex-shrink-0 mt-1">
            <i class="fas fa-check text-green-400"></i>
          </div>
          <div>
            <h4 class="font-bold text-lg">Reputación Protegida</h4>
            <p class="text-slate-300">Los plantones afectan negativamente la reputación del otro usuario</p>
          </div>
        </div>

        <div class="flex items-start gap-3">
          <div class="w-8 h-8 bg-green-500/20 rounded-full flex items-center justify-center flex-shrink-0 mt-1">
            <i class="fas fa-check text-green-400"></i>
          </div>
          <div>
            <h4 class="font-bold text-lg">Válido Para Siempre</h4>
            <p class="text-slate-300">Pago único sin renovaciones ni cargos adicionales</p>
          </div>
        </div>

        <div class="flex items-start gap-3">
          <div class="w-8 h-8 bg-green-500/20 rounded-full flex items-center justify-center flex-shrink-0 mt-1">
            <i class="fas fa-check text-green-400"></i>
          </div>
          <div>
            <h4 class="font-bold text-lg">Soporte Dedicado</h4>
            <p class="text-slate-300">Asistencia prioritaria para cualquier incidencia</p>
          </div>
        </div>
      </div>

      <!-- How It Works -->
      <div class="glass rounded-xl p-6 mb-6">
        <h4 class="font-bold text-xl mb-4 text-center">
          <i class="fas fa-info-circle text-blue-400 mr-2"></i>
          ¿Cómo Funciona?
        </h4>
        <ol class="space-y-3 text-slate-300">
          <li class="flex gap-3">
            <span class="font-bold text-white">1.</span>
            <span>Agenda una cita con tu match dentro de la plataforma</span>
          </li>
          <li class="flex gap-3">
            <span class="font-bold text-white">2.</span>
            <span>Ambos confirman asistencia 24h antes de la cita</span>
          </li>
          <li class="flex gap-3">
            <span class="font-bold text-white">3.</span>
            <span>Verifican su presencia al llegar al lugar de la cita</span>
          </li>
          <li class="flex gap-3">
            <span class="font-bold text-white">4.</span>
            <span>Si tu cita no llega, su reputación baja y recibes compensación</span>
          </li>
        </ol>
      </div>

      <!-- PayPal Button Container -->
      <div id="paypal-button-container" class="mb-4"></div>

      <!-- Security Notice -->
      <div class="glass rounded-xl p-4 text-center text-sm text-slate-300">
        <i class="fas fa-lock mr-2"></i>
        Pago seguro procesado por PayPal. Pago único sin renovaciones automáticas.
      </div>
    </div>

    <!-- Important Notice -->
    <div class="glass-strong rounded-2xl p-6 mb-8 border-2 border-yellow-500/50 fade-in">
      <div class="flex items-start gap-4">
        <div class="w-12 h-12 bg-yellow-500/20 rounded-full flex items-center justify-center flex-shrink-0">
          <i class="fas fa-exclamation-triangle text-yellow-400 text-xl"></i>
        </div>
        <div>
          <h4 class="font-bold text-xl mb-2 text-yellow-400">Requisito Importante</h4>
          <p class="text-slate-200">Para agendar citas necesitas tanto la <strong>membresía premium</strong> (€29.99/mes) como el <strong>seguro anti-plantón</strong> (€120 pago único).</p>
          <p class="text-slate-300 mt-2">Si aún no tienes la membresía premium, puedes contratarla <a href="/webapp/suscripcion.html" class="text-yellow-400 hover:text-yellow-300 underline">aquí</a>.</p>
        </div>
      </div>
    </div>

    <!-- FAQ Section -->
    <div class="glass-strong rounded-2xl p-8 fade-in">
      <h3 class="text-2xl font-bold mb-6 text-center">Preguntas Frecuentes</h3>

      <div class="space-y-4">
        <details class="glass rounded-xl p-4 cursor-pointer">
          <summary class="font-bold text-lg">¿Por qué 120€?</summary>
          <p class="mt-3 text-slate-300">El seguro cubre los costos operativos del sistema de verificación, compensaciones por plantones y mantiene un compromiso serio de ambas partes. Es un pago único válido para siempre.</p>
        </details>

        <details class="glass rounded-xl p-4 cursor-pointer">
          <summary class="font-bold text-lg">¿Qué pasa si me plantan?</summary>
          <p class="mt-3 text-slate-300">Si tu cita no se presenta y no verifica su asistencia, su reputación bajará significativamente y podrías recibir compensación según las políticas de la plataforma. Tu seguro te protege.</p>
        </details>

        <details class="glass rounded-xl p-4 cursor-pointer">
          <summary class="font-bold text-lg">¿El seguro caduca?</summary>
          <p class="mt-3 text-slate-300">No, el seguro es válido para siempre una vez pagado. Es un pago único sin renovaciones ni cargos adicionales.</p>
        </details>

        <details class="glass rounded-xl p-4 cursor-pointer">
          <summary class="font-bold text-lg">¿Puedo pedir reembolso?</summary>
          <p class="mt-3 text-slate-300">Debido a la naturaleza del servicio y la activación inmediata del seguro, no ofrecemos reembolsos una vez completado el pago.</p>
        </details>

        <details class="glass rounded-xl p-4 cursor-pointer">
          <summary class="font-bold text-lg">¿Es seguro el pago?</summary>
          <p class="mt-3 text-slate-300">Absolutamente. Todos los pagos son procesados por PayPal, uno de los sistemas de pago más seguros del mundo. No almacenamos tu información de pago.</p>
        </details>

        <details class="glass rounded-xl p-4 cursor-pointer">
          <summary class="font-bold text-lg">¿También necesito la membresía?</summary>
          <p class="mt-3 text-slate-300">Sí, para agendar citas necesitas tanto la membresía premium (€29.99/mes) para enviar solicitudes y chatear, como el seguro anti-plantón (€120) para confirmar las citas.</p>
        </details>
      </div>
    </div>

  </div>

  <!-- Error Fixes -->
  <script src="/webapp/js/error-fixes.js"></script>

  <!-- Firebase SDK -->
  <script type="module">
    // Import App Check FIRST (must be before firebase-config.js)
    // TEMP DISABLED: import './js/firebase-appcheck.js';

    // Then import Firebase services
    import { auth, db } from './js/firebase-config.js';
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { doc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { showToast } from './js/utils.js';
    import { loadTheme } from './js/theme.js';

    let currentUser = null;

    // Check authentication
    onAuthStateChanged(auth, (user) => {
      if (user) {
        currentUser = user;
        document.getElementById('loadingOverlay').classList.add('hidden');
        initPayPalButton();
      } else {
        // Redirect to login if not authenticated
        window.location.href = '/login.html';
      }
    });

    // Initialize PayPal Button
    function initPayPalButton() {
      paypal.Buttons({
        style: {
          shape: 'rect',
          color: 'gold',
          layout: 'vertical',
          label: 'paypal',
          height: 50
        },

        createOrder: function(data, actions) {
          return actions.order.create({
            purchase_units: [{
              description: 'Seguro Anti-Plantón TuCitaSegura',
              amount: {
                currency_code: 'EUR',
                value: '120.00'
              },
              custom_id: currentUser.uid // Vincula el pago al usuario
            }]
          });
        },

        onApprove: async function(data, actions) {
          // Mostrar overlay de carga
          document.getElementById('loadingOverlay').classList.remove('hidden');

          try {
            // Capturar el pago
            const details = await actions.order.capture();
            console.log('Payment captured:', details);

            // Actualizar Firestore con los datos del seguro
            const userRef = doc(db, 'users', currentUser.uid);

            await updateDoc(userRef, {
              hasAntiGhostingInsurance: true,
              insurancePaymentId: data.orderID,
              insurancePurchaseDate: serverTimestamp(),
              insuranceAmount: 120,
              updatedAt: serverTimestamp()
            });

            console.log('Firestore updated successfully');

            // Ocultar overlay de carga
            document.getElementById('loadingOverlay').classList.add('hidden');

            // Mostrar modal de éxito
            document.getElementById('successModal').classList.remove('hidden');

          } catch (error) {
            console.error('Error updating Firestore:', error);
            document.getElementById('loadingOverlay').classList.add('hidden');
            showError('Error al activar tu seguro. Por favor contacta soporte con tu ID de transacción: ' + data.orderID);
          }
        },

        onError: function(err) {
          console.error('PayPal error:', err);
          document.getElementById('loadingOverlay').classList.add('hidden');
          showError('Hubo un error al procesar el pago. Por favor intenta nuevamente.');
        },

        onCancel: function(data) {
          console.log('Payment cancelled:', data);
          document.getElementById('loadingOverlay').classList.add('hidden');
          showError('Cancelaste el proceso de pago. Tu seguro no fue activado.');
        }

      }).render('#paypal-button-container');
    }

    // Show error modal
    function showError(message) {
      document.getElementById('errorMessage').textContent = message;
      document.getElementById('errorModal').classList.remove('hidden');
    }

    // Close error modal
    window.closeErrorModal = function() {
      document.getElementById('errorModal').classList.add('hidden');
    };

    // Redirect to search page
    window.redirectToSearch = function() {
      window.location.href = '/webapp/buscar-usuarios.html';
    };

  </script>

</body>
</html>
