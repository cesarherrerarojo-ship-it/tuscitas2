<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat - TuCitaSegura</title>

  <!-- Tailwind CSS -->
  <link rel="stylesheet" href="./css/output.css">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
      height: 100vh;
      overflow: hidden;
    }

    .glass {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .glass-strong {
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .messages-container {
      height: calc(100vh - 220px);
      overflow-y: auto;
      scroll-behavior: smooth;
    }

    .messages-container::-webkit-scrollbar {
      width: 8px;
    }

    .messages-container::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
    }

    .messages-container::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.3);
      border-radius: 10px;
    }

    .message-sent {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      margin-left: auto;
    }

    .message-received {
      background: rgba(255, 255, 255, 0.2);
    }

    .typing-indicator span {
      animation: blink 1.4s infinite both;
    }

    .typing-indicator span:nth-child(2) {
      animation-delay: 0.2s;
    }

    .typing-indicator span:nth-child(3) {
      animation-delay: 0.4s;
    }

    @keyframes blink {
      0%, 80%, 100% {
        opacity: 0;
      }
      40% {
        opacity: 1;
      }
    }

    /* Calendar styles */
    .calendar-day {
      transition: all 0.2s;
    }

    .calendar-day:hover:not(.disabled) {
      transform: scale(1.1);
      background: rgba(255, 255, 255, 0.3);
    }

    .calendar-day.selected {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
  </style>
</head>
<body class="text-white">

  <!-- Header -->
  <nav class="glass-strong border-b border-white/20">
    <div class="container mx-auto px-4 py-3">
      <div class="flex items-center justify-between">
        <!-- User Info -->
        <div class="flex items-center gap-3">
          <a href="/webapp/conversaciones.html" class="text-white/80 hover:text-white transition">
            <i class="fas fa-arrow-left text-xl"></i>
          </a>
          <div class="relative">
            <div id="otherUserAvatar" class="w-12 h-12 bg-gradient-to-r from-purple-500 to-pink-500 rounded-full flex items-center justify-center font-bold text-lg">
              U
            </div>
            <div id="onlineIndicator" class="hidden absolute bottom-0 right-0 w-3 h-3 bg-green-500 border-2 border-slate-900 rounded-full"></div>
          </div>
          <div>
            <div class="flex items-center gap-2">
              <h1 id="otherUserName" class="text-lg font-bold">Usuario</h1>
              <i id="verifiedBadge" class="hidden fas fa-circle-check text-blue-400 text-sm"></i>
            </div>
            <div class="flex items-center gap-2 text-sm">
              <span id="distanceBadge" class="text-slate-300">
                <i class="fas fa-location-dot"></i> <span id="distanceValue">-</span> km
              </span>
              <span id="reputationBadge" class="hidden px-2 py-0.5 text-xs rounded-full font-bold"></span>
              <span id="availabilityBadge" class="hidden w-2 h-2 rounded-full" title="Disponibilidad"></span>
            </div>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="flex items-center gap-2">
          <button id="videoCallBtn" onclick="startVideoCall()" class="glass hover:glass-strong p-3 rounded-xl transition bg-gradient-to-r from-blue-500/20 to-purple-500/20" title="Iniciar video llamada">
            <i class="fas fa-video text-lg"></i>
          </button>
          <button onclick="openDateProposal()" class="glass hover:glass-strong p-3 rounded-xl transition" title="Proponer cita">
            <i class="fas fa-calendar-plus text-lg"></i>
          </button>
          <button onclick="showOptionsMenu()" class="glass hover:glass-strong p-3 rounded-xl transition">
            <i class="fas fa-ellipsis-vertical text-lg"></i>
          </button>
        </div>
      </div>
    </div>
  </nav>

  <!-- Messages Container -->
  <div class="container mx-auto px-4">
    <div id="messagesContainer" class="messages-container py-4 space-y-3">
      <!-- Loading State -->
      <div id="loadingMessages" class="text-center py-8">
        <div class="inline-block animate-spin rounded-full h-8 w-8 border-4 border-white border-t-transparent"></div>
      </div>

      <!-- Messages will be dynamically loaded here -->
    </div>

    <!-- Typing Indicator -->
    <div id="typingIndicator" class="hidden py-2">
      <div class="flex items-center gap-2 text-slate-300 text-sm">
        <div class="typing-indicator flex gap-1">
          <span class="w-2 h-2 bg-white rounded-full"></span>
          <span class="w-2 h-2 bg-white rounded-full"></span>
          <span class="w-2 h-2 bg-white rounded-full"></span>
        </div>
        <span>escribiendo...</span>
      </div>
    </div>
  </div>

  <!-- Message Input -->
  <div class="fixed bottom-0 left-0 right-0 glass-strong border-t border-white/20 p-4">
    <div class="container mx-auto">
      <!-- Payment Warning -->
      <div id="paymentWarningChat" class="hidden mb-3 glass rounded-xl p-3 border border-yellow-500/50">
        <div class="flex items-center gap-3">
          <i class="fas fa-lock text-yellow-400"></i>
          <p class="text-sm flex-1">Necesitas una membres√≠a activa para enviar mensajes</p>
          <a href="/webapp/suscripcion.html" class="bg-yellow-500 hover:bg-yellow-600 px-4 py-2 rounded-lg text-sm font-bold transition">
            Activar
          </a>
        </div>
      </div>

      <div class="flex items-end gap-3">
        <div class="flex-1">
          <textarea
            id="messageInput"
            rows="1"
            placeholder="Escribe un mensaje..."
            class="w-full px-4 py-3 rounded-xl glass text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-purple-500 resize-none"
            maxlength="1000"
          ></textarea>
        </div>
        <button
          id="sendButton"
          onclick="sendMessage()"
          class="bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 disabled:from-gray-500 disabled:to-gray-600 disabled:cursor-not-allowed p-4 rounded-xl transition"
        >
          <i class="fas fa-paper-plane text-lg"></i>
        </button>
      </div>
    </div>
  </div>

  <!-- Options Menu -->
  <div id="optionsMenu" class="hidden fixed inset-0 bg-black/80 flex items-end justify-center z-50 p-4" onclick="closeOptionsMenu()">
    <div class="glass-strong rounded-2xl w-full max-w-md p-6" onclick="event.stopPropagation()">
      <h3 class="text-xl font-bold mb-4">Opciones</h3>
      <div class="space-y-2">
        <button onclick="hideConversation()" class="w-full glass hover:glass-strong p-4 rounded-xl text-left flex items-center gap-3 transition">
          <i class="fas fa-eye-slash text-yellow-400"></i>
          <div>
            <div class="font-semibold">Ocultar conversaci√≥n</div>
            <div class="text-sm text-slate-300">No aparecer√° en tu lista</div>
          </div>
        </button>
        <button onclick="reportUser()" class="w-full glass hover:glass-strong p-4 rounded-xl text-left flex items-center gap-3 transition text-orange-400">
          <i class="fas fa-flag"></i>
          <div>
            <div class="font-semibold">Reportar usuario</div>
            <div class="text-sm text-slate-300">Notificar comportamiento inapropiado</div>
          </div>
        </button>
        <button onclick="blockUser()" class="w-full glass hover:glass-strong p-4 rounded-xl text-left flex items-center gap-3 transition text-red-400">
          <i class="fas fa-ban"></i>
          <div>
            <div class="font-semibold">Bloquear usuario</div>
            <div class="text-sm text-slate-300">No podr√° contactarte</div>
          </div>
        </button>
      </div>
      <button onclick="closeOptionsMenu()" class="w-full mt-4 glass hover:glass-strong p-3 rounded-xl font-semibold transition">
        Cancelar
      </button>
    </div>
  </div>

  <!-- Date Proposal Modal -->
  <div id="dateProposalModal" class="hidden fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4">
    <div class="glass-strong rounded-2xl max-w-2xl w-full p-8 max-h-[90vh] overflow-y-auto">
      <div class="flex items-center justify-between mb-6">
        <h3 class="text-2xl font-bold">
          <i class="fas fa-calendar-heart text-pink-400 mr-2"></i>
          Proponer Cita
        </h3>
        <button onclick="closeDateProposal()" class="text-white/80 hover:text-white text-2xl">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <!-- Insurance Check -->
      <div id="insuranceWarning" class="hidden mb-6 glass rounded-xl p-4 border-2 border-yellow-500/50">
        <div class="flex items-start gap-3">
          <i class="fas fa-shield-exclamation text-yellow-400 text-xl"></i>
          <div>
            <h4 class="font-bold mb-1">Seguro Anti-Plant√≥n Requerido</h4>
            <p class="text-sm text-slate-300 mb-3">Necesitas el seguro de ‚Ç¨120 para proponer citas</p>
            <a href="/webapp/seguro.html" class="inline-block bg-yellow-500 hover:bg-yellow-600 px-4 py-2 rounded-lg text-sm font-bold transition">
              Contratar Seguro
            </a>
          </div>
        </div>
      </div>

      <!-- Calendar -->
      <div id="calendarContainer" class="mb-6">
        <div class="flex items-center justify-between mb-4">
          <button onclick="previousMonth()" class="glass hover:glass-strong p-2 rounded-lg transition">
            <i class="fas fa-chevron-left"></i>
          </button>
          <h4 id="calendarMonth" class="text-xl font-bold">Enero 2024</h4>
          <button onclick="nextMonth()" class="glass hover:glass-strong p-2 rounded-lg transition">
            <i class="fas fa-chevron-right"></i>
          </button>
        </div>

        <!-- Days of week -->
        <div class="grid grid-cols-7 gap-2 mb-2">
          <div class="text-center text-sm text-slate-400 font-semibold">L</div>
          <div class="text-center text-sm text-slate-400 font-semibold">M</div>
          <div class="text-center text-sm text-slate-400 font-semibold">X</div>
          <div class="text-center text-sm text-slate-400 font-semibold">J</div>
          <div class="text-center text-sm text-slate-400 font-semibold">V</div>
          <div class="text-center text-sm text-slate-400 font-semibold">S</div>
          <div class="text-center text-sm text-slate-400 font-semibold">D</div>
        </div>

        <!-- Calendar days -->
        <div id="calendarDays" class="grid grid-cols-7 gap-2">
          <!-- Days will be dynamically generated -->
        </div>
      </div>

      <!-- Time Selection -->
      <div class="mb-6">
        <label class="block text-sm font-semibold mb-2">Hora de la cita</label>
        <div class="grid grid-cols-4 gap-2">
          <button onclick="selectTime('10:00')" class="time-slot glass hover:glass-strong p-3 rounded-lg transition">10:00</button>
          <button onclick="selectTime('12:00')" class="time-slot glass hover:glass-strong p-3 rounded-lg transition">12:00</button>
          <button onclick="selectTime('14:00')" class="time-slot glass hover:glass-strong p-3 rounded-lg transition">14:00</button>
          <button onclick="selectTime('16:00')" class="time-slot glass hover:glass-strong p-3 rounded-lg transition">16:00</button>
          <button onclick="selectTime('18:00')" class="time-slot glass hover:glass-strong p-3 rounded-lg transition">18:00</button>
          <button onclick="selectTime('20:00')" class="time-slot glass hover:glass-strong p-3 rounded-lg transition">20:00</button>
          <button onclick="selectTime('21:00')" class="time-slot glass hover:glass-strong p-3 rounded-lg transition">21:00</button>
          <button onclick="selectTime('22:00')" class="time-slot glass hover:glass-strong p-3 rounded-lg transition">22:00</button>
        </div>
      </div>

      <!-- Place Input -->
      <div class="mb-6">
        <label class="block text-sm font-semibold mb-2">Lugar de la cita</label>
        <input
          type="text"
          id="datePlace"
          placeholder="Ej: Caf√© Central, Calle Mayor 10"
          class="w-full px-4 py-3 rounded-xl glass text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-purple-500"
        >
      </div>

      <!-- Message -->
      <div class="mb-6">
        <label class="block text-sm font-semibold mb-2">Mensaje (opcional)</label>
        <textarea
          id="dateMessage"
          rows="3"
          placeholder="¬øQuieres a√±adir algo?"
          class="w-full px-4 py-3 rounded-xl glass text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-purple-500 resize-none"
        ></textarea>
      </div>

      <!-- Selected Date Summary -->
      <div id="dateSummary" class="hidden mb-6 glass rounded-xl p-4">
        <h4 class="font-bold mb-2">Resumen de la cita:</h4>
        <div class="space-y-1 text-sm text-slate-300">
          <p><i class="fas fa-calendar text-purple-400 w-5"></i> <span id="summaryDate"></span></p>
          <p><i class="fas fa-clock text-purple-400 w-5"></i> <span id="summaryTime"></span></p>
          <p><i class="fas fa-map-marker-alt text-purple-400 w-5"></i> <span id="summaryPlace"></span></p>
        </div>
      </div>

      <!-- Submit Button -->
      <button
        id="submitDateProposal"
        onclick="submitDateProposal()"
        disabled
        class="w-full bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 disabled:from-gray-500 disabled:to-gray-600 disabled:cursor-not-allowed text-white font-bold py-4 px-6 rounded-xl transition"
      >
        Enviar Propuesta de Cita
      </button>
    </div>
  </div>

  <!-- Block Confirmation Modal -->
  <div id="blockModal" class="hidden fixed inset-0 bg-black/80 flex items-center justify-center z-[100] p-4">
    <div class="glass-strong rounded-2xl max-w-md w-full p-8">
      <div class="w-20 h-20 bg-red-500/20 rounded-full flex items-center justify-center mx-auto mb-6">
        <i class="fas fa-ban text-4xl text-red-400"></i>
      </div>
      <h3 class="text-2xl font-bold mb-4 text-center">¬øBloquear Usuario?</h3>
      <p class="text-slate-300 mb-6 text-center">
        <span id="blockUserName"></span> no podr√° enviarte m√°s mensajes ni verte en b√∫squedas.
      </p>
      <div class="flex gap-3">
        <button onclick="closeBlockModal()" class="flex-1 glass hover:glass-strong font-semibold py-3 px-6 rounded-xl transition">
          Cancelar
        </button>
        <button onclick="confirmBlock()" class="flex-1 bg-red-500 hover:bg-red-600 font-bold py-3 px-6 rounded-xl transition">
          Bloquear
        </button>
      </div>
    </div>
  </div>

  <!-- Error Fixes -->
  <script src="/webapp/js/error-fixes.js"></script>

  <!-- Firebase SDK -->
  <script type="module">
    // Import App Check FIRST (must be before firebase-config.js)
    // TEMP DISABLED (throttling): import './js/firebase-appcheck.js';

    // Then import Firebase services
    import { auth, db } from './js/firebase-config.js';
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      collection,
      query,
      orderBy,
      onSnapshot,
      doc,
      getDoc,
      addDoc,
      updateDoc,
      serverTimestamp,
      arrayUnion,
      where,
      getDocs,
      setDoc
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { showToast, calculateDistance } from './js/utils.js';
    import { loadTheme } from './js/theme.js';

    // Get URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const conversationId = urlParams.get('conversationId');
    const otherUserId = urlParams.get('userId');

    let currentUser = null;
    let currentUserData = null;
    let otherUserData = null;
    let messages = [];
    let selectedDate = null;
    let selectedTime = null;
    let currentMonth = new Date();

    // Redirect if missing params
    if (!conversationId || !otherUserId) {
      window.location.href = '/webapp/conversaciones.html';
    }

    // Auth State
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        currentUser = user;
        await loadUserData();
        loadMessages();
      } else {
        window.location.href = '/login.html';
      }
    });

    // Load user data
    async function loadUserData() {
      try {
        // Load current user
        const currentUserDoc = await getDoc(doc(db, 'users', currentUser.uid));
        if (currentUserDoc.exists()) {
          currentUserData = { id: currentUserDoc.id, ...currentUserDoc.data() };

          // Load user theme
          loadTheme(currentUserData);
        }

        // Load other user
        const otherUserDoc = await getDoc(doc(db, 'users', otherUserId));
        if (otherUserDoc.exists()) {
          otherUserData = { id: otherUserDoc.id, ...otherUserDoc.data() };
          updateUserHeader();
          checkPaymentStatus();
        } else {
          showToast('Usuario no encontrado', 'error');
          setTimeout(() => window.location.href = '/webapp/conversaciones.html', 2000);
        }
      } catch (error) {
        console.error('Error loading user data:', error);
        showToast('Error al cargar datos', 'error');
      }
    }

    // Update user header
    function updateUserHeader() {
      const alias = otherUserData.alias || 'Usuario';
      document.getElementById('otherUserName').textContent = alias;
      document.getElementById('otherUserAvatar').textContent = alias.charAt(0).toUpperCase();

      // Online status
      if (otherUserData.isOnline) {
        document.getElementById('onlineIndicator').classList.remove('hidden');
      }

      // Verified badge
      if (otherUserData.emailVerified) {
        document.getElementById('verifiedBadge').classList.remove('hidden');
      }

      // Distance
      if (currentUserData.location && otherUserData.location) {
        const distance = calculateDistance(
          currentUserData.location.lat,
          currentUserData.location.lng,
          otherUserData.location.lat,
          otherUserData.location.lng
        );
        document.getElementById('distanceValue').textContent = distance.toFixed(1);
      }

      // Reputation (men)
      if (otherUserData.gender === 'masculino' && otherUserData.reputation) {
        const badge = document.getElementById('reputationBadge');
        const repColors = {
          'BRONCE': 'bg-gradient-to-r from-orange-700 to-orange-900',
          'PLATA': 'bg-gradient-to-r from-gray-400 to-gray-600',
          'ORO': 'bg-gradient-to-r from-yellow-400 to-yellow-600',
          'PLATINO': 'bg-gradient-to-r from-cyan-400 to-blue-500'
        };
        badge.className = `px-2 py-0.5 text-xs rounded-full font-bold ${repColors[otherUserData.reputation]}`;
        badge.textContent = otherUserData.reputation;
        badge.classList.remove('hidden');
      }

      // Availability (women)
      if (otherUserData.gender === 'femenino' && otherUserData.availability) {
        const badge = document.getElementById('availabilityBadge');
        const availColors = {
          'verde': 'bg-green-500',
          'amarillo': 'bg-yellow-500',
          'rojo': 'bg-red-500'
        };
        badge.className = `w-2 h-2 rounded-full ${availColors[otherUserData.availability]}`;
        badge.title = `Disponibilidad: ${otherUserData.availability}`;
        badge.classList.remove('hidden');
      }
    }

    // Check payment status
    function checkPaymentStatus() {
      const userMustPay = currentUserData.gender === 'masculino';
      const hasSubscription = currentUserData.hasActiveSubscription;

      if (userMustPay && !hasSubscription) {
        document.getElementById('paymentWarningChat').classList.remove('hidden');
        document.getElementById('sendButton').disabled = true;
        document.getElementById('messageInput').disabled = true;
      }
    }

    // Load messages
    function loadMessages() {
      const messagesRef = collection(db, 'conversations', conversationId, 'messages');
      const q = query(messagesRef, orderBy('timestamp', 'asc'));

      onSnapshot(q, (snapshot) => {
        document.getElementById('loadingMessages').classList.add('hidden');

        messages = [];
        snapshot.forEach((doc) => {
          messages.push({ id: doc.id, ...doc.data() });
        });

        renderMessages();
        scrollToBottom();
        markAsRead();
      }, (error) => {
        console.error('Error loading messages:', error);
        showToast('Error al cargar mensajes', 'error');
      });
    }

    // Render messages
    function renderMessages() {
      const container = document.getElementById('messagesContainer');

      if (messages.length === 0) {
        container.innerHTML = `
          <div class="text-center py-8 text-slate-300">
            <i class="fas fa-comment-dots text-4xl mb-3 opacity-50"></i>
            <p>No hay mensajes a√∫n. ¬°Empieza la conversaci√≥n!</p>
          </div>
        `;
        return;
      }

      container.innerHTML = messages.map(msg => {
        const isSent = msg.senderId === currentUser.uid;
        const timeStr = msg.timestamp ? new Date(msg.timestamp.toDate()).toLocaleTimeString('es-ES', {
          hour: '2-digit',
          minute: '2-digit'
        }) : '';

        // Check if it's a date proposal
        if (msg.type === 'date_proposal') {
          return `
            <div class="flex ${isSent ? 'justify-end' : 'justify-start'}">
              <div class="max-w-[80%] glass-strong rounded-2xl p-4">
                <div class="flex items-center gap-2 mb-3 text-pink-400">
                  <i class="fas fa-calendar-heart"></i>
                  <span class="font-bold">Propuesta de Cita</span>
                </div>
                <div class="space-y-2 text-sm">
                  <p><i class="fas fa-calendar text-purple-400 w-5"></i> ${msg.date}</p>
                  <p><i class="fas fa-clock text-purple-400 w-5"></i> ${msg.time}</p>
                  <p><i class="fas fa-map-marker-alt text-purple-400 w-5"></i> ${msg.place}</p>
                  ${msg.message ? `<p class="mt-3 text-slate-300">"${msg.message}"</p>` : ''}
                </div>
                <div class="flex gap-2 mt-4">
                  ${!isSent && msg.status === 'pending' ? `
                    <button onclick="acceptDate('${msg.id}')" class="flex-1 bg-green-500 hover:bg-green-600 py-2 rounded-lg text-sm font-bold transition">
                      Aceptar
                    </button>
                    <button onclick="rejectDate('${msg.id}')" class="flex-1 bg-red-500 hover:bg-red-600 py-2 rounded-lg text-sm font-bold transition">
                      Rechazar
                    </button>
                  ` : ''}
                  ${msg.status === 'accepted' ? '<span class="text-green-400 text-sm"><i class="fas fa-check-circle"></i> Aceptada</span>' : ''}
                  ${msg.status === 'rejected' ? '<span class="text-red-400 text-sm"><i class="fas fa-times-circle"></i> Rechazada</span>' : ''}
                </div>
                <p class="text-xs text-slate-400 mt-2 text-right">${timeStr}</p>
              </div>
            </div>
          `;
        }

        // Regular message
        return `
          <div class="flex ${isSent ? 'justify-end' : 'justify-start'}">
            <div class="max-w-[70%] ${isSent ? 'message-sent' : 'message-received'} rounded-2xl px-4 py-3">
              <p class="break-words">${escapeHtml(msg.text)}</p>
              <p class="text-xs text-white/60 mt-1 text-right">${timeStr}</p>
            </div>
          </div>
        `;
      }).join('');
    }

    // Escape HTML
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Scroll to bottom
    function scrollToBottom() {
      const container = document.getElementById('messagesContainer');
      setTimeout(() => {
        container.scrollTop = container.scrollHeight;
      }, 100);
    }

    // Mark messages as read
    async function markAsRead() {
      try {
        const conversationRef = doc(db, 'conversations', conversationId);
        await updateDoc(conversationRef, {
          [`participantsData.${currentUser.uid}.unreadCount`]: 0
        });
      } catch (error) {
        console.error('Error marking as read:', error);
      }
    }

    // Send message
    window.sendMessage = async function() {
      const input = document.getElementById('messageInput');
      const text = input.value.trim();

      if (!text) return;

      // Check payment - CRITICAL VALIDATION
      const userMustPay = currentUserData.gender === 'masculino';
      if (userMustPay && !currentUserData.hasActiveSubscription) {
        showToast('‚ö†Ô∏è Membres√≠a requerida para enviar mensajes', 'error');
        // Show modal and redirect
        if (confirm('Necesitas una membres√≠a activa (‚Ç¨29.99/mes) para enviar mensajes.\n\n¬øDeseas activar tu membres√≠a ahora?')) {
          window.location.href = '/webapp/suscripcion.html';
        }
        return;
      }

      try {
        // Add message
        const messagesRef = collection(db, 'conversations', conversationId, 'messages');
        await addDoc(messagesRef, {
          senderId: currentUser.uid,
          text: text,
          timestamp: serverTimestamp(),
          read: false
        });

        // Update conversation
        const conversationRef = doc(db, 'conversations', conversationId);
        await updateDoc(conversationRef, {
          lastMessage: text,
          lastMessageTime: serverTimestamp(),
          lastMessageSenderId: currentUser.uid,
          [`participantsData.${otherUserId}.unreadCount`]: (otherUserData.unreadCount || 0) + 1
        });

        // Clear input
        input.value = '';
        input.style.height = 'auto';
      } catch (error) {
        console.error('Error sending message:', error);
        showToast('Error al enviar mensaje', 'error');
      }
    };

    // Auto-resize textarea
    document.getElementById('messageInput').addEventListener('input', function() {
      this.style.height = 'auto';
      this.style.height = (this.scrollHeight) + 'px';
    });

    // Send on Enter (Shift+Enter for new line)
    document.getElementById('messageInput').addEventListener('keydown', function(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    // Options menu
    window.showOptionsMenu = function() {
      document.getElementById('optionsMenu').classList.remove('hidden');
    };

    window.closeOptionsMenu = function() {
      document.getElementById('optionsMenu').classList.add('hidden');
    };

    // Report user
    window.reportUser = function() {
      closeOptionsMenu();
      window.location.href = `/webapp/reportes.html?type=user&userId=${otherUserId}`;
    };

    // Hide conversation
    window.hideConversation = async function() {
      try {
        const userRef = doc(db, 'users', currentUser.uid);
        await updateDoc(userRef, {
          hiddenConversations: arrayUnion(conversationId)
        });

        showToast('Conversaci√≥n ocultada', 'success');
        setTimeout(() => window.location.href = '/webapp/conversaciones.html', 1000);
      } catch (error) {
        console.error('Error hiding conversation:', error);
        showToast('Error al ocultar conversaci√≥n', 'error');
      }
    };

    // Block user
    window.blockUser = function() {
      document.getElementById('blockUserName').textContent = otherUserData.alias || 'Este usuario';
      document.getElementById('blockModal').classList.remove('hidden');
      closeOptionsMenu();
    };

    window.closeBlockModal = function() {
      document.getElementById('blockModal').classList.add('hidden');
    };

    window.confirmBlock = async function() {
      try {
        const userRef = doc(db, 'users', currentUser.uid);
        await updateDoc(userRef, {
          blockedUsers: arrayUnion(otherUserId),
          hiddenConversations: arrayUnion(conversationId)
        });

        closeBlockModal();
        showToast('Usuario bloqueado', 'success');
        setTimeout(() => window.location.href = '/webapp/conversaciones.html', 1000);
      } catch (error) {
        console.error('Error blocking user:', error);
        showToast('Error al bloquear usuario', 'error');
      }
    };

    // Video call
    window.startVideoCall = function() {
      // Check membership - CRITICAL VALIDATION
      const userMustPay = currentUserData.gender === 'masculino';
      if (userMustPay && !currentUserData.hasActiveSubscription) {
        showToast('üí≥ Membres√≠a Premium requerida para video llamadas', 'error');
        if (confirm('Para realizar video llamadas necesitas una Membres√≠a Premium (‚Ç¨29.99/mes).\n\n¬øDeseas suscribirte ahora?')) {
          window.location.href = '/webapp/suscripcion.html';
        }
        return;
      }

      // Verificar soporte del navegador
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        showToast('Tu navegador no soporta video llamadas. Usa Chrome, Firefox o Edge.', 'error');
        return;
      }

      // Redirigir a p√°gina de video chat
      window.location.href = `/webapp/video-chat.html?conversationId=${conversationId}&remoteUserId=${otherUserId}&action=call`;
    };

    // Date proposal
    window.openDateProposal = function() {
      // Check insurance - CRITICAL VALIDATION
      const userMustPay = currentUserData.gender === 'masculino';
      if (userMustPay && !currentUserData.hasAntiGhostingInsurance) {
        showToast('üõ°Ô∏è Seguro Anti-Plant√≥n requerido para proponer citas', 'error');
        if (confirm('Para proponer y agendar citas necesitas contratar el Seguro Anti-Plant√≥n (‚Ç¨120 pago √∫nico).\n\nEste seguro te protege en caso de plantones y es v√°lido de por vida.\n\n¬øDeseas contratar el seguro ahora?')) {
          window.location.href = '/webapp/seguro.html';
        }
        return;
      }

      document.getElementById('insuranceWarning').classList.add('hidden');
      document.getElementById('dateProposalModal').classList.remove('hidden');
      renderCalendar();
    };

    window.closeDateProposal = function() {
      document.getElementById('dateProposalModal').classList.add('hidden');
    };

    // Calendar functions
    function renderCalendar() {
      const year = currentMonth.getFullYear();
      const month = currentMonth.getMonth();

      // Update header
      const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                          'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
      document.getElementById('calendarMonth').textContent = `${monthNames[month]} ${year}`;

      // Get first day of month and number of days
      const firstDay = new Date(year, month, 1).getDay();
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      const today = new Date();

      // Create a date object for today at midnight for comparison (prevents mutation bug)
      const todayMidnight = new Date(today.getFullYear(), today.getMonth(), today.getDate());

      // Adjust firstDay (Monday = 0)
      const adjustedFirstDay = firstDay === 0 ? 6 : firstDay - 1;

      // Generate calendar days
      let calendarHTML = '';

      // Empty cells before first day
      for (let i = 0; i < adjustedFirstDay; i++) {
        calendarHTML += '<div></div>';
      }

      // Days of month
      for (let day = 1; day <= daysInMonth; day++) {
        const date = new Date(year, month, day);
        const isPast = date < todayMidnight;
        const isSelected = selectedDate && selectedDate.getDate() === day &&
                          selectedDate.getMonth() === month &&
                          selectedDate.getFullYear() === year;

        calendarHTML += `
          <button
            onclick="selectDate(${year}, ${month}, ${day})"
            class="calendar-day aspect-square rounded-lg glass flex items-center justify-center font-semibold ${isPast ? 'disabled opacity-50 cursor-not-allowed' : 'hover:bg-white/20'} ${isSelected ? 'selected' : ''}"
            ${isPast ? 'disabled' : ''}
          >
            ${day}
          </button>
        `;
      }

      document.getElementById('calendarDays').innerHTML = calendarHTML;
    }

    window.selectDate = function(year, month, day) {
      selectedDate = new Date(year, month, day);
      renderCalendar();
      updateDateSummary();
    };

    window.previousMonth = function() {
      currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() - 1, 1);
      renderCalendar();
    };

    window.nextMonth = function() {
      currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 1);
      renderCalendar();
    };

    window.selectTime = function(time) {
      selectedTime = time;

      // Update UI
      document.querySelectorAll('.time-slot').forEach(btn => {
        btn.classList.remove('selected', 'bg-gradient-to-r', 'from-purple-500', 'to-pink-500');
      });
      event.target.classList.add('selected', 'bg-gradient-to-r', 'from-purple-500', 'to-pink-500');

      updateDateSummary();
    };

    function updateDateSummary() {
      const place = document.getElementById('datePlace').value;

      if (selectedDate && selectedTime && place) {
        document.getElementById('submitDateProposal').disabled = false;
        document.getElementById('dateSummary').classList.remove('hidden');

        const dateStr = selectedDate.toLocaleDateString('es-ES', {
          weekday: 'long',
          year: 'numeric',
          month: 'long',
          day: 'numeric'
        });

        document.getElementById('summaryDate').textContent = dateStr;
        document.getElementById('summaryTime').textContent = selectedTime;
        document.getElementById('summaryPlace').textContent = place;
      } else {
        document.getElementById('submitDateProposal').disabled = true;
        document.getElementById('dateSummary').classList.add('hidden');
      }
    }

    document.getElementById('datePlace').addEventListener('input', updateDateSummary);

    window.submitDateProposal = async function() {
      // Check insurance - DOUBLE VALIDATION (should not reach here without insurance)
      const userMustPay = currentUserData.gender === 'masculino';
      if (userMustPay && !currentUserData.hasAntiGhostingInsurance) {
        showToast('üõ°Ô∏è Seguro Anti-Plant√≥n requerido (‚Ç¨120)', 'error');
        closeDateProposal();
        if (confirm('Para proponer citas necesitas el Seguro Anti-Plant√≥n.\n\n¬øDeseas contratar el seguro ahora?')) {
          window.location.href = '/webapp/seguro.html';
        }
        return;
      }

      const place = document.getElementById('datePlace').value;
      const message = document.getElementById('dateMessage').value;

      try {
        // Add date proposal message
        const messagesRef = collection(db, 'conversations', conversationId, 'messages');
        await addDoc(messagesRef, {
          senderId: currentUser.uid,
          type: 'date_proposal',
          date: selectedDate.toLocaleDateString('es-ES'),
          time: selectedTime,
          place: place,
          message: message,
          status: 'pending',
          timestamp: serverTimestamp()
        });

        // Update conversation
        const conversationRef = doc(db, 'conversations', conversationId);
        await updateDoc(conversationRef, {
          lastMessage: 'üìÖ Propuesta de cita',
          lastMessageTime: serverTimestamp(),
          lastMessageSenderId: currentUser.uid
        });

        closeDateProposal();
        showToast('Propuesta de cita enviada', 'success');

        // Reset form
        selectedDate = null;
        selectedTime = null;
        document.getElementById('datePlace').value = '';
        document.getElementById('dateMessage').value = '';
      } catch (error) {
        console.error('Error sending date proposal:', error);
        showToast('Error al enviar propuesta', 'error');
      }
    };

    // Accept/Reject date
    window.acceptDate = async function(messageId) {
      try {
        const messageRef = doc(db, 'conversations', conversationId, 'messages', messageId);
        await updateDoc(messageRef, {
          status: 'accepted'
        });
        showToast('Cita aceptada', 'success');
      } catch (error) {
        console.error('Error accepting date:', error);
        showToast('Error al aceptar cita', 'error');
      }
    };

    window.rejectDate = async function(messageId) {
      try {
        const messageRef = doc(db, 'conversations', conversationId, 'messages', messageId);
        await updateDoc(messageRef, {
          status: 'rejected'
        });
        showToast('Cita rechazada', 'info');
      } catch (error) {
        console.error('Error rejecting date:', error);
        showToast('Error al rechazar cita', 'error');
      }
    };

  </script>

</body>
</html>
