<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Verificación de Identidad - TuCitaSegura</title>

  <!-- Tailwind CSS -->
  <link rel="stylesheet" href="./css/output.css">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
      min-height: 100vh;
    }

    .glass {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .glass-strong {
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .upload-area {
      border: 2px dashed rgba(255, 255, 255, 0.3);
      transition: all 0.3s ease;
    }

    .upload-area:hover {
      border-color: rgba(255, 255, 255, 0.6);
      background: rgba(255, 255, 255, 0.05);
    }

    .upload-area.dragover {
      border-color: #667eea;
      background: rgba(102, 126, 234, 0.1);
    }

    .step {
      position: relative;
    }

    .step::after {
      content: '';
      position: absolute;
      top: 24px;
      left: 50%;
      transform: translateX(-50%);
      width: 2px;
      height: calc(100% - 48px);
      background: rgba(255, 255, 255, 0.2);
    }

    .step:last-child::after {
      display: none;
    }

    .step.completed .step-number {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    }

    .step.active .step-number {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.8; transform: scale(1.05); }
    }

    .preview-image {
      max-height: 300px;
      object-fit: contain;
    }
  </style>
</head>
<body class="text-white">

  <!-- Header -->
  <header class="glass-strong border-b border-white/20">
    <nav class="max-w-4xl mx-auto px-4 py-4 flex items-center justify-between">
      <button onclick="window.history.back()" class="hover:bg-white/10 p-2 rounded-lg transition">
        <i class="fas fa-arrow-left text-xl"></i>
      </button>
      <h1 class="text-xl font-bold">Verificación de Identidad</h1>
      <div class="w-10"></div>
    </nav>
  </header>

  <!-- Main Content -->
  <main class="max-w-4xl mx-auto px-4 py-8">

    <!-- Progress Steps -->
    <div class="glass rounded-2xl p-6 mb-8">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-2xl font-bold">
          <i class="fas fa-shield-halved mr-2 text-blue-400"></i>
          Proceso de Verificación
        </h2>
        <span id="verificationStatus" class="glass px-4 py-2 rounded-lg text-sm font-semibold">
          <i class="fas fa-clock mr-1"></i>Pendiente
        </span>
      </div>

      <!-- Steps -->
      <div class="space-y-6">
        <!-- Step 1 -->
        <div id="step1" class="step active">
          <div class="flex items-start gap-4">
            <div class="step-number flex-shrink-0 w-12 h-12 rounded-full flex items-center justify-center font-bold text-lg">
              1
            </div>
            <div class="flex-1">
              <h3 class="text-lg font-bold mb-1">Subir Documento de Identidad</h3>
              <p class="text-sm text-slate-300 mb-3">DNI, Pasaporte o Licencia de Conducir (ambas caras)</p>
              <div id="step1Status" class="hidden text-sm text-green-400">
                <i class="fas fa-check-circle mr-1"></i>Completado
              </div>
            </div>
          </div>
        </div>

        <!-- Step 2 -->
        <div id="step2" class="step">
          <div class="flex items-start gap-4">
            <div class="step-number flex-shrink-0 w-12 h-12 bg-slate-700 rounded-full flex items-center justify-center font-bold text-lg">
              2
            </div>
            <div class="flex-1">
              <h3 class="text-lg font-bold mb-1">Subir Selfie con Documento</h3>
              <p class="text-sm text-slate-300 mb-3">Foto clara de tu rostro sosteniendo el documento</p>
              <div id="step2Status" class="hidden text-sm text-green-400">
                <i class="fas fa-check-circle mr-1"></i>Completado
              </div>
            </div>
          </div>
        </div>

        <!-- Step 3 -->
        <div id="step3" class="step">
          <div class="flex items-start gap-4">
            <div class="step-number flex-shrink-0 w-12 h-12 bg-slate-700 rounded-full flex items-center justify-center font-bold text-lg">
              3
            </div>
            <div class="flex-1">
              <h3 class="text-lg font-bold mb-1">Revisión del Equipo</h3>
              <p class="text-sm text-slate-300 mb-3">Verificaremos tu identidad en 24-48 horas</p>
              <div id="step3Status" class="hidden text-sm text-green-400">
                <i class="fas fa-check-circle mr-1"></i>Verificado
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Upload Section: Documento -->
    <div id="documentSection" class="glass rounded-2xl p-8 mb-6">
      <h3 class="text-2xl font-bold mb-6">
        <i class="fas fa-id-card mr-2 text-purple-400"></i>
        1. Documento de Identidad
      </h3>

      <!-- Instrucciones -->
      <div class="bg-blue-500/20 border border-blue-400/30 rounded-xl p-4 mb-6">
        <h4 class="font-bold mb-2">
          <i class="fas fa-info-circle mr-2"></i>Instrucciones
        </h4>
        <ul class="text-sm space-y-1 text-slate-200">
          <li>✓ Foto clara y legible</li>
          <li>✓ Toda la información visible</li>
          <li>✓ Sin reflejos ni sombras</li>
          <li>✓ Formato: JPG, PNG o PDF</li>
          <li>✓ Tamaño máximo: 10 MB</li>
        </ul>
      </div>

      <!-- Upload Areas -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
        <!-- Front -->
        <div>
          <label class="block text-sm font-semibold mb-2">Cara Frontal *</label>
          <div class="upload-area rounded-xl p-8 text-center cursor-pointer"
               id="uploadFrontArea"
               onclick="document.getElementById('frontInput').click()">
            <div id="frontPreview" class="hidden">
              <img id="frontImage" class="preview-image mx-auto rounded-lg mb-3">
              <button onclick="removeFront(event)" class="glass hover:bg-red-500/50 px-4 py-2 rounded-lg text-sm">
                <i class="fas fa-trash mr-2"></i>Eliminar
              </button>
            </div>
            <div id="frontPlaceholder">
              <i class="fas fa-cloud-arrow-up text-5xl mb-3 opacity-50"></i>
              <p class="font-semibold mb-1">Click para subir</p>
              <p class="text-sm text-slate-300">o arrastra aquí</p>
            </div>
          </div>
          <input type="file" id="frontInput" class="hidden" accept="image/*,application/pdf" onchange="handleFrontUpload(event)">
        </div>

        <!-- Back -->
        <div>
          <label class="block text-sm font-semibold mb-2">Cara Posterior *</label>
          <div class="upload-area rounded-xl p-8 text-center cursor-pointer"
               id="uploadBackArea"
               onclick="document.getElementById('backInput').click()">
            <div id="backPreview" class="hidden">
              <img id="backImage" class="preview-image mx-auto rounded-lg mb-3">
              <button onclick="removeBack(event)" class="glass hover:bg-red-500/50 px-4 py-2 rounded-lg text-sm">
                <i class="fas fa-trash mr-2"></i>Eliminar
              </button>
            </div>
            <div id="backPlaceholder">
              <i class="fas fa-cloud-arrow-up text-5xl mb-3 opacity-50"></i>
              <p class="font-semibold mb-1">Click para subir</p>
              <p class="text-sm text-slate-300">o arrastra aquí</p>
            </div>
          </div>
          <input type="file" id="backInput" class="hidden" accept="image/*,application/pdf" onchange="handleBackUpload(event)">
        </div>
      </div>

      <button id="continueToSelfieBtn" onclick="continueToSelfie()"
              class="w-full bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 px-6 py-3 rounded-lg font-semibold transition opacity-50 cursor-not-allowed"
              disabled>
        Continuar al Paso 2
        <i class="fas fa-arrow-right ml-2"></i>
      </button>
    </div>

    <!-- Upload Section: Selfie -->
    <div id="selfieSection" class="glass rounded-2xl p-8 mb-6 hidden">
      <h3 class="text-2xl font-bold mb-6">
        <i class="fas fa-camera mr-2 text-pink-400"></i>
        2. Selfie con Documento
      </h3>

      <!-- Instrucciones -->
      <div class="bg-pink-500/20 border border-pink-400/30 rounded-xl p-4 mb-6">
        <h4 class="font-bold mb-2">
          <i class="fas fa-info-circle mr-2"></i>Instrucciones
        </h4>
        <ul class="text-sm space-y-1 text-slate-200">
          <li>✓ Tu rostro debe ser claramente visible</li>
          <li>✓ Sostén el documento junto a tu cara</li>
          <li>✓ Buena iluminación, sin sombras</li>
          <li>✓ Sin gafas de sol ni máscaras</li>
          <li>✓ Expresión natural, mirando a la cámara</li>
        </ul>
      </div>

      <!-- Camera / Upload -->
      <div class="mb-6">
        <div class="upload-area rounded-xl p-8 text-center cursor-pointer"
             id="uploadSelfieArea"
             onclick="document.getElementById('selfieInput').click()">
          <div id="selfiePreview" class="hidden">
            <img id="selfieImage" class="preview-image mx-auto rounded-lg mb-3">
            <button onclick="removeSelfie(event)" class="glass hover:bg-red-500/50 px-4 py-2 rounded-lg text-sm">
              <i class="fas fa-trash mr-2"></i>Eliminar
            </button>
          </div>
          <div id="selfiePlaceholder">
            <i class="fas fa-camera text-5xl mb-3 opacity-50"></i>
            <p class="font-semibold mb-1">Click para tomar foto o subir</p>
            <p class="text-sm text-slate-300">Usa la cámara o selecciona archivo</p>
          </div>
        </div>
        <input type="file" id="selfieInput" class="hidden" accept="image/*" capture="user" onchange="handleSelfieUpload(event)">
      </div>

      <button id="submitVerificationBtn" onclick="submitVerification()"
              class="w-full bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 px-6 py-3 rounded-lg font-semibold transition opacity-50 cursor-not-allowed"
              disabled>
        <i class="fas fa-paper-plane mr-2"></i>
        Enviar para Verificación
      </button>
    </div>

    <!-- Información Adicional -->
    <div class="glass rounded-2xl p-6">
      <h4 class="font-bold mb-3">
        <i class="fas fa-lock mr-2 text-green-400"></i>
        Seguridad y Privacidad
      </h4>
      <ul class="text-sm space-y-2 text-slate-300">
        <li><i class="fas fa-check text-green-400 mr-2"></i>Tus documentos están encriptados end-to-end</li>
        <li><i class="fas fa-check text-green-400 mr-2"></i>Solo el equipo de verificación tiene acceso</li>
        <li><i class="fas fa-check text-green-400 mr-2"></i>No compartimos tu información con terceros</li>
        <li><i class="fas fa-check text-green-400 mr-2"></i>Los documentos se eliminan después de la verificación</li>
        <li><i class="fas fa-check text-green-400 mr-2"></i>Cumplimos con RGPD y normativas de privacidad</li>
      </ul>
    </div>

  </main>

  <!-- Toast Container -->
  <div id="toastContainer" class="fixed bottom-4 right-4 z-50 space-y-2"></div>

  <!-- Loading Modal -->
  <div id="loadingModal" class="fixed inset-0 bg-black/70 hidden items-center justify-center z-50" style="backdrop-filter: blur(10px);">
    <div class="glass rounded-2xl p-8 text-center">
      <div class="inline-block animate-spin rounded-full h-16 w-16 border-4 border-white border-t-transparent mb-4"></div>
      <p class="text-lg font-semibold">Subiendo documentos...</p>
      <p class="text-sm text-slate-300 mt-2">Por favor espera</p>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script type="module">
    import { auth, db, storage } from './js/firebase-config.js';
    import {
      doc,
      getDoc,
      updateDoc,
      serverTimestamp
    } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';
    import {
      ref,
      uploadBytes,
      getDownloadURL
    } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js';
    import { showToast } from './js/utils.js';

    let currentUser = null;
    let userData = null;
    let frontFile = null;
    let backFile = null;
    let selfieFile = null;

    // ==========================================================================
    // INICIALIZACIÓN
    // ==========================================================================

    document.addEventListener('DOMContentLoaded', async () => {
      currentUser = auth.currentUser;
      if (!currentUser) {
        window.location.href = 'login.html';
        return;
      }

      // Cargar datos del usuario
      try {
        const userDoc = await getDoc(doc(db, 'users', currentUser.uid));
        if (userDoc.exists()) {
          userData = userDoc.data();

          // Verificar si ya está verificado
          if (userData.isVerified) {
            showToast('Tu identidad ya está verificada', 'success');
            setTimeout(() => window.location.href = 'perfil.html', 2000);
            return;
          }

          // Verificar si hay verificación pendiente
          if (userData.verificationStatus === 'pending') {
            document.getElementById('verificationStatus').innerHTML = '<i class="fas fa-clock mr-1"></i>En Revisión';
            document.getElementById('verificationStatus').classList.add('bg-yellow-500/30');
            showToast('Tu verificación está en proceso de revisión', 'info');
          }
        }
      } catch (error) {
        console.error('Error cargando usuario:', error);
      }

      // Setup drag and drop
      setupDragAndDrop();
    });

    // ==========================================================================
    // DRAG AND DROP
    // ==========================================================================

    function setupDragAndDrop() {
      ['uploadFrontArea', 'uploadBackArea', 'uploadSelfieArea'].forEach(areaId => {
        const area = document.getElementById(areaId);
        if (!area) return;

        area.addEventListener('dragover', (e) => {
          e.preventDefault();
          area.classList.add('dragover');
        });

        area.addEventListener('dragleave', () => {
          area.classList.remove('dragover');
        });

        area.addEventListener('drop', (e) => {
          e.preventDefault();
          area.classList.remove('dragover');

          const files = e.dataTransfer.files;
          if (files.length > 0) {
            const file = files[0];
            if (areaId === 'uploadFrontArea') {
              handleFrontUpload({ target: { files: [file] } });
            } else if (areaId === 'uploadBackArea') {
              handleBackUpload({ target: { files: [file] } });
            } else if (areaId === 'uploadSelfieArea') {
              handleSelfieUpload({ target: { files: [file] } });
            }
          }
        });
      });
    }

    // ==========================================================================
    // HANDLE UPLOADS
    // ==========================================================================

    window.handleFrontUpload = function(event) {
      const file = event.target.files[0];
      if (!file) return;

      // Validar tamaño
      if (file.size > 10 * 1024 * 1024) {
        showToast('El archivo es muy grande (máx 10 MB)', 'error');
        return;
      }

      // Validar tipo
      if (!file.type.startsWith('image/') && file.type !== 'application/pdf') {
        showToast('Solo imágenes o PDF', 'error');
        return;
      }

      frontFile = file;

      // Mostrar preview
      if (file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = (e) => {
          document.getElementById('frontImage').src = e.target.result;
          document.getElementById('frontPlaceholder').classList.add('hidden');
          document.getElementById('frontPreview').classList.remove('hidden');
        };
        reader.readAsDataURL(file);
      } else {
        // PDF - mostrar ícono
        document.getElementById('frontImage').src = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><path fill="%23ef4444" d="M369.9 97.9L286 14C277 5 264.8-.1 252.1-.1H48C21.5 0 0 21.5 0 48v416c0 26.5 21.5 48 48 48h288c26.5 0 48-21.5 48-48V131.9c0-12.7-5.1-25-14.1-34zM332.1 128H256V51.9l76.1 76.1zM48 464V48h160v104c0 13.3 10.7 24 24 24h104v288H48z"/></svg>';
        document.getElementById('frontPlaceholder').classList.add('hidden');
        document.getElementById('frontPreview').classList.remove('hidden');
      }

      checkDocumentStepComplete();
    };

    window.handleBackUpload = function(event) {
      const file = event.target.files[0];
      if (!file) return;

      if (file.size > 10 * 1024 * 1024) {
        showToast('El archivo es muy grande (máx 10 MB)', 'error');
        return;
      }

      if (!file.type.startsWith('image/') && file.type !== 'application/pdf') {
        showToast('Solo imágenes o PDF', 'error');
        return;
      }

      backFile = file;

      // Mostrar preview
      if (file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = (e) => {
          document.getElementById('backImage').src = e.target.result;
          document.getElementById('backPlaceholder').classList.add('hidden');
          document.getElementById('backPreview').classList.remove('hidden');
        };
        reader.readAsDataURL(file);
      } else {
        document.getElementById('backImage').src = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><path fill="%23ef4444" d="M369.9 97.9L286 14C277 5 264.8-.1 252.1-.1H48C21.5 0 0 21.5 0 48v416c0 26.5 21.5 48 48 48h288c26.5 0 48-21.5 48-48V131.9c0-12.7-5.1-25-14.1-34zM332.1 128H256V51.9l76.1 76.1zM48 464V48h160v104c0 13.3 10.7 24 24 24h104v288H48z"/></svg>';
        document.getElementById('backPlaceholder').classList.add('hidden');
        document.getElementById('backPreview').classList.remove('hidden');
      }

      checkDocumentStepComplete();
    };

    window.handleSelfieUpload = function(event) {
      const file = event.target.files[0];
      if (!file) return;

      if (file.size > 10 * 1024 * 1024) {
        showToast('El archivo es muy grande (máx 10 MB)', 'error');
        return;
      }

      if (!file.type.startsWith('image/')) {
        showToast('Solo imágenes', 'error');
        return;
      }

      selfieFile = file;

      // Mostrar preview
      const reader = new FileReader();
      reader.onload = (e) => {
        document.getElementById('selfieImage').src = e.target.result;
        document.getElementById('selfiePlaceholder').classList.add('hidden');
        document.getElementById('selfiePreview').classList.remove('hidden');
      };
      reader.readAsDataURL(file);

      checkSelfieStepComplete();
    };

    // ==========================================================================
    // REMOVE FILES
    // ==========================================================================

    window.removeFront = function(event) {
      event.stopPropagation();
      frontFile = null;
      document.getElementById('frontPreview').classList.add('hidden');
      document.getElementById('frontPlaceholder').classList.remove('hidden');
      document.getElementById('frontInput').value = '';
      checkDocumentStepComplete();
    };

    window.removeBack = function(event) {
      event.stopPropagation();
      backFile = null;
      document.getElementById('backPreview').classList.add('hidden');
      document.getElementById('backPlaceholder').classList.remove('hidden');
      document.getElementById('backInput').value = '';
      checkDocumentStepComplete();
    };

    window.removeSelfie = function(event) {
      event.stopPropagation();
      selfieFile = null;
      document.getElementById('selfiePreview').classList.add('hidden');
      document.getElementById('selfiePlaceholder').classList.remove('hidden');
      document.getElementById('selfieInput').value = '';
      checkSelfieStepComplete();
    };

    // ==========================================================================
    // CHECK STEPS
    // ==========================================================================

    function checkDocumentStepComplete() {
      const btn = document.getElementById('continueToSelfieBtn');
      if (frontFile && backFile) {
        btn.disabled = false;
        btn.classList.remove('opacity-50', 'cursor-not-allowed');
      } else {
        btn.disabled = true;
        btn.classList.add('opacity-50', 'cursor-not-allowed');
      }
    }

    function checkSelfieStepComplete() {
      const btn = document.getElementById('submitVerificationBtn');
      if (selfieFile) {
        btn.disabled = false;
        btn.classList.remove('opacity-50', 'cursor-not-allowed');
      } else {
        btn.disabled = true;
        btn.classList.add('opacity-50', 'cursor-not-allowed');
      }
    }

    // ==========================================================================
    // CONTINUE TO SELFIE
    // ==========================================================================

    window.continueToSelfie = function() {
      // Mark step 1 complete
      document.getElementById('step1').classList.remove('active');
      document.getElementById('step1').classList.add('completed');
      document.getElementById('step1Status').classList.remove('hidden');

      // Activate step 2
      document.getElementById('step2').classList.add('active');

      // Show selfie section
      document.getElementById('selfieSection').classList.remove('hidden');
      document.getElementById('selfieSection').scrollIntoView({ behavior: 'smooth' });

      showToast('¡Paso 1 completado! Ahora toma tu selfie', 'success');
    };

    // ==========================================================================
    // SUBMIT VERIFICATION
    // ==========================================================================

    window.submitVerification = async function() {
      const modal = document.getElementById('loadingModal');
      modal.classList.remove('hidden');
      modal.classList.add('flex');

      try {
        // Upload files to Firebase Storage
        const frontRef = ref(storage, `verification_docs/${currentUser.uid}/front_${Date.now()}`);
        const backRef = ref(storage, `verification_docs/${currentUser.uid}/back_${Date.now()}`);
        const selfieRef = ref(storage, `verification_docs/${currentUser.uid}/selfie_${Date.now()}`);

        await Promise.all([
          uploadBytes(frontRef, frontFile),
          uploadBytes(backRef, backFile),
          uploadBytes(selfieRef, selfieFile)
        ]);

        // Get download URLs
        const [frontURL, backURL, selfieURL] = await Promise.all([
          getDownloadURL(frontRef),
          getDownloadURL(backRef),
          getDownloadURL(selfieRef)
        ]);

        // Update user document
        await updateDoc(doc(db, 'users', currentUser.uid), {
          verificationStatus: 'pending',
          verificationDocuments: {
            front: frontURL,
            back: backURL,
            selfie: selfieURL,
            submittedAt: serverTimestamp()
          }
        });

        modal.classList.add('hidden');

        // Mark step 2 complete
        document.getElementById('step2').classList.remove('active');
        document.getElementById('step2').classList.add('completed');
        document.getElementById('step2Status').classList.remove('hidden');

        // Activate step 3
        document.getElementById('step3').classList.add('active');

        // Update status
        document.getElementById('verificationStatus').innerHTML = '<i class="fas fa-clock mr-1"></i>En Revisión';
        document.getElementById('verificationStatus').classList.add('bg-yellow-500/30');

        showToast('¡Verificación enviada! Revisaremos tu solicitud en 24-48 horas', 'success');

        // Redirect after 3 seconds
        setTimeout(() => {
          window.location.href = 'perfil.html';
        }, 3000);

      } catch (error) {
        console.error('Error submitting verification:', error);
        modal.classList.add('hidden');
        showToast('Error enviando verificación. Inténtalo de nuevo.', 'error');
      }
    };
  </script>

</body>
</html>
