<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="recaptcha:disable" content="true" />
    <title>QA Suscripción PayPal</title>
    <style>
      body { font-family: system-ui, sans-serif; margin: 2rem; }
      .row { display: flex; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap; }
      label { display: block; font-size: 0.9rem; color: #334; margin-bottom: 0.25rem; }
      input { padding: 0.5rem; width: 360px; max-width: 100%; }
      button { padding: 0.6rem 1rem; background: #0d6efd; color: white; border: none; border-radius: 6px; cursor: pointer; }
      button:disabled { opacity: 0.6; cursor: not-allowed; }
      .note { font-size: 0.9rem; color: #555; }
      #status { margin-top: 1rem; }
    </style>
  </head>
  <body>
    <h1>QA Suscripción PayPal (sin login)</h1>
    <p class="note">Esta página carga el SDK de PayPal dinámicamente y crea suscripciones con <code>plan_id</code> sin requerir autenticación.</p>

    <div class="row">
      <div>
        <label for="clientId">PayPal Client ID (sandbox o live)</label>
        <input id="clientId" placeholder="AUV2..." />
      </div>
      <div>
        <label for="planId">Plan ID</label>
        <input id="planId" placeholder="P-XXXXXXXXXXXX" />
      </div>
    </div>

    <div class="row">
      <button id="loadBtn">Cargar SDK y Renderizar botón</button>
      <button id="resetBtn" style="background:#6c757d">Reset</button>
    </div>

    <div id="paypal-subscribe-button"></div>
    <div id="status"></div>

    <script>
      const loadBtn = document.getElementById('loadBtn');
      const resetBtn = document.getElementById('resetBtn');
      const statusEl = document.getElementById('status');
      const clientIdInput = document.getElementById('clientId');
      const planIdInput = document.getElementById('planId');

      function setStatus(msg) {
        statusEl.textContent = msg;
      }

      function injectSdk(clientId) {
        return new Promise((resolve, reject) => {
          const existing = document.querySelector('script[data-qa-sdk="paypal"]');
          if (existing) existing.remove();
          const s = document.createElement('script');
          const params = new URLSearchParams(window.location.search);
          const override = params.get('sdk-params');
          const defaultParams = `client-id=${encodeURIComponent(clientId)}&intent=subscription&vault=true&components=buttons`;
          s.src = `https://www.paypal.com/sdk/js?${override || defaultParams}`;
          s.async = true;
          s.dataset.qaSdk = 'paypal';
          s.onload = () => resolve();
          s.onerror = (e) => reject(e);
          document.head.appendChild(s);
        });
      }

      async function renderButtons(planId) {
        if (!window.paypal || !window.paypal.Buttons) {
          throw new Error('SDK de PayPal no cargado');
        }
        document.getElementById('paypal-subscribe-button').innerHTML = '';
        await window.paypal.Buttons({
          style: { shape: 'pill', layout: 'vertical' },
          createSubscription: function (data, actions) {
            return actions.subscription.create({ plan_id: planId });
          },
          onApprove: function (data) {
            console.log('Suscripción aprobada', data);
            setStatus(`Suscripción OK. ID: ${data.subscriptionID}`);
            alert('Suscripción creada: ' + data.subscriptionID);
          },
          onError: function (err) {
            console.error(err);
            setStatus('Error en suscripción: ' + (err && err.message ? err.message : 'desconocido'));
          }
        }).render('#paypal-subscribe-button');
      }

      loadBtn.addEventListener('click', async () => {
        const clientId = clientIdInput.value.trim();
        const planId = planIdInput.value.trim();
        if (!clientId || !planId) {
          setStatus('Ingresa Client ID y Plan ID.');
          return;
        }
        loadBtn.disabled = true;
        setStatus('Cargando SDK de PayPal...');
        try {
          await injectSdk(clientId);
          setStatus('SDK cargado. Renderizando botón...');
          await renderButtons(planId);
          setStatus('Botón renderizado. Continúa con el flujo.');
        } catch (e) {
          console.error(e);
          setStatus('No se pudo cargar el SDK: ' + (e && e.message ? e.message : 'error'));
        } finally {
          loadBtn.disabled = false;
        }
      });

      resetBtn.addEventListener('click', () => {
        clientIdInput.value = '';
        planIdInput.value = '';
        document.getElementById('paypal-subscribe-button').innerHTML = '';
        const existing = document.querySelector('script[data-qa-sdk="paypal"]');
        if (existing) existing.remove();
        setStatus('Reset completado.');
      });

      (function presetFromQuery() {
        const params = new URLSearchParams(window.location.search);
        const qClientId = params.get('client-id') || params.get('clientId');
        const qPlanId = params.get('plan-id') || params.get('planId');
        const qAuto = params.get('auto');
        const qSdkParams = params.get('sdk-params');
        if (qClientId) clientIdInput.value = qClientId;
        if (qPlanId) planIdInput.value = qPlanId;
        const shouldAuto = qAuto === '1' || qAuto === 'true';
        if (shouldAuto && clientIdInput.value && planIdInput.value) {
          loadBtn.click();
        }
        if (qSdkParams) {
          const sdkUrl = `https://www.paypal.com/sdk/js?${qSdkParams}`;
          const info = document.createElement('div');
          info.className = 'note';
          info.textContent = `SDK override activo: ${sdkUrl}`;
          document.body.insertBefore(info, document.getElementById('paypal-subscribe-button'));
        }
      })();
    </script>
  </body>
</html>
