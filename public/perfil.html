<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Editar y gestionar tu perfil en TuCitaSegura." />
  
  <title>Mi Perfil ‚Äî TuCitaSegura</title>
  
  <!-- App Check Manager -->
  <script src="js/app-check-manager.js"></script>
  <!-- Mobile Menu Component -->
  <script src="js/mobile-menu.js"></script>
  
  <!-- SEO & Social Media -->
  <meta property="og:title" content="TuCitaSegura - Citas Seguras sin Plantones" />
  <meta property="og:description" content="Plataforma de citas segura con verificaci√≥n avanzada, suscripci√≥n mensual y sistema antidefault." />
  <meta property="og:type" content="website" />
  <meta property="og:image" content="https://tucitasegura.com/og-image.png" />
  <meta property="og:url" content="https://tucitasegura.com" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="TuCitaSegura" />
  <meta name="twitter:description" content="Citas seguras con sistema antidefault" />
  <meta name="theme-color" content="#0F172A" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="TuCitaSegura" />

  <!-- Performance hints / Fuentes / √çconos -->
  <link rel="dns-prefetch" href="https://www.gstatic.com" />
  <link rel="dns-prefetch" href="https://fonts.googleapis.com" />
  <link rel="dns-prefetch" href="https://cdnjs.cloudflare.com" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet" />
 <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet" crossorigin="anonymous" />

  <!-- CSS del proyecto -->
  <link rel="stylesheet" href="styles.css" />
  <!-- Enhanced Animations -->
  <link rel="stylesheet" href="css/enhanced-animations.css" />
  <link rel="canonical" href="https://tucitasegura.com/perfil" />
  <meta name="robots" content="noindex,nofollow" />

  <style>
    .avatar-circle { width: 96px; height: 96px; border-radius: 9999px; overflow: hidden; border: 2px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.08); }
  </style>

  <!-- App Check site key (banner informativo) -->
  <meta name="app_check_site_key" content="6LfdTvQrAAAAACkGjvbbFIkqHMsTHwRYYZS_CGq2" />
  <!-- App Check provider selection -->
  <meta name="app_check_provider" content="v3" />
  <!-- Dev only: desactivar reCAPTCHA en local para evitar ERR_ABORTED de extensiones/bloqueos -->
  <!-- Quitar esta meta antes de producci√≥n -->
  
  <style>
    .tcs-recaptcha-banner{position:fixed;left:0;right:0;top:0;z-index:10000;background:#7f1d1d;color:#fecaca;border-bottom:1px solid #fca5a5;padding:.6rem 1rem;font-size:.9rem;display:none}
    .tcs-recaptcha-banner b{color:#fff}
  </style>
</head>
<body class="min-h-screen text-white font-inter">
  <div id="tcsRecaptchaBanner" class="tcs-recaptcha-banner">‚ö†Ô∏è <b>App Check</b>: reCAPTCHA no est√° configurado para este dominio. Revisa el site key de App Check.</div>
  <header class="fixed top-0 left-0 w-full glass backdrop-blur-xl z-50">
    <nav class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex items-center justify-between h-16">
      <div class="flex items-center gap-2">
        <i class="fas fa-heart-circle-check text-blue-400 text-2xl"></i>
        <span class="text-xl font-bold gradient-text">TuCitaSegura</span>
      </div>
      <div class="hidden md:flex items-center gap-6">
        <span id="userEmail" class="text-sm text-gray-300">‚Äî</span>
        <a href="/conversaciones.html" class="hover:underline">Conversaciones</a>
        <a href="/admin/dashboard.html" class="hover:underline">Admin</a>
        <button id="logoutBtn" class="glass px-5 py-2 rounded-full font-semibold">Salir</button>
      </div>
          <!-- Mobile menu button -->
      <div class="md:hidden">
        <button id="mobileMenuBtn" class="text-white hover:text-blue-400 transition-colors" aria-label="Abrir men√∫">
          <i class="fas fa-bars text-xl"></i>
        </button>
      </div>
    </nav>
  </header>

  <main class="max-w-6xl mx-auto px-4 pt-24 pb-16">
    <section class="glass rounded-2xl p-6 md:p-8 mb-6">
      <div class="md:flex items-center gap-6">
        <div class="avatar-circle avatar-ring">
          <img id="avatarPreviewTop" src="" alt="Avatar" class="w-full h-full object-cover hidden" />
        </div>
        <div class="flex-1">
          <h1 class="title-hero gradient-text">Mi Perfil</h1>
          <div class="flex flex-wrap gap-2 mt-3" id="statusChips">
            <span id="chipEmailVerified" class="chip">Email</span>
            <span id="chipPhoneVerified" class="chip">Tel√©fono</span>
            <span id="chipProfileComplete" class="chip">Perfil</span>
            <span id="chipConcierge" class="chip hidden">Concierge</span>
          </div>
          <div class="progress mt-4"><div id="profileProgressBar" class="progress-bar"></div></div>
          <div id="profileProgressText" class="text-soft mt-2">Completitud 0%</div>
          <div class="mt-4 flex gap-3">
            <button id="topVerifyEmailBtn" class="btn-success rounded">Verificar Email</button>
            <button id="topSendOtpBtn" class="btn-success rounded">Enviar c√≥digo SMS</button>
            <button id="topSaveProfileBtn" class="btn-success rounded">Guardar perfil</button>
          </div>
        </div>
      </div>
    </section>
    <!-- Banner verificaci√≥n -->
    <div id="verifyBanner" class="hidden glass border border-yellow-400/40 text-yellow-100 p-4 rounded-xl mb-6">
      <div class="flex items-center justify-between gap-4">
        <p class="text-sm">Debes verificar tu email para activar todas las funciones.</p>
        <button id="resendBtn" class="px-4 py-2 rounded bg-yellow-500/20 text-yellow-100 font-semibold hover:bg-yellow-500/30">Reenviar verificaci√≥n</button>
      </div>
    </div>
    <!-- Banner tel√©fono requerido -->
    <div id="phoneRequiredBanner" class="hidden glass border border-red-500/40 bg-red-600/10 text-red-100 p-4 rounded-xl mb-6">
      <div class="flex items-center justify-between gap-4">
        <p class="text-sm">Debes verificar tu tel√©fono por SMS para acceder a b√∫squedas, chats y citas.</p>
        <button id="bannerSendOtpBtn" class="px-4 py-2 rounded bg-red-500/20 text-red-100 font-semibold hover:bg-red-500/30">Enviar c√≥digo</button>
      </div>
    </div>
    <!-- Banner validaci√≥n de perfil requerida -->
    <div id="validationRequiredBanner" class="hidden glass border border-yellow-500/40 bg-yellow-600/10 text-yellow-100 p-4 rounded-xl mb-6">
      <div class="flex items-center justify-between gap-4">
        <p class="text-sm">Tu perfil debe estar completo y ser√° <b>validado</b> por nuestro equipo. Te avisaremos por email/SMS/notificaci√≥n cuando est√© aprobado.</p>
        <a href="#profileForm" class="px-4 py-2 rounded bg-yellow-500/20 text-yellow-100 font-semibold hover:bg-yellow-500/30">Completar perfil</a>
      </div>
    </div>

    <section class="glass rounded-2xl p-6 md:p-8">
      <h2 class="section-title">Mi Perfil</h2>
      <span id="conciergeBadge" class="ml-2 px-3 py-1 rounded-full text-xs bg-indigo-600/30 text-indigo-200 border border-indigo-400/40 hidden">üé© Concierge Verificado</span>
      <p class="lead mb-6">Completa tu informaci√≥n para mejorar tus coincidencias.</p>

      <form id="profileForm" class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="md:col-span-2 flex items-center gap-6">
          <div class="avatar-circle">
            <img id="avatarPreview" src="" alt="Previsualizaci√≥n" class="w-full h-full object-cover hidden" />
          </div>
          <div>
            <label for="avatarInput" class="block mb-1 text-blue-100">Avatar</label>
            <input id="avatarInput" type="file" accept="image/*" class="block text-sm" />
          <button id="uploadAvatarBtn" type="button" class="mt-2 btn-success px-4 py-2 rounded text-white font-semibold">Subir avatar</button>
            <p class="text-xs text-blue-100 mt-2">Formatos: PNG/JPG/JPEG. M√°x: 5MB.</p>
            <p class="text-xs text-yellow-200 mt-1">Obligatorio: sube una foto de perfil para completar.</p>
          </div>
        </div>
        <!-- Alias y G√©nero se establecen en el registro; no se muestran aqu√≠ -->
        <!-- PayPal (solo mujeres) -->
        <div id="paypalFieldWrap" class="hidden">
          <label for="paypalEmailInput" class="block mb-1 text-blue-100">PayPal (email)</label>
          <input id="paypalEmailInput" type="email" class="input bg-white/10 text-white border border-white/20 w-full" placeholder="tu@email.com" />
          <div class="text-xs text-yellow-200 mt-1">Obligatorio si tu g√©nero es <b>Femenino</b>.</div>
          <div class="text-xs text-blue-200 mt-1">Este correo puede ser distinto al utilizado en el registro.</div>
        </div>
        <!-- Ocupaci√≥n -->
        <div>
          <label for="occupationInput" class="block mb-1 text-blue-100">Ocupaci√≥n</label>
          <input id="occupationInput" type="text" class="input bg-white/10 text-white border border-white/20 w-full" placeholder="¬øA qu√© te dedicas?" />
        </div>
        <!-- Verificaci√≥n de tel√©fono (OTP) -->
        <div class="md:col-span-2 glass p-4 rounded-xl">
          <h2 class="text-xl font-bold mb-2">Verificaci√≥n de tel√©fono</h2>
          <p class="lead mb-3">A√±ade tu tel√©fono para aumentar tu reputaci√≥n y habilitar recuperaci√≥n por SMS.</p>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-3 items-end">
            <div>
              <label for="phoneInput" class="block mb-1 text-blue-100">Tel√©fono (formato internacional)</label>
              <input id="phoneInput" type="tel" class="input bg-white/10 text-white border border-white/20 w-full" placeholder="+34XXXXXXXXX" autocomplete="tel" />
            </div>
            <div>
          <button id="sendOtpBtn" type="button" class="btn-success w-full py-2 rounded">Enviar c√≥digo</button>
            </div>
            <div>
              <label for="otpCodeInput" class="block mb-1 text-blue-100">C√≥digo SMS</label>
              <input id="otpCodeInput" type="text" inputmode="numeric" pattern="[0-9]*" class="input bg-white/10 text-white border border-white/20 w-full" placeholder="123456" />
            </div>
          </div>
          <div class="flex gap-3 mt-3">
            <button id="confirmOtpBtn" type="button" class="btn-success flex-1 py-2 rounded">Confirmar tel√©fono</button>
            <span id="phoneStatus" class="text-sm text-blue-200">‚Äî</span>
          </div>
          <div id="otpMsg" class="text-sm text-yellow-200 mt-2"></div>
          <div id="recaptcha-container" class="hidden"></div>
        </div>
        <!-- Informaci√≥n personal -->
        <div class="md:col-span-2 glass p-4 rounded-xl">
          <h2 class="section-title">Informaci√≥n personal</h2>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
              <label for="relationshipSelect" class="block mb-1 text-blue-100">Estado civil</label>
              <select id="relationshipSelect" class="input bg-white/10 text-white border border-white/20 w-full">
                <option value="felizmente_separado_divorciado">Felizmente separado o divorciado</option>
                <option value="casado_golfo">Casado y golfo</option>
                <option value="viudo">Viudo</option>
                <option value="libre_como_un_pajaro">Libre como un p√°jaro</option>
                <option value="prefiero_no_contestar">Prefiero no contestar</option>
              </select>
            </div>
            <div>
              <label for="lookingForSelect" class="block mb-1 text-blue-100">¬øQu√© buscas?</label>
              <select id="lookingForSelect" class="input bg-white/10 text-white border border-white/20 w-full">
                <option value="casual">Cosas espor√°dicas</option>
                <option value="long_term">A largo plazo</option>
                <option value="friendship">Amistad</option>
              </select>
            </div>
            <div class="md:col-span-1">
              <label for="bioInput" class="block mb-1 text-blue-100">Autodescripci√≥n (m√≠nimo 120 palabras)</label>
              <textarea id="bioInput" rows="4" class="input bg-white/10 text-white border border-white/20 w-full" placeholder="Escribe al menos 120 palabras sobre ti"></textarea>
              <div class="text-xs text-blue-200 mt-1">Palabras: <span id="bioWordCount">0</span> / 120</div>
            </div>
          </div>
        </div>

        <!-- Fotos adicionales (galer√≠a) -->
        <div class="md:col-span-2 glass p-4 rounded-xl">
          <h2 class="section-title">Fotos adicionales</h2>
          <p class="lead mb-3">Puedes subir hasta 6 fotos extra. <b>Obligatorio: al menos 2</b> adem√°s del avatar.</p>
          <div class="flex items-center gap-4 mb-3">
            <label for="galleryInput" class="block mb-1 text-blue-100">Subir fotos</label>
            <input id="galleryInput" type="file" accept="image/*" multiple class="block text-sm" />
            <span class="text-xs text-blue-100">Formatos: PNG/JPG/JPEG. M√°x: 5MB por foto.</span>
          </div>
          <div id="galleryPreview" class="grid grid-cols-3 md:grid-cols-6 gap-2"></div>
          <div id="galleryMsg" class="text-xs text-yellow-200 mt-2"></div>
        </div>

        <!-- Ubicaci√≥n de origen -->
        <div class="md:col-span-2 glass p-4 rounded-xl">
          <h2 class="section-title">Municipio de origen</h2>
          <p class="lead mb-3">Indica tu municipio de origen para mejorar tus coincidencias.</p>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-3">
            <div>
              <label for="municipalityInput" class="block mb-1 text-blue-100">Municipio</label>
              <input id="municipalityInput" type="text" class="input bg-white/10 text-white border border-white/20 w-full" placeholder="Buscar municipio" />
              <div id="originSummary" class="text-xs text-blue-200 mt-1">‚Äî</div>
              <div class="text-xs text-yellow-200 mt-1">Obligatorio: selecciona tu municipio de origen.</div>
            </div>
          </div>
          <div id="originMap" class="rounded-xl overflow-hidden border border-white/20 hidden" style="height: 0; background: rgba(255,255,255,0.06);"></div>
          <div id="originMapMsg" class="text-xs text-yellow-200 mt-2 hidden"></div>
        </div>
        <!-- Preferencias de notificaci√≥n -->
        <div class="md:col-span-2 glass p-4 rounded-xl">
          <h2 class="section-title">Preferencias de notificaci√≥n</h2>
          <p class="lead mb-3">Elige c√≥mo quieres recibir avisos (validaci√≥n y otros eventos).</p>
          <div class="flex gap-6 items-center">
            <label class="flex items-center gap-2"><input id="notifyEmailChk" type="checkbox" class="accent-blue-500" /> Email</label>
            <label class="flex items-center gap-2"><input id="notifySmsChk" type="checkbox" class="accent-blue-500" /> SMS</label>
            <label class="flex items-center gap-2"><input id="notifyPushChk" type="checkbox" class="accent-blue-500" /> Push</label>
          </div>
          <p class="text-xs text-blue-200 mt-2">Por defecto usamos email. Puedes cambiarlo cuando quieras.</p>
        </div>
        <div class="md:col-span-2">
          <button id="saveProfileBtn" type="button" class="btn-success w-full py-3 rounded text-white font-bold">Guardar y continuar</button>
        </div>
      </form>
    </section>

    <div id="toast" class="toast" aria-live="polite" aria-atomic="true"></div>
  </main>

  <script type="module">
    import { initAppCheckDebug } from "./webapp/js/firebase-appcheck.js";
    try { initAppCheckDebug(); } catch {}
    import { auth, db, storage } from "./js/firebase-config-enterprise.js";
    import { doc, setDoc, getDoc, deleteField } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";
    import { onAuthStateChanged, sendEmailVerification, signOut, RecaptchaVerifier, linkWithPhoneNumber } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";
    import { ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-storage.js";
    import { showToast } from "./js/utils.js";

    // Utilidades locales (asegurar disponibilidad antes de uso)
    function updateGenderDependentFields() {
      const isFemale = storedGender === 'female';
      paypalFieldWrap.classList.toggle('hidden', !isFemale);
    }
    function isValidEmail(email) {
      if (!email) return false;
      return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
    }

    // Referencias de UI y estado
    const userEmailEl = document.getElementById("userEmail");
    const logoutBtn = document.getElementById("logoutBtn");
    const verifyBanner = document.getElementById("verifyBanner");
    const resendBtn = document.getElementById("resendBtn");
    const phoneRequiredBanner = document.getElementById("phoneRequiredBanner");
    const bannerSendOtpBtn = document.getElementById("bannerSendOtpBtn");
    const validationRequiredBanner = document.getElementById("validationRequiredBanner");
    const conciergeBadge = document.getElementById('conciergeBadge');
    // OTP refs
    const phoneInput = document.getElementById('phoneInput');
    const sendOtpBtn = document.getElementById('sendOtpBtn');
    const otpCodeInput = document.getElementById('otpCodeInput');
    const confirmOtpBtn = document.getElementById('confirmOtpBtn');
    const otpMsg = document.getElementById('otpMsg');
    const phoneStatus = document.getElementById('phoneStatus');
    const notifyEmailChk = document.getElementById('notifyEmailChk');
    const notifySmsChk = document.getElementById('notifySmsChk');
    const notifyPushChk = document.getElementById('notifyPushChk');
    // Alias se define en el registro; no se utiliza en el perfil
    const relationshipSelect = document.getElementById('relationshipSelect');
    const lookingForSelect = document.getElementById('lookingForSelect');
    const bioInput = document.getElementById('bioInput');
    const bioWordCountEl = document.getElementById('bioWordCount');
    const occupationInput = document.getElementById('occupationInput');
    const galleryInput = document.getElementById('galleryInput');
    const galleryPreview = document.getElementById('galleryPreview');
    const galleryMsg = document.getElementById('galleryMsg');
    const paypalFieldWrap = document.getElementById('paypalFieldWrap');
    const paypalEmailInput = document.getElementById('paypalEmailInput');
    const avatarPreviewTop = document.getElementById('avatarPreviewTop');
    const chipEmailVerified = document.getElementById('chipEmailVerified');
    const chipPhoneVerified = document.getElementById('chipPhoneVerified');
    const chipProfileComplete = document.getElementById('chipProfileComplete');
    const chipConcierge = document.getElementById('chipConcierge');
    const profileProgressBar = document.getElementById('profileProgressBar');
    const profileProgressText = document.getElementById('profileProgressText');
    let phoneVerifiedFlag = false;
    let profileValidatedFlag = false;
    const appCheckBanner = document.getElementById("tcsRecaptchaBanner");
    let currentUser = null;
    let storedGender = 'male';
    // Host y entorno: s√≥lo habilitamos OTP (reCAPTCHA) en dominios de producci√≥n
    const host = location.hostname || '';
    const isProdHost = /\.web\.app$/.test(host) || /\.firebaseapp\.com$/.test(host) || host === 'tucitasegura.com' || host === 'www.tucitasegura.com';
    
    // Acci√≥n del bot√≥n del banner para iniciar OTP y hacer scroll a la secci√≥n de tel√©fono
    bannerSendOtpBtn?.addEventListener('click', (e) => {
      e.preventDefault();
      try { sendOtp(); } catch {}
      const y = phoneInput.getBoundingClientRect().top + window.scrollY - 80;
      window.scrollTo({ top: y, behavior: 'smooth' });
    });

    // Banner App Check: mostrar si no hay token o init fall√≥
    async function diagnoseAppCheck(banner) {
      try {
        const token = (localStorage.getItem('firebaseAppCheckDebugToken') || (typeof self.FIREBASE_APPCHECK_DEBUG_TOKEN === 'string' ? self.FIREBASE_APPCHECK_DEBUG_TOKEN : '')).trim();
        if (!token) {
          banner.innerHTML = '‚ö†Ô∏è <b>App Check</b>: sin token de depuraci√≥n. Genera y registra uno en Firebase Console y recarga con <code>?debugtoken=EL_TOKEN</code>.';
          return;
        }
        const appId = auth.app.options.appId;
        const projectId = auth.app.options.projectId;
        const apiKey = auth.app.options.apiKey;
        const url = `https://content-firebaseappcheck.googleapis.com/v1/projects/${encodeURIComponent(projectId)}/apps/${encodeURIComponent(appId)}:exchangeDebugToken?key=${encodeURIComponent(apiKey)}`;
        const res = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ debug_token: token })
        });
        const text = await res.text();
        if (res.ok) {
          banner.style.display = 'none';
          return;
        } else {
          let json; try { json = JSON.parse(text); } catch {}
          const apiMsg = (json && json.error && json.error.message) ? json.error.message : (text || '');
          let message = '';
          if (res.status === 403) {
            if (/UNREGISTERED|NOT_REGISTERED|NOT ALLOWED|DEBUG_TOKEN/i.test(apiMsg)) {
              message = 'Token de depuraci√≥n no registrado para esta app. A√±√°delo en Firebase Console ‚Üí App Check ‚Üí Debug Tokens.';
            } else if (/API key|referer|restricted/i.test(apiMsg)) {
              message = 'API key restringida para App Check o dominio. Ajusta restricciones en Google Cloud Console.';
            } else {
              message = 'Token rechazado (403). Registra el token y revisa restricciones de API key.';
            }
          } else if (res.status === 404) {
            message = 'App/Proyecto no encontrados (404). Verifica <code>appId</code> y <code>projectId</code>.';
          } else {
            message = `Error ${res.status}. ${apiMsg}`;
          }
          banner.innerHTML = `‚ö†Ô∏è <b>App Check</b>: ${message}`;
        }
      } catch (e) {
        banner.innerHTML = '‚ö†Ô∏è <b>App Check</b>: no se pudo diagnosticar. Revisa conexi√≥n/CSP.';
      }
    }

    (async () => {
      try {
        const ready = globalThis.__appCheckReady;
        let show = false;
        if (!ready || typeof ready.then !== 'function') {
          show = true;
        } else {
          const token = await Promise.race([
            ready,
            new Promise(resolve => setTimeout(() => resolve(null), 3000))
          ]);
          if (!token || (token.length || 0) < 10) show = true;
        }
        if (show) { appCheckBanner.style.display = 'block'; diagnoseAppCheck(appCheckBanner); }
      } catch {
        try { appCheckBanner.style.display = 'block'; diagnoseAppCheck(appCheckBanner); } catch {}
      }
    })();

    // Exigir sesi√≥n y precargar datos (con modo preview y demo)
    const isPreview = new URLSearchParams(location.search).has('ide_webview_request_time');
    // Simplificaci√≥n: OTP activo por defecto; √∫nico switch opcional ?nocaptcha=1 o meta
    function shouldSkipOtp() {
      try {
        const sp = new URLSearchParams(location.search);
        const metaDisableEl = document.querySelector('meta[name="recaptcha:disable"]');
        const metaDisabled = !!(metaDisableEl && (metaDisableEl.getAttribute('content') || '').toLowerCase() === 'true');
        return sp.get('nocaptcha') === '1' || metaDisabled;
      } catch {
        return false;
      }
    }
    const isDemo = new URLSearchParams(location.search).get('demo') === '1';
    // Avisos seg√∫n motivo de redirecci√≥n
    try {
      const reason = new URLSearchParams(location.search).get('reason');
      if (reason === 'phone-required') {
        phoneRequiredBanner.classList.remove('hidden');
        otpMsg.textContent = '‚ö†Ô∏è Debes verificar tu tel√©fono por SMS para acceder a las funciones.';
        otpMsg.classList.add('text-yellow-200');
        showToast('Verifica tu tel√©fono para continuar', 'warning');
      } else if (reason === 'validation-required') {
        validationRequiredBanner.classList.remove('hidden');
        showToast('Tu perfil debe estar completado y validado', 'warning');
      }
    } catch {}
  onAuthStateChanged(auth, async (user) => {
      if (!user) {
        // Mantener p√°gina est√°tica, sin redirecci√≥n autom√°tica
        showToast('Inicia sesi√≥n para editar tu perfil', 'info');
        return;
      }
      currentUser = user;
      userEmailEl.textContent = user.email || "";
      verifyBanner.classList.toggle('hidden', !!user.emailVerified);
      const userRef = doc(db, "users", user.uid);
      const snap = await getDoc(userRef);
      const data = snap.exists() ? snap.data() : {};
      if (!snap.exists()) {
        try {
          await setDoc(userRef, {
            profileComplete: false,
            updatedAt: new Date().toISOString()
          }, { merge: true });
        } catch (e) {
          console.warn("No se pudo inicializar el perfil del usuario", e);
        }
      }
      const privateSnap = await getDoc(doc(db, "users_private", user.uid));
      const priv = privateSnap.exists() ? privateSnap.data() : {};
      // Mostrar badge Concierge si el rol es concierge (claim o perfil)
      try {
        const tokenResult = await user.getIdTokenResult().catch(() => null);
        const roleClaim = tokenResult?.claims?.role;
        if (roleClaim === 'concierge' || data.role === 'concierge') {
          conciergeBadge.classList.remove('hidden');
        } else {
          conciergeBadge.classList.add('hidden');
        }
      } catch {}
      // Alias no se muestra en el perfil
      const dg = (data.gender || '').toLowerCase();
      storedGender = (dg === 'femenino' || dg === 'female') ? 'female' : 'male';
      paypalEmailInput.value = data.paypalEmail || "";
      {
        const allowed = [
          'felizmente_separado_divorciado',
          'casado_golfo',
          'viudo',
          'libre_como_un_pajaro',
          'prefiero_no_contestar'
        ];
        let rs = data.relationshipStatus;
        // Mapeo autom√°tico de valores antiguos a los nuevos
        if (rs === 'single') rs = 'libre_como_un_pajaro';
        if (rs === 'in_relationship') rs = 'casado_golfo';
        if (!allowed.includes(rs)) rs = 'prefiero_no_contestar';
        relationshipSelect.value = rs;
      }
      lookingForSelect.value = data.lookingFor || "casual";
      bioInput.value = data.bio || "";
      occupationInput.value = data.occupation || "";
      // Contador de palabras inicial
      try { bioWordCountEl.textContent = countWords(bioInput.value.trim()); } catch {}
      // Origen: prellenar si existe
      try {
        if (data.originMunicipality && typeof data.originMunicipality === 'string') {
          originMunicipality = data.originMunicipality;
          document.getElementById('originSummary').textContent = originMunicipality;
        }
      } catch {}
      // Galer√≠a: precargar si existe
      try {
        if (Array.isArray(data.galleryUrls)) {
          existingGalleryUrls = data.galleryUrls.slice(0,6);
          renderGalleryPreview();
        }
      } catch {}
      // Pre-fill phone (privado)
      const isPhoneVerified = !!priv?.phoneVerified;
      if (priv?.phone) {
        phoneInput.value = priv.phone;
      }
      phoneStatus.textContent = isPhoneVerified ? 'Tel√©fono verificado' : 'Tel√©fono sin verificar';
      phoneStatus.classList.toggle('text-green-300', isPhoneVerified);
      phoneStatus.classList.toggle('text-yellow-200', !isPhoneVerified);
      phoneVerifiedFlag = isPhoneVerified;
      // Mostrar/ocultar banner de tel√©fono requerido en funci√≥n de phoneVerified
      if (!phoneVerifiedFlag) {
        phoneRequiredBanner.classList.remove('hidden');
      } else {
        phoneRequiredBanner.classList.add('hidden');
      }
      // Mostrar/ocultar banner de validaci√≥n requerida
      profileValidatedFlag = !!data.profileValidated;
      if (!profileValidatedFlag) {
        validationRequiredBanner.classList.remove('hidden');
      } else {
        validationRequiredBanner.classList.add('hidden');
      }
      // Preferencias de notificaci√≥n (por defecto email)
      try {
        const prefs = Array.isArray(data.notifyChannels) && data.notifyChannels.length ? data.notifyChannels : ['email'];
        notifyEmailChk.checked = prefs.includes('email');
        notifySmsChk.checked = prefs.includes('sms');
        notifyPushChk.checked = prefs.includes('push');
      } catch {}
      if (data.avatarUrl) {
        avatarPreview.src = data.avatarUrl;
        avatarPreview.classList.remove('hidden');
        avatarExistingUrl = data.avatarUrl;
        try { avatarPreviewTop.src = data.avatarUrl; avatarPreviewTop.classList.remove('hidden'); } catch {}
        updateSaveButtonState();
      }
      // Precargar ubicaciones guardadas
      if (data.meetingPoint && data.meetingPoint.lat && data.meetingPoint.lng) {
        meetingPlace = data.meetingPoint;
        document.getElementById('meetingSummary').textContent = `${meetingPlace.address || 'Punto guardado'} (${meetingPlace.lat.toFixed(5)}, ${meetingPlace.lng.toFixed(5)})`;
      }
      if (data.backupPoint && data.backupPoint.lat && data.backupPoint.lng) {
        backupPlace = data.backupPoint;
        document.getElementById('backupSummary').textContent = `${backupPlace.address || 'Punto guardado'} (${backupPlace.lat.toFixed(5)}, ${backupPlace.lng.toFixed(5)})`;
      }
      // Inicializar Google Maps para origen
      await initGoogleMaps();
      await setupMunicipalityAutocomplete();
      updateGenderDependentFields();
      updateSaveButtonState();
      updateVisualStatus();
    });

    const avatarInput = document.getElementById("avatarInput");
    const avatarPreview = document.getElementById("avatarPreview");
    const uploadAvatarBtn = document.getElementById("uploadAvatarBtn");
    let selectedFile = null;
    let avatarExistingUrl = null;

    avatarInput.addEventListener("change", () => {
      const file = avatarInput.files?.[0];
      if (!file) { selectedFile = null; avatarPreview.classList.add("hidden"); return; }
      if (!file.type.startsWith("image/")) {
        showToast("Selecciona una imagen v√°lida", "error");
        avatarInput.value = "";
        selectedFile = null;
        return;
      }
      if (file.size > 5 * 1024 * 1024) {
        showToast("Imagen demasiado grande (m√°x 5MB)", "error");
        avatarInput.value = "";
        selectedFile = null;
        return;
      }
      selectedFile = file;
      const url = URL.createObjectURL(file);
      avatarPreview.src = url;
      avatarPreview.classList.remove("hidden");
      updateSaveButtonState();
    });

    async function uploadAvatar(user, file) {
      const ownerGender = storedGender === 'female' ? 'femenino' : 'masculino';
      const path = `profile_photos/${ownerGender}/${user.uid}/avatar.jpg`;
      const storageRef = ref(storage, path);
      const metadata = { contentType: file.type, customMetadata: { ownerGender } };
      const snap = await uploadBytes(storageRef, file, metadata);
      const downloadURL = await getDownloadURL(snap.ref);
      return downloadURL;
    }

    uploadAvatarBtn.addEventListener("click", async () => {
      const user = auth.currentUser;
      if (!user) return;
      if (!selectedFile) { showToast("Selecciona una imagen primero", "info"); return; }
      try {
        const url = await uploadAvatar(user, selectedFile);
        await setDoc(doc(db, "users", user.uid), { avatarUrl: url }, { merge: true });
        avatarExistingUrl = url;
        showToast("Avatar actualizado", "success");
        updateSaveButtonState();
      } catch (e) {
        console.error(e);
        showToast("No se pudo subir el avatar", "error");
      }
    });

    document.getElementById("saveProfileBtn").addEventListener("click", async () => {
      const user = auth.currentUser;
      if (!user) return;
      if (isSaving) { showToast('Guardando, por favor espera‚Ä¶', 'info'); return; }
      // Validaci√≥n: municipio obligatorio
      const hasOrigin = !!originMunicipality && originMunicipality.trim().length > 0;
      if (!hasOrigin) {
        showToast("Selecciona tu municipio de origen", "warning");
        try { document.getElementById('municipalityInput')?.focus(); } catch {}
        return;
      }
      const gender = storedGender;
      // Validaci√≥n: avatar obligatorio
      const hasAvatar = !!selectedFile || !!avatarExistingUrl || (!!avatarPreview.src && !avatarPreview.classList.contains('hidden'));
      if (!hasAvatar) {
        showToast("Sube tu avatar para completar el perfil", "warning");
        try { document.getElementById('avatarInput')?.focus(); } catch {}
        const y2 = document.getElementById('avatarInput').getBoundingClientRect().top + window.scrollY - 120;
        window.scrollTo({ top: y2, behavior: 'smooth' });
        return;
      }
      // Validaci√≥n: PayPal obligatorio si es mujer
      if (storedGender === 'female') {
        const pp = paypalEmailInput.value.trim();
        if (!isValidEmail(pp)) {
          showToast("Debes rellenar tu email de PayPal", "warning");
          try { paypalEmailInput?.focus(); } catch {}
          return;
        }
      }
      // Validaci√≥n: galer√≠a m√≠nimo 2
      const galleryCount = (existingGalleryUrls?.length || 0) + (galleryFiles?.length || 0);
      if (galleryCount < 2) {
        showToast("Sube al menos 2 fotos adicionales", "warning");
        try { galleryInput?.focus(); } catch {}
        return;
      }
      // Validaci√≥n: ocupaci√≥n obligatoria
      const occupation = occupationInput.value.trim();
      if (!occupation) {
        showToast("Indica tu ocupaci√≥n", "warning");
        try { occupationInput?.focus(); } catch {}
        return;
      }
      const relationshipStatus = relationshipSelect.value;
      const lookingFor = lookingForSelect.value;
      const bio = bioInput.value.trim();
      // Validaci√≥n: bio m√≠nimo 120 palabras
      if (countWords(bio) < 120) {
        showToast("Autodescripci√≥n m√≠nima de 120 palabras", "warning");
        try { bioInput?.focus(); } catch {}
        return;
      }
      try {
        isSaving = true;
        try { saveProfileBtn.disabled = true; saveProfileBtn.classList.add('opacity-60','cursor-not-allowed'); } catch {}
        let avatarUrl = undefined;
        if (selectedFile) {
          try {
            avatarUrl = await uploadAvatar(user, selectedFile);
          } catch (e) {
            console.warn("Subida de avatar fall√≥, guardando perfil sin imagen", e);
          }
        }
        // Subir galer√≠a (nuevas fotos)
        let uploadedGallery = [];
        if (galleryFiles.length) {
          for (let i = 0; i < galleryFiles.length && i < 6; i++) {
            const file = galleryFiles[i];
            try {
            const ownerGender = storedGender === 'female' ? 'femenino' : 'masculino';
            const path = `profile_photos/${ownerGender}/${user.uid}/${Date.now()}-${i}.jpg`;
            const storageRef = ref(storage, path);
            const metadata = { contentType: file.type, customMetadata: { ownerGender } };
            const snap = await uploadBytes(storageRef, file, metadata);
            const url = await getDownloadURL(snap.ref);
            uploadedGallery.push(url);
            } catch (e) {
              console.warn('Error subiendo foto de galer√≠a', e);
            }
          }
        }
        const galleryUrls = [...(existingGalleryUrls || []), ...uploadedGallery].slice(0,6);
        // Perfil puede completarse aunque el tel√©fono no est√© verificado (validaci√≥n la hace admin)
        // Calcula perfil completo basado en campos obligatorios
      const isComplete = (
        hasOrigin &&
        hasAvatar &&
        galleryUrls.length >= 2 &&
        !!storedGender &&
        !!occupation &&
        !!relationshipStatus &&
        !!lookingFor &&
        (storedGender === 'female' ? isValidEmail(paypalEmailInput.value.trim()) : true) &&
        countWords(bio) >= 120
      );
        const payload = {
          relationshipStatus,
          lookingFor,
          occupation,
          ...(bio ? { bio } : {}),
          profileComplete: isComplete,
          ...(avatarUrl ? { avatarUrl } : {})
        };
        if (originMunicipality && typeof originMunicipality === 'string') {
          payload.originMunicipality = originMunicipality;
        }
        if (galleryUrls.length) {
          payload.galleryUrls = galleryUrls;
        }
        const paypalEmailVal = (paypalEmailInput?.value || '').trim();
        if (storedGender === 'female') {
          if (paypalEmailVal) payload.paypalEmail = paypalEmailVal;
        } else {
          // Eliminar PayPal para perfiles masculinos
          payload.paypalEmail = deleteField();
        }
        // Tel√©fono se guarda en users_private; no en perfil p√∫blico
        // Guardar preferencias seleccionadas (email por defecto si nada marcado)
        const selected = [];
        if (notifyEmailChk.checked) selected.push('email');
        if (notifySmsChk.checked) selected.push('sms');
        if (notifyPushChk.checked) selected.push('push');
        payload.notifyChannels = selected.length ? selected : ['email'];
        await setDoc(doc(db, "users", user.uid), payload, { merge: true });
        showToast(isComplete ? "Perfil guardado y completo. Queda pendiente de validaci√≥n." : "Perfil guardado, pero incompleto. Compl√©talo para navegar.", isComplete ? "success" : "warning");
        try { updateVisualStatus(); } catch {}
        // Si est√° incompleto, permanecer y mostrar aviso
        if (!isComplete) {
          validationRequiredBanner.classList.remove('hidden');
        }
      } catch (e) {
        try { console.error(e); } catch {}
        const msg = (e && e.code === 'permission-denied') ? 'Permisos insuficientes para guardar el perfil' : 'No se pudo guardar el perfil';
        showToast(msg, "error");
      } finally {
        isSaving = false;
        try { saveProfileBtn.disabled = false; saveProfileBtn.classList.remove('opacity-60','cursor-not-allowed'); } catch {}
      }
    });

    // Reenviar verificaci√≥n de correo
    resendBtn.addEventListener('click', async () => {
      const user = auth.currentUser;
      if (!user) return;
      try { await sendEmailVerification(user); showToast('Verificaci√≥n reenviada', 'success'); }
      catch (e) { console.error(e); showToast('No se pudo reenviar', 'error'); }
    });

    function computeCompletionPercent() {
      const hasOrigin = !!originMunicipality && originMunicipality.trim().length > 0;
      const hasAvatar = !!selectedFile || !!avatarExistingUrl || (!!avatarPreview.src && !avatarPreview.classList.contains('hidden'));
      const galleryCount = (existingGalleryUrls?.length || 0) + (galleryFiles?.length || 0);
      const hasGalleryMin = galleryCount >= 2;
      const hasOccupation = occupationInput && occupationInput.value.trim().length > 0;
      const hasRel = !!relationshipSelect.value;
      const hasLF = !!lookingForSelect.value;
      const hasBioMin = countWords(bioInput.value.trim()) >= 120;
      const hasPaypalOk = storedGender === 'female' ? isValidEmail((paypalEmailInput?.value || '').trim()) : true;
      const checks = [hasOrigin, hasAvatar, hasGalleryMin, hasOccupation, hasRel, hasLF, hasBioMin, hasPaypalOk];
      const done = checks.filter(Boolean).length;
      const percent = Math.round((done / checks.length) * 100);
      return percent;
    }

    function updateVisualStatus() {
      const p = computeCompletionPercent();
      if (profileProgressBar) profileProgressBar.style.width = `${p}%`;
      if (profileProgressText) profileProgressText.textContent = `Completitud ${p}%`;
      const emailOk = !!(auth.currentUser && auth.currentUser.emailVerified);
      chipEmailVerified?.classList.toggle('chip--success', emailOk);
      chipEmailVerified?.classList.toggle('chip--warning', !emailOk);
      chipEmailVerified && (chipEmailVerified.textContent = emailOk ? 'Email verificado' : 'Email sin verificar');
      chipPhoneVerified?.classList.toggle('chip--success', phoneVerifiedFlag);
      chipPhoneVerified?.classList.toggle('chip--warning', !phoneVerifiedFlag);
      chipPhoneVerified && (chipPhoneVerified.textContent = phoneVerifiedFlag ? 'Tel√©fono verificado' : 'Tel√©fono sin verificar');
      const isComplete = computeCompletionPercent() >= 100;
      chipProfileComplete?.classList.toggle('chip--success', isComplete);
      chipProfileComplete?.classList.toggle('chip--warning', !isComplete);
      chipProfileComplete && (chipProfileComplete.textContent = isComplete ? 'Perfil completo' : 'Perfil incompleto');
    }

    const topVerifyEmailBtn = document.getElementById('topVerifyEmailBtn');
    const topSendOtpBtn = document.getElementById('topSendOtpBtn');
    const topSaveProfileBtn = document.getElementById('topSaveProfileBtn');
    topVerifyEmailBtn?.addEventListener('click', async () => {
      const user = auth.currentUser; if (!user) return; try { await sendEmailVerification(user); showToast('Verificaci√≥n reenviada', 'success'); } catch { showToast('No se pudo reenviar', 'error'); }
    });
    topSendOtpBtn?.addEventListener('click', (e) => { e.preventDefault(); sendOtp(); });
    topSaveProfileBtn?.addEventListener('click', (e) => { e.preventDefault(); document.getElementById('saveProfileBtn')?.click(); });

    // Logout
    logoutBtn.addEventListener('click', async () => {
      try { await signOut(auth); location.href = '/'; }
      catch (e) { console.error(e); showToast('No se pudo cerrar sesi√≥n', 'error'); }
    });

    // Carga din√°mica de Google Maps y configuraci√≥n de origen (solo Autocomplete de municipios)
    async function initGoogleMaps() {
      try {
        const r = await fetch('/api/maps-key');
        const { key } = await r.json();
        const msg = document.getElementById('originMapMsg');
        if (!key) {
          msg.textContent = 'Google Maps no est√° configurado (GMAPS_API_KEY ausente).';
          msg.classList.remove('hidden');
          return;
        }
        // Solo necesitamos la librer√≠a Places para Autocomplete
        await loadMapsScript(key);
        // Validar disponibilidad tras carga (captura casos de clave inv√°lida)
        if (!window.google || !window.google.maps || !google.maps.places) {
          msg.textContent = 'Google Maps no disponible (clave inv√°lida o restringida).';
          msg.classList.remove('hidden');
        }
      } catch (e) {
        console.error('Maps init error', e);
        const msg = document.getElementById('originMapMsg');
        if (msg) { msg.textContent = 'Error inicializando Google Maps (clave inv√°lida)'; msg.classList.remove('hidden'); }
      }
    }

    function loadMapsScript(key) {
      return new Promise((resolve, reject) => {
        if (window.google && window.google.maps) return resolve();
        const s = document.createElement('script');
        s.src = `https://maps.googleapis.com/maps/api/js?key=${key}&libraries=places`;
        s.setAttribute('loading','async');
        s.async = true;
        s.defer = true;
        s.onload = () => resolve();
        s.onerror = reject;
        document.head.appendChild(s);
      });
    }

    let originMunicipality = null;
    let existingGalleryUrls = [];
    let galleryFiles = [];
    let originMapObj = null;
    let originMarker = null;

    function setupMunicipalityAutocomplete() {
      try {
        const input = document.getElementById('municipalityInput');
        if (!window.google || !window.google.maps || !google.maps.places) {
          console.warn('Google Places no disponible');
          // Fallback: usar entrada manual
          input.addEventListener('blur', () => {
            const val = input.value.trim();
            originMunicipality = val || null;
            document.getElementById('originSummary').textContent = val || '‚Äî';
            updateSaveButtonState();
          });
          return;
        }
        const auto = new google.maps.places.Autocomplete(input, { types: ['(cities)'], fields: ['formatted_address','name','geometry','place_id'] });
        auto.addListener('place_changed', () => {
          const p = auto.getPlace();
          const name = p?.name || p?.formatted_address || '';
          originMunicipality = name || null;
          document.getElementById('originSummary').textContent = name || '‚Äî';
          try {
            if (p && p.geometry && p.geometry.location) {
              const loc = p.geometry.location;
              const el = document.getElementById('originMap');
              if (el) {
                el.classList.remove('hidden');
                el.style.height = '220px';
                const center = { lat: loc.lat(), lng: loc.lng() };
                if (!originMapObj) {
                  originMapObj = new google.maps.Map(el, { center, zoom: 12, disableDefaultUI: true });
                } else {
                  originMapObj.setCenter(center);
                }
                if (!originMarker) {
                  originMarker = new google.maps.Marker({ position: center, map: originMapObj });
                } else {
                  originMarker.setPosition(center);
                }
              }
            }
          } catch {}
          updateSaveButtonState();
        });
      } catch (e) {
        console.error('Error configurando Autocomplete de municipio', e);
      }
    }

    function renderGalleryPreview() {
      if (!galleryPreview) return;
      galleryPreview.innerHTML = '';
      const urls = existingGalleryUrls || [];
      const files = galleryFiles || [];
      const total = [...urls, ...files.map(f => URL.createObjectURL(f))].slice(0,6);
      total.forEach(src => {
        const div = document.createElement('div');
        div.className = 'relative w-full h-20 md:h-24 rounded overflow-hidden border border-white/20';
        const img = document.createElement('img');
        img.src = src;
        img.alt = 'Foto';
        img.className = 'w-full h-full object-cover';
        div.appendChild(img);
        galleryPreview.appendChild(div);
      });
      const count = (existingGalleryUrls?.length || 0) + (galleryFiles?.length || 0);
      galleryMsg.textContent = count < 2 ? `Faltan ${2 - count} foto(s) para el m√≠nimo de 2.` : '';
    }

    galleryInput?.addEventListener('change', () => {
      const files = Array.from(galleryInput.files || []);
      const images = files.filter(f => f.type.startsWith('image/'));
      // Validaciones
      if (images.length > 6) {
        showToast('M√°ximo 6 fotos adicionales', 'warning');
      }
      const tooBig = images.find(f => f.size > 5 * 1024 * 1024);
      if (tooBig) {
        showToast('Una o m√°s fotos exceden 5MB', 'error');
      }
      galleryFiles = images.slice(0,6);
      renderGalleryPreview();
      updateSaveButtonState();
    });

    function countWords(text) {
      if (!text) return 0;
      return text.trim().split(/\s+/).filter(Boolean).length;
    }

    bioInput?.addEventListener('input', () => {
      try { bioWordCountEl.textContent = countWords(bioInput.value.trim()); } catch {}
      updateSaveButtonState();
    });

    function updateSaveButtonState() {
      const btn = document.getElementById('saveProfileBtn');
      if (!btn) return;
      const hasOrigin = !!originMunicipality && originMunicipality.trim().length > 0;
      const hasAvatar = !!selectedFile || !!avatarExistingUrl || (!!avatarPreview.src && !avatarPreview.classList.contains('hidden'));
      const galleryCount = (existingGalleryUrls?.length || 0) + (galleryFiles?.length || 0);
      const hasGalleryMin = galleryCount >= 2;
      const hasOccupation = occupationInput && occupationInput.value.trim().length > 0;
      const hasRel = !!relationshipSelect.value;
      const hasLF = !!lookingForSelect.value;
      const hasBioMin = countWords(bioInput.value.trim()) >= 120;
      const hasPaypalOk = storedGender === 'female' ? isValidEmail((paypalEmailInput?.value || '').trim()) : true;
      const canSave = hasOrigin && hasAvatar && hasGalleryMin && hasOccupation && hasRel && hasLF && hasBioMin && hasPaypalOk;
      btn.disabled = !canSave;
      btn.classList.toggle('opacity-60', !canSave);
      btn.classList.toggle('cursor-not-allowed', !canSave);
      try { updateVisualStatus(); } catch {}
    }

    // ===== OTP Phone Linking =====
    let phoneRecaptcha = null;
    let otpConfirmation = null;
    function initPhoneRecaptcha() {
      if (shouldSkipOtp()) {
        otpMsg.textContent = '‚ÑπÔ∏è OTP desactivado (usar ?nocaptcha=1 para pruebas)';
        return null;
      }
      if (phoneRecaptcha) return phoneRecaptcha;
      try {
        // Intento modular (SDK v9+): auth como primer par√°metro
        if (!auth) {
          throw new Error('Auth no inicializado');
        }
        phoneRecaptcha = new RecaptchaVerifier(auth, 'recaptcha-container', { size: 'invisible' });
      } catch (e) {
        console.error('Error creando RecaptchaVerifier (modular)', e);
        // Fallback a firma compat: container, params, auth
        try {
          phoneRecaptcha = new RecaptchaVerifier('recaptcha-container', { size: 'invisible' }, auth);
        } catch (e2) {
          console.error('Error creando RecaptchaVerifier (compat)', e2);
        }
      }
      return phoneRecaptcha;
    }
    async function sendOtp() {
      if (shouldSkipOtp()) { showToast('OTP desactivado (?nocaptcha=1)', 'info'); return; }
      otpMsg.textContent = '';
      const phone = phoneInput.value.trim();
      if (!/^\+[0-9]{8,15}$/.test(phone)) {
        otpMsg.textContent = '‚ùå Formato de tel√©fono inv√°lido. Usa +34...';
        showToast('Tel√©fono inv√°lido. Usa formato internacional', 'warning');
        return;
      }
      const user = auth.currentUser;
      if (!user) { showToast('Sesi√≥n requerida', 'error'); return; }
      try {
        await (globalThis.__appCheckReady || Promise.resolve(null));
        const verifier = initPhoneRecaptcha();
        otpConfirmation = await linkWithPhoneNumber(user, phone, verifier);
        otpMsg.textContent = '‚úÖ C√≥digo enviado por SMS';
        showToast('C√≥digo enviado por SMS', 'success');
      } catch (e) {
        console.error('Error enviando OTP', e);
        otpMsg.textContent = '‚ùå No se pudo enviar el c√≥digo';
        showToast('No se pudo enviar el c√≥digo', 'error');
      }
    }
    async function confirmOtp() {
      if (shouldSkipOtp()) { showToast('OTP desactivado (?nocaptcha=1)', 'info'); return; }
      otpMsg.textContent = '';
      const code = otpCodeInput.value.trim();
      if (!code) { showToast('Ingresa el c√≥digo', 'warning'); return; }
      if (!otpConfirmation) { showToast('Primero solicita el c√≥digo', 'warning'); return; }
      try {
        await (globalThis.__appCheckReady || Promise.resolve(null));
        const result = await otpConfirmation.confirm(code);
        // Guardar en perfil
        const phone = phoneInput.value.trim();
        await setDoc(doc(db, 'users_private', result.user.uid), { phone, phoneVerified: true, updatedAt: new Date() }, { merge: true });
        phoneStatus.textContent = 'Tel√©fono verificado';
        phoneStatus.classList.add('text-green-300');
        phoneStatus.classList.remove('text-yellow-200');
        phoneVerifiedFlag = true;
        phoneRequiredBanner.classList.add('hidden');
        otpMsg.textContent = '‚úÖ Tel√©fono verificado y vinculado a tu cuenta';
        showToast('Tel√©fono verificado', 'success');
      } catch (e) {
        console.error('Error confirmando OTP', e);
        otpMsg.textContent = '‚ùå C√≥digo inv√°lido o expirado';
        showToast('C√≥digo inv√°lido o expirado', 'error');
      }
    }
    // Deshabilitar botones OTP s√≥lo si expl√≠citamente desactivado
    try { 
      const disabled = shouldSkipOtp();
      sendOtpBtn.disabled = disabled; 
      confirmOtpBtn.disabled = disabled; 
    } catch {}
    sendOtpBtn.addEventListener('click', (e) => { e.preventDefault(); sendOtp(); });
    confirmOtpBtn.addEventListener('click', (e) => { e.preventDefault(); confirmOtp(); });
  </script>

  <!-- Guard opcional: asegura sesi√≥n; no redirige cuando ya est√°s en perfil -->
  <script src="./js/guards.js"></script>
  <script>
    // Initialize components when ready
    async function initializePerfilComponents() {
      try {
        // Wait for Firebase to be ready
        await waitForFirebase();
        
        // Check if Firebase is available
        if (typeof firebase === 'undefined') {
          console.error('‚ùå Firebase no est√° disponible');
          return;
        }
        
        // Get Firebase app
        const firebaseApp = firebase.app();
        
        // Initialize App Check Manager
        const appCheckManager = new AppCheckManager(firebaseApp, {
          siteKey: "6LfdTvQrAAAAACkGjvbbFIkqHMsTHwRYYZS_CGq2",
          autoRefresh: true,
          debugMode: true
        });
        
        // Initialize Mobile Menu
        const mobileMenu = new MobileMenu();
        
        // Initialize App Check with smart fallback
        await appCheckManager.init();
        
        console.log('‚úÖ Perfil: App Check Manager y Mobile Menu inicializados');
        
      } catch (error) {
        console.error('Error inicializando componentes:', error);
      }
    }
    
    // Start initialization when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializePerfilComponents);
    } else {
      initializePerfilComponents();
    }
  </script>
</body>
</html>
