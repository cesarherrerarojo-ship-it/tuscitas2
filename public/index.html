<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="TuCitaSegura - Plataforma de citas seguras con verificación avanzada, suscripción mensual y sistema antidefault.">
  <meta name="theme-color" content="#0f172a">
  
  <title>TuCitaSegura - Citas Seguras sin Plantones</title>

  <!-- Tailwind CSS -->
  <link rel="stylesheet" href="styles.css">
  <!-- Enhanced Animations -->
  <link rel="stylesheet" href="css/enhanced-animations.css">
  
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" crossorigin="anonymous">
  <!-- Favicon -->
  <link rel="icon" href="favicon.svg" type="image/svg+xml">

  <!-- Preconnect & Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet" />

  <!-- Firebase Libraries -->
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-storage-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app-check-compat.js"></script>
  
  <!-- Ensure Firebase is loaded -->
  <script>
    // Wait for Firebase to be available
    function waitForFirebaseGlobal() {
      return new Promise((resolve) => {
        const checkFirebase = () => {
          if (typeof firebase !== 'undefined') {
            console.log('✅ Firebase cargado globalmente');
            resolve();
          } else {
            setTimeout(checkFirebase, 100);
          }
        };
        checkFirebase();
      });
    }
    
    // Make Firebase available globally
    window.waitForFirebaseGlobal = waitForFirebaseGlobal;
  </script>
  
  <!-- Firebase Configuration -->
  <script src="js/firebase-config-enterprise.js"></script>
  
  <!-- App Check Manager -->
  <script src="js/app-check-manager.js"></script>
  <!-- Mobile Menu Component -->
  <script src="js/mobile-menu.js"></script>
  <!-- Skeleton Loader -->
  <script src="js/skeleton-loader.js"></script>
  
  <!-- Open Graph / Twitter -->
  <meta property="og:title" content="TuCitaSegura – Citas seguras sin plantones">
  <meta property="og:description" content="Sistema antidefault con depósito reembolsable y reputación verificada.">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://tusitio.com/">
  <meta property="og:image" content="https://tusitio.com/og.png">
  <meta name="twitter:card" content="summary_large_image">

  <!-- JSON‑LD Product -->
  <script type="application/ld+json">
  {
    "@context":"https://schema.org",
    "@type":"Product",
    "name":"TuCitaSegura – Suscripción mensual",
    "description":"Acceso ilimitado y reputación verificada",
    "brand":{"@type":"Brand","name":"TuCitaSegura"},
    "offers":{"@type":"Offer","priceCurrency":"EUR","price":"30.00","availability":"https://schema.org/InStock"}
  }
  </script>

  <!--
    Recomendado (servidor): Content-Security-Policy como cabecera.
    Ejemplo orientativo:
    Content-Security-Policy:
      default-src 'self';
      script-src 'self' https://www.gstatic.com https://www.google.com https://cdn.tailwindcss.com https://cdnjs.cloudflare.com 'unsafe-inline';
      style-src  'self' 'unsafe-inline' https://fonts.googleapis.com https://cdnjs.cloudflare.com;
      img-src    'self' data:;
      font-src   'self' https://fonts.gstatic.com https://cdnjs.cloudflare.com;
      connect-src 'self' https://firestore.googleapis.com https://identitytoolkit.googleapis.com https://securetoken.googleapis.com https://www.google.com https://www.gstatic.com;
      frame-src  https://www.google.com;
  -->


  <style>
    * { box-sizing: border-box; }
    
    :root {
      --brand-primary: #0f172a;
      --brand-secondary: #1e293b;
      --accent: #0ea5e9;
      --success: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
    }

    body {
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
      color: #e2e8f0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      overflow-x: hidden;
    }

    .gradient-text {
      background: linear-gradient(135deg, #0ea5e9, #06b6d4);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .glass {
      background: rgba(15, 23, 42, 0.8);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .btn-primary {
      background: linear-gradient(135deg, #0ea5e9, #06b6d4);
      color: white;
      border: none;
      border-radius: 0.75rem;
      padding: 0.75rem 1.5rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(14, 165, 233, 0.3);
    }

    .btn-primary:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .btn-secondary {
      background: transparent;
      color: white;
      border: 2px solid rgba(14, 165, 233, 0.5);
      border-radius: 0.75rem;
      padding: 0.75rem 1.5rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-secondary:hover {
      background: rgba(14, 165, 233, 0.1);
      border-color: #0ea5e9;
      transform: translateY(-2px);
    }

    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal-content {
      background: #ffffff;
      color: #1f2937;
      border-radius: 1rem;
      border: 1px solid #e5e7eb;
      padding: 2rem;
      max-width: 520px;
      width: 95%;
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.1);
      animation: slideDown 0.3s ease-out;
      overflow-y: auto;
      max-height: 90vh;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .toast {
      display: none;
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 20px;
      padding: 1rem 1.5rem;
      border-radius: 0.75rem;
      color: white;
      font-weight: 600;
      z-index: 1001;
      animation: slideUp 0.3s ease-out;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateX(-50%) translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }
    }

    .loading {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-top: 2px solid white;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .input-field {
      width: 100%;
      background: rgba(255, 255, 255, 0.06);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 0.75rem;
      padding: 0.75rem;
      color: #e2e8f0;
      font-size: 0.9rem;
    }

    .input-field::placeholder {
      color: rgba(255, 255, 255, 0.4);
    }

    .input-field:focus {
      outline: none;
      border-color: #0ea5e9;
      background: rgba(14, 165, 233, 0.1);
    }

    .tab-active {
      background: #ffffff;
      color: #1f2937;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .tab-inactive {
      background: transparent;
      color: #6b7280; /* gray-600 */
    }

    .success { background: #10b981; }
    .error { background: #ef4444; }
    .warning { background: #f59e0b; }
    .info { background: #0ea5e9; }

    .hidden { display: none !important; }

    .feature-icon {
      width: 60px;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 0.75rem;
      font-size: 1.5rem;
      margin-bottom: 1rem;
    }

    .animate-float {
      animation: float 3s ease-in-out infinite;
    }

    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-10px); }
    }

    /* ----- Improved Design Overrides ----- */
    :root {
      --brand-color: #0F172A;
      --accent-color: #0ea5e9;
      --success-color: #10b981;
    }

    body {
      font-family: 'Inter', system-ui, sans-serif;
      background: linear-gradient(135deg, #0F172A 0%, #1e3a8a 35%, #0369a1 100%);
      overflow-x: hidden;
    }

    .glass {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(16px);
      border: 1px solid rgba(255, 255, 255, 0.12);
    }

    .gradient-text {
      background: linear-gradient(135deg, #7dd3fc, #0ea5e9, #38bdf8);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .btn-primary {
      background: linear-gradient(135deg, #0ea5e9, #0369a1);
      box-shadow: 0 8px 24px rgba(14, 165, 233, 0.2);
      transition: all 0.3s ease;
    }

    .btn-primary:hover {
      background: linear-gradient(135deg, #0284c7, #075985);
      box-shadow: 0 12px 40px rgba(14, 165, 233, 0.35);
      transform: translateY(-2px);
    }

    .feature-card {
      transition: all 0.3s;
      border: 1px solid rgba(255, 255, 255, 0.08);
    }
    .feature-card:hover {
      transform: translateY(-8px);
      border-color: rgba(14, 165, 233, 0.25);
      box-shadow: 0 12px 36px rgba(14, 165, 233, 0.12);
    }

    .hero-bg {
      background:
        radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.22) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.10) 0%, transparent 50%),
        radial-gradient(circle at 40% 40%, rgba(14, 165, 233, 0.10) 0%, transparent 50%);
    }

    /* Modal form overrides for improved design */
    .modal-content .input-field {
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      color: #1f2937;
    }
    .modal-content .input-field::placeholder {
      color: #9ca3af;
    }
    .modal-content .input-field:focus {
      outline: none;
      border-color: #0ea5e9;
      background: #ffffff;
    }

    .modal-content label {
      color: #374151;
    }
    .modal-content small {
      color: #6b7280;
    }
    /* Enlaces desactivados cuando el perfil está incompleto */
    .disabled-link {
      pointer-events: none;
      opacity: 0.6;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <!-- App Check Status Banner -->
  <div id="tcsRecaptchaBanner" class="hidden fixed top-4 right-4 z-50 bg-yellow-500 text-white px-4 py-2 rounded-lg shadow-lg" style="display: none;">
    <span class="font-medium">⚠️ App Check:</span> <span id="tcsRecaptchaBannerText"></span>
  </div>
  <!-- Skip navigation link for screen readers -->
  <a href="#main-content" class="sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 bg-blue-600 text-white px-4 py-2 rounded-md z-50">Saltar al contenido principal</a>
  <!-- Toast Notifications -->
  <div id="toast" class="toast" role="status" aria-live="polite" aria-atomic="true"></div>

  <!-- Banner Perfil Incompleto -->
  <div id="profileIncompleteBanner" class="hidden w-full text-center px-4 py-2 bg-yellow-600/20 border border-yellow-500/50 text-yellow-200 z-40">
    Tu perfil está incompleto. Completa tu perfil para acceder al resto de la aplicación.
    <a href="/perfil.html" class="underline text-yellow-300 ml-2">Ir a mi perfil</a>
  </div>

  <!-- Header / Navigation -->
  <!-- A fixed top navigation bar that stays visible on scroll. It provides quick access to login and registro. -->
  <header class="fixed top-0 left-0 w-full glass backdrop-blur-xl z-50" role="banner">
    <nav class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex items-center justify-between h-16" role="navigation" aria-label="Navegación principal">
      <!-- Brand -->
      <div class="flex items-center gap-2">
        <i class="fas fa-heart-circle-check text-blue-400 text-2xl"></i>
        <span class="text-xl font-bold gradient-text">TuCitaSegura</span>
      </div>
      <!-- Desktop nav actions -->
      <div class="hidden md:flex items-center gap-6" role="menubar">
        <a href="/index.html" class="hover:underline" role="menuitem" aria-label="Ir a página principal">Inicio</a>
        <a href="/index.html?openmodal=1" class="hover:underline" role="menuitem" aria-label="Abrir formulario de registro">Registro</a>
        <a href="/buscar.html?gender=female" class="hover:underline" role="menuitem" aria-label="Buscar chicas">Chicas</a>
        <a href="/buscar.html?gender=male" class="hover:underline" role="menuitem" aria-label="Buscar chicos">Chicos</a>
        <a href="/admin/dashboard.html" class="hover:underline" role="menuitem" aria-label="Panel de administración">Admin</a>
        <button id="navLoginBtn" class="glass px-5 py-2 rounded-full font-semibold hover:bg-white/20 transition-colors" role="menuitem" aria-label="Iniciar sesión">Iniciar Sesión</button>
        <button id="navRegisterBtn" class="btn-primary px-5 py-2 rounded-full font-semibold" role="menuitem" aria-label="Registrarse gratis">Únete Gratis</button>
      </div>
      <!-- Mobile menu button -->
      <div class="md:hidden">
        <button id="mobileMenuBtn" class="text-white hover:text-blue-400 transition-colors" aria-label="Abrir menú de navegación móvil" aria-expanded="false" aria-controls="mobile-menu">
          <i class="fas fa-bars text-xl" aria-hidden="true"></i>
        </button>
      </div>
    </nav>
  </header>

  <!-- Auth Modal -->
  <div id="authModal" class="modal-overlay">
    <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="authModalTitle" tabindex="-1">
      <!-- Header -->
      <div class="flex justify-between items-center mb-6">
        <h2 id="authModalTitle" class="text-2xl font-bold gradient-text">Acceso Seguro</h2>
        <button id="closeModalBtn" class="text-gray-400 hover:text-white transition-colors" aria-label="Cerrar modal">
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>

      <!-- Tabs -->
      <div class="flex gap-2 mb-6 p-1 glass rounded-lg">
        <button id="loginTab" class="flex-1 py-2 px-4 rounded-md font-semibold transition-all tab-active">
          Iniciar Sesión
        </button>
        <button id="registerTab" class="flex-1 py-2 px-4 rounded-md font-semibold transition-all tab-inactive">
          Registrarse
        </button>
      </div>

      <!-- Login Form -->
      <form id="loginForm" class="space-y-4">
        <div>
          <label class="block text-sm font-medium mb-2">Email</label>
          <input 
            id="authEmail" 
            type="email" 
            required 
            placeholder="tu@email.com"
            class="input-field"
            autocomplete="email"
          >
        </div>

        <div>
          <label class="block text-sm font-medium mb-2">Contraseña</label>
          <input 
            id="authPass" 
            type="password" 
            required 
            placeholder="••••••••"
            class="input-field"
            autocomplete="current-password"
          >
        </div>

        <button type="submit" class="btn-primary w-full flex items-center justify-center gap-2">
          <span id="loginBtnText">Entrar</span>
          <span id="loginLoader" class="loading hidden"></span>
        </button>

        <div class="text-center">
          <button type="button" id="forgotPasswordBtn" class="text-blue-400 hover:text-blue-300 text-sm transition-colors">
            ¿Olvidaste tu contraseña?
          </button>
        </div>

        <div id="loginMsg" class="text-center text-sm text-yellow-400"></div>
      </form>


      <!-- Register Form (Hidden by default) -->
      <form id="registerForm" class="space-y-4 hidden">
        <div class="grid grid-cols-2 gap-3">
          <!-- Género: únicamente se permiten dos opciones -->
          <div>
            <label class="block text-sm font-medium mb-2">Género</label>
            <select id="registerGender" class="input-field" required>
              <option value="">Selecciona...</option>
              <option value="male">Masculino</option>
              <option value="female">Femenino</option>
            </select>
            <small class="text-gray-400 text-xs">Se establece al registrarte y no se puede cambiar.</small>
          </div>

          <div>
            <label class="block text-sm font-medium mb-2">Alias</label>
            <input 
              id="registerAlias" 
              type="text" 
              placeholder="Tu nickname"
              class="input-field"
              maxlength="30"
              required
              minlength="5"
            >
            <small class="text-gray-400 text-xs">Tu nombre público. Mínimo 5 letras. No se puede cambiar después.</small>
          </div>
        </div>

        <!-- Email y confirmación -->
        <div>
          <label class="block text-sm font-medium mb-2">Email</label>
          <input 
            id="registerEmail" 
            type="email" 
            required 
            placeholder="tu@email.com"
            class="input-field"
            autocomplete="email"
          >
        </div>

        <div>
          <label class="block text-sm font-medium mb-2">Confirmar Email</label>
          <input 
            id="registerEmailConfirm" 
            type="email" 
            required 
            placeholder="Repite tu email"
            class="input-field"
            autocomplete="email"
          >
        </div>

        <div>
          <label class="block text-sm font-medium mb-2">Contraseña</label>
          <input 
            id="registerPassword" 
            type="password" 
            required 
            minlength="6"
            placeholder="Mín. 6 caracteres"
            class="input-field"
            autocomplete="new-password"
          >
          <small class="text-gray-400 text-xs">Mínimo 6 caracteres</small>
        </div>

        <button type="submit" class="btn-primary w-full flex items-center justify-center gap-2">
          <span id="registerBtnText">Crear cuenta</span>
          <span id="registerLoader" class="loading hidden"></span>
        </button>

        <div id="registerMsg" class="text-center text-sm text-yellow-400"></div>
      </form>

      <!-- Forgot Password Form (Hidden by default) -->
      <form id="forgotForm" class="space-y-4 hidden">
        <p class="text-sm text-gray-300 mb-4">
          Te enviaremos un enlace para restablecer tu contraseña
        </p>

        <div>
          <label class="block text-sm font-medium mb-2">Email</label>
          <input 
            id="forgotEmail" 
            type="email" 
            required 
            placeholder="tu@email.com"
            class="input-field"
            autocomplete="email"
          >
        </div>

        <button type="submit" class="btn-primary w-full flex items-center justify-center gap-2">
          <span id="forgotBtnText">Enviar enlace</span>
          <span id="forgotLoader" class="loading hidden"></span>
        </button>

        <div class="text-center">
          <button type="button" id="backToLoginBtn" class="text-blue-400 hover:text-blue-300 text-sm transition-colors">
            Volver
          </button>
        </div>

        <div id="forgotMsg" class="text-center text-sm text-yellow-400"></div>
      </form>

      <!-- Logout control inside modal (only when authenticated) -->
      <div id="modalLogoutRow" class="mt-6 text-center hidden">
        <button id="modalLogoutBtn" class="text-red-400 hover:text-red-300 text-sm font-semibold">
          <i class="fas fa-sign-out-alt"></i> Cerrar sesión
        </button>
      </div>

      <!-- reCAPTCHA Legal -->
      <div class="mt-6 text-center text-xs text-gray-500">
        <p>Este sitio está protegido por reCAPTCHA y se aplican la 
          <a class="underline" href="https://policies.google.com/privacy" target="_blank" rel="noopener">Política de Privacidad</a> 
          y los 
          <a class="underline" href="https://policies.google.com/terms" target="_blank" rel="noopener">Términos de Servicio</a> 
          de Google.</p>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <main id="main-content" class="min-h-screen flex flex-col items-center justify-center px-4 pt-32 pb-20">
    <div class="max-w-4xl mx-auto">
      <!-- Hero Section -->
      <div class="text-center mb-16 hero-bg">
        <!-- Animated Logo -->
        <div class="mb-8 flex justify-center animate-float">
          <div class="text-6xl md:text-7xl">
            <i class="fas fa-heart-circle-check text-blue-400"></i>
          </div>
        </div>

        <!-- Title -->
        <h1 class="text-5xl md:text-7xl font-black mb-6 gradient-text">
          TuCitaSegura
        </h1>

        <!-- Subtitle -->
        <p class="text-2xl md:text-3xl text-gray-300 mb-4 font-semibold">
          Citas seguras sin plantones
        </p>

        <!-- Description -->
        <p class="text-lg text-gray-400 mb-8 max-w-2xl mx-auto leading-relaxed">
          La única plataforma de citas con <span class="text-blue-300 font-semibold">sistema antidefault</span>, 
          <span class="text-emerald-300 font-semibold">reputación verificada</span> y 
          <span class="text-pink-300 font-semibold">acceso ilimitado por 30€/mes</span>.
        </p>
        
        <!-- Badge -->
        <div class="inline-flex items-center gap-2 px-4 py-3 rounded-full bg-emerald-600/20 border border-emerald-600/50 text-emerald-400 font-semibold">
          <i class="fas fa-shield-check"></i>
          <span>Depósito reembolsable de 120€</span>
        </div>
      </div>

      <!-- Features Grid -->
      <div class="grid md:grid-cols-2 gap-6 mb-16">
        <!-- Feature 1 -->
        <div class="glass feature-card rounded-2xl p-8 hover:border-blue-400/50 transition-all">
          <div class="feature-icon bg-blue-500/20">
            <i class="fas fa-lock text-blue-400"></i>
          </div>
          <h3 class="text-xl font-bold mb-3">Sistema Antidefault</h3>
          <p class="text-gray-400 text-sm leading-relaxed">
            Depósito de 120€ reembolsable automáticamente cuando ambos usuarios validan la cita con doble PIN seguro.
          </p>
        </div>

        <!-- Feature 2 -->
        <div class="glass feature-card rounded-2xl p-8 hover:border-yellow-400/50 transition-all">
          <div class="feature-icon bg-yellow-500/20">
            <i class="fas fa-medal text-yellow-400"></i>
          </div>
          <h3 class="text-xl font-bold mb-3">Reputación Verificada</h3>
          <p class="text-gray-400 text-sm leading-relaxed">
            Niveles Oro, Plata y Bronce basados en comportamiento real. Mejores matches con usuarios de mayor reputación.
          </p>
        </div>

        <!-- Feature 3 -->
        <div class="glass feature-card rounded-2xl p-8 hover:border-pink-400/50 transition-all">
          <div class="feature-icon bg-pink-500/20">
            <i class="fas fa-comments text-pink-400"></i>
          </div>
          <h3 class="text-xl font-bold mb-3">Chat Seguro</h3>
          <p class="text-gray-400 text-sm leading-relaxed">
            Mensajería privada con verificación de identidad y opciones de privacidad avanzadas para mayor seguridad.
          </p>
        </div>

        <!-- Feature 4 -->
        <div class="glass feature-card rounded-2xl p-8 hover:border-cyan-400/50 transition-all">
          <div class="feature-icon bg-cyan-500/20">
            <i class="fas fa-credit-card text-cyan-400"></i>
          </div>
          <h3 class="text-xl font-bold mb-3">Pagos Seguros</h3>
          <p class="text-gray-400 text-sm leading-relaxed">
            Suscripción mensual con Stripe y PayPal. Encriptación SSL y sin almacenar datos de tarjeta.
          </p>
        </div>
      </div>

      <!-- CTA Section -->
      <div class="text-center mb-12">
        <p class="text-gray-400 mb-6 text-sm">¿Listo para encontrar tu pareja ideal?</p>
        <div class="flex flex-col sm:flex-row gap-4 justify-center">
          <button id="heroLoginBtn" class="btn-primary px-10 py-4 rounded-xl text-lg font-semibold flex items-center justify-center gap-2 transform hover:scale-105 transition-transform">
            <i class="fas fa-sign-in-alt"></i>
            Iniciar Sesión
          </button>
          
          <button id="heroRegisterBtn" class="btn-secondary px-10 py-4 rounded-xl text-lg font-semibold flex items-center justify-center gap-2">
            <i class="fas fa-heart"></i>
            Unirme Gratis
          </button>
        </div>
      </div>

      <!-- Trust Section -->
      <div class="glass rounded-2xl p-8 text-center">
        <div class="flex items-center justify-center gap-3 mb-4">
          <i class="fas fa-check-circle text-green-400 text-2xl"></i>
          <h3 class="text-lg font-semibold">reCAPTCHA v3 Activo</h3>
        </div>
        <p class="text-gray-400 text-sm">
          Protección contra bots automática y análisis de comportamiento. Tus datos están encriptados y seguros.
        </p>
        <p class="text-xs text-gray-500 mt-3">
          Cumple con RGPD • Protegido por reCAPTCHA • SSL 256-bit
        </p>
      </div>

      <!-- How It Works Section -->
      <section id="howItWorks" class="py-20">
        <div class="text-center mb-16">
          <h2 class="text-4xl md:text-5xl font-black mb-6">¿Cómo funciona?</h2>
          <p class="text-gray-400 text-lg max-w-2xl mx-auto">Comienza a tener citas sin plantones en 3 simples pasos.</p>
        </div>
        <div class="grid md:grid-cols-3 gap-8">
          <div class="glass rounded-2xl p-8 text-center">
            <div class="mx-auto mb-4 flex items-center justify-center w-12 h-12 rounded-full bg-blue-500/20 text-blue-400 text-2xl font-bold">1</div>
            <h3 class="text-xl font-semibold mb-3">Regístrate y verifica tu perfil</h3>
        <p class="text-gray-400 text-sm leading-relaxed">Crea tu cuenta, elige tu género y alias, y verifica tu correo electrónico para comenzar a usar la plataforma.</p>
          </div>
          <div class="glass rounded-2xl p-8 text-center">
            <div class="mx-auto mb-4 flex items-center justify-center w-12 h-12 rounded-full bg-yellow-500/20 text-yellow-400 text-2xl font-bold">2</div>
            <h3 class="text-xl font-semibold mb-3">Realiza un depósito y encuentra match</h3>
            <p class="text-gray-400 text-sm leading-relaxed">Deposita 120€ (reembolsables) para activar el sistema antidefault y comienza a chatear con personas de reputación verificada.</p>
          </div>
          <div class="glass rounded-2xl p-8 text-center">
            <div class="mx-auto mb-4 flex items-center justify-center w-12 h-12 rounded-full bg-emerald-500/20 text-emerald-400 text-2xl font-bold">3</div>
            <h3 class="text-xl font-semibold mb-3">Confirma la cita y recupera tu depósito</h3>
            <p class="text-gray-400 text-sm leading-relaxed">Cuando ambos asistáis a la cita y verifiquéis el PIN, recuperáis el depósito automáticamente y valoráis la experiencia.</p>
          </div>
        </div>
      </section>

      <!-- Pricing Section -->
      <section id="pricing" class="py-20">
        <div class="text-center mb-12">
          <h2 class="text-4xl md:text-5xl font-black mb-6">Precios transparentes</h2>
          <p class="text-gray-400 text-lg max-w-2xl mx-auto">Accede ilimitadamente por solo 30 €/mes con nuestro depósito reembolsable.</p>
        </div>
        <div class="max-w-xl mx-auto">
          <div class="glass rounded-2xl p-8 text-center">
            <h3 class="text-3xl font-bold mb-4">30 € / mes</h3>
            <p class="text-gray-400 mb-6">Suscripción mensual con chat ilimitado, reputación verificada y sistema antidefault.</p>
            <ul class="text-left text-gray-400 mb-6 space-y-2">
              <li class="flex items-center"><i class="fas fa-check-circle text-emerald-400 mr-2"></i><span>Depósito reembolsable de 120€</span></li>
              <li class="flex items-center"><i class="fas fa-check-circle text-emerald-400 mr-2"></i><span>Verificación de identidad y reputación</span></li>
              <li class="flex items-center"><i class="fas fa-check-circle text-emerald-400 mr-2"></i><span>Acceso a matches ilimitados</span></li>
            </ul>
            <button id="pricingRegisterBtn" class="btn-primary px-8 py-3 rounded-xl flex items-center justify-center gap-2">
              <i class="fas fa-heart"></i>
              Empieza ahora
            </button>
          </div>
        </div>
      </section>

    </div>
  </main>

  <!-- Profile Section (hidden by default) -->
  <section id="profileSection" class="hidden min-h-screen flex-col items-center justify-center px-4 py-20">
    <div class="glass rounded-2xl p-8 max-w-xl w-full">
      <h2 class="text-3xl font-bold mb-4 gradient-text">Mi Perfil</h2>
      <div class="space-y-3 mb-6">
        <div><span class="font-semibold">Email:</span> <span id="profileEmail" class="ml-2">—</span></div>
        <div><span class="font-semibold">Alias:</span> <span id="profileAlias" class="ml-2">—</span></div>
        <div><span class="font-semibold">Género:</span> <span id="profileGender" class="ml-2">—</span></div>
        <div><span class="font-semibold">Verificación de email:</span> <span id="profileVerified" class="ml-2">—</span></div>
      </div>
      <!-- Alias y género son fijos; no se editan desde aquí -->
      <div class="flex flex-col sm:flex-row gap-4 mb-4">
        <button id="verifyEmailBtn" class="btn-primary flex-1 hidden items-center justify-center gap-2">
          <i class="fas fa-envelope"></i> Verificar Email
        </button>
      </div>
      <p id="profileMessage" class="text-center text-sm text-yellow-400"></p>
    </div>
  </section>

  <!-- Footer -->
  <footer class="py-8 text-center text-xs text-gray-500">
    <p>&copy; 2025 TuCitaSegura. Todos los derechos reservados.</p>
  </footer>

  <!-- Firebase & reCAPTCHA Logic -->
  <script>
    // Wait for Firebase to be ready and use global objects
    function waitForFirebase() {
      return new Promise((resolve) => {
        if (typeof firebase !== 'undefined' && window.firebaseConfig) {
          resolve(window.firebaseConfig);
        } else {
          const checkInterval = setInterval(() => {
            if (typeof firebase !== 'undefined' && window.firebaseConfig) {
              clearInterval(checkInterval);
              resolve(window.firebaseConfig);
            }
          }, 100);
          
          // Timeout after 10 seconds
          setTimeout(() => {
            clearInterval(checkInterval);
            console.error('❌ Firebase no se cargó en el tiempo esperado');
            resolve(null);
          }, 10000);
        }
      });
    }

    // Initialize Firebase functionality
    async function initializeApp() {
      const firebaseConfig = await waitForFirebase();
      if (!firebaseConfig) {
        console.error('❌ No se pudo cargar Firebase');
        return;
      }

      const { auth, db } = firebaseConfig;
      
      console.log("✅ Firebase listo vía objetos globales");

    // Perfil incompleto: desactivar enlaces y mostrar banner
    const profileIncompleteBanner = document.getElementById("profileIncompleteBanner");
    function setProfileLinkRestrictions(restrict) {
      const isPreview = (() => { try { return new URLSearchParams(location.search).get('preview') === '1'; } catch { return false; } })();
      if (isPreview) {
        // En vista previa no se bloquea nada y se oculta el banner
        profileIncompleteBanner.classList.add('hidden');
        return;
      }
      try {
        if (restrict) {
          profileIncompleteBanner.classList.remove("hidden");
        } else {
          profileIncompleteBanner.classList.add("hidden");
        }

        const anchors = Array.from(document.querySelectorAll('a[href]'));
        anchors.forEach(a => {
          const href = (a.getAttribute('href') || '').trim();
          const isExternal = href.startsWith('http') || href.startsWith('mailto:') || href.startsWith('tel:');
          if (!isExternal && !href.startsWith('#') && href !== '/' && href !== '/index.html' && href !== '/perfil.html') {
            a.style.pointerEvents = restrict ? 'none' : 'auto';
            a.style.opacity = restrict ? '0.5' : '1';
          }
        });
      } catch (e) {
        console.warn("Error al restringir enlaces:", e);
      }
    }

    function onBlockedLinkClick(e) {
      e.preventDefault();
      showToast('Tu perfil está incompleto. Ve a tu perfil para continuar.', 'warning');
    }

    // DOM Elements
    const authModal = document.getElementById("authModal");
    const closeModalBtn = document.getElementById("closeModalBtn");
    const loginTab = document.getElementById("loginTab");
    const registerTab = document.getElementById("registerTab");
    const loginForm = document.getElementById("loginForm");
    const registerForm = document.getElementById("registerForm");
    const forgotForm = document.getElementById("forgotForm");
    const authEmail = document.getElementById("authEmail");
    const authPass = document.getElementById("authPass");
    const loginBtnText = document.getElementById("loginBtnText");
    const loginLoader = document.getElementById("loginLoader");
    const registerBtnText = document.getElementById("registerBtnText");
    const registerLoader = document.getElementById("registerLoader");
    const forgotBtnText = document.getElementById("forgotBtnText");
    const forgotLoader = document.getElementById("forgotLoader");
    const loginMsg = document.getElementById("loginMsg");
    const registerMsg = document.getElementById("registerMsg");
    const forgotMsg = document.getElementById("forgotMsg");
    const toast = document.getElementById("toast");
    const heroLoginBtn = document.getElementById("heroLoginBtn");
    const heroRegisterBtn = document.getElementById("heroRegisterBtn");
    const forgotPasswordBtn = document.getElementById("forgotPasswordBtn");
    const backToLoginBtn = document.getElementById("backToLoginBtn");

    // New header and pricing buttons
    const navLoginBtn = document.getElementById("navLoginBtn");
    const navRegisterBtn = document.getElementById("navRegisterBtn");
    const pricingRegisterBtn = document.getElementById("pricingRegisterBtn");

    // Profile DOM Elements
    const profileSection = document.getElementById("profileSection");
    const profileEmail = document.getElementById("profileEmail");
    const profileAlias = document.getElementById("profileAlias");
    const profileGender = document.getElementById("profileGender");
    const profileVerified = document.getElementById("profileVerified");
    const verifyEmailBtn = document.getElementById("verifyEmailBtn");
    // Modal logout controls
    const modalLogoutRow = document.getElementById("modalLogoutRow");
    const modalLogoutBtn = document.getElementById("modalLogoutBtn");
    const profileMessage = document.getElementById("profileMessage");

    // reCAPTCHA Site Key
  const RECAPTCHA_SITE_KEY = "6LfdTvQrAAAAACkGjvbbFIkqHMsTHwRYYZS_CGq2";
  // Simplicidad: usar reCAPTCHA v3 siempre (compatible con backend /siteverify)
  const RECAPTCHA_PROVIDER = 'v3';
    // Modo preview: desactiva reCAPTCHA y valida localmente
    const isPreview = (() => { 
      try { 
        const sp = new URLSearchParams(location.search); 
        return sp.get('preview') === '1' || sp.has('ide_webview_request_time'); 
      } catch { 
        return false; 
      } 
    })();
    // Forzar reCAPTCHA incluso en entorno local/preview
    const forceCaptcha = (() => {
      try { return new URLSearchParams(location.search).get('forcecaptcha') === '1'; }
      catch { return false; }
    })();
    const host = location.hostname || '';
    const isProdHost = /\.web\.app$/.test(host) || /\.firebaseapp\.com$/.test(host) || host === 'tucitasegura.com' || host === 'www.tucitasegura.com';

    // Utility Functions
    // showToast importado desde /js/utils.js

    let lastActiveEl = null;
    let trapFocusCleanup = null;
    function trapFocus(modalEl) {
      function onKey(e) {
        const focusables = modalEl.querySelectorAll(
          'a[href],button:not([disabled]),input,select,textarea,[tabindex]:not([tabindex="-1"])'
        );
        if (!focusables.length) return;
        const first = focusables[0];
        const last  = focusables[focusables.length - 1];
        if (e.key === "Tab") {
          if (e.shiftKey && document.activeElement === first) { last.focus(); e.preventDefault(); }
          else if (!e.shiftKey && document.activeElement === last) { first.focus(); e.preventDefault(); }
        } else if (e.key === "Escape") {
          hideAuthModal();
        }
      }
      authModal.addEventListener("keydown", onKey);
      return () => authModal.removeEventListener("keydown", onKey);
    }

    function showAuthModal() {
      lastActiveEl = document.activeElement;
      authModal.classList.add("active");
      document.body.style.overflow = "hidden";
      showLoginForm();
      const dialog = authModal.querySelector(".modal-content");
      trapFocusCleanup = trapFocus(dialog);
      // Toggle logout inside modal only if user is authenticated
      try {
        if (auth.currentUser) {
          modalLogoutRow.classList.remove("hidden");
        } else {
          modalLogoutRow.classList.add("hidden");
        }
      } catch {}
      setTimeout(() => {
        const first = dialog.querySelector('input, select, button, [tabindex]:not([tabindex="-1"])');
        first?.focus();
      }, 0);
    }

    function hideAuthModal() {
      authModal.classList.remove("active");
      document.body.style.overflow = "auto";
      trapFocusCleanup?.();
      lastActiveEl?.focus();
    }

    function showLoginForm() {
      loginForm.classList.remove("hidden");
      registerForm.classList.add("hidden");
      forgotForm.classList.add("hidden");
      loginTab.classList.add("tab-active");
      loginTab.classList.remove("tab-inactive");
      registerTab.classList.remove("tab-active");
      registerTab.classList.add("tab-inactive");
    }

    function showRegisterForm() {
      registerForm.classList.remove("hidden");
      loginForm.classList.add("hidden");
      forgotForm.classList.add("hidden");
      registerTab.classList.add("tab-active");
      registerTab.classList.remove("tab-inactive");
      loginTab.classList.remove("tab-active");
      loginTab.classList.add("tab-inactive");
    }

    function showForgotForm() {
      forgotForm.classList.remove("hidden");
      loginForm.classList.add("hidden");
      registerForm.classList.add("hidden");
    }

    // Show profile section and populate user details
    async function showProfileSectionFn() {
      // hide main content
      document.querySelector("main").classList.add("hidden");
      profileSection.classList.remove("hidden");
      profileSection.classList.add("flex");
      const user = auth.currentUser;
      if (!user) return;
      // set basic info
      profileEmail.textContent = user.email;
      profileVerified.textContent = user.emailVerified ? "Verificado" : "No verificado";
      // toggle verify button
      if (user.emailVerified) {
        verifyEmailBtn.classList.add("hidden");
      } else {
        verifyEmailBtn.classList.remove("hidden");
      }
      // fetch extra info
      try {
        const userDoc = await firebase.firestore.getDoc(firebase.firestore.doc(db, "users", user.uid));
        if (userDoc.exists()) {
          const data = userDoc.data();
          profileAlias.textContent = data.alias || "—";
          profileGender.textContent = data.gender === "male" ? "Masculino" : (data.gender === "female" ? "Femenino" : "—");
          // Alias y género no se eligen ni editan; si faltan, mostrar "—"
        }
      } catch (e) {
        console.error("Error al obtener datos del usuario", e);
      }
    }

    function hideProfileSectionFn() {
      profileSection.classList.add("hidden");
      profileSection.classList.remove("flex");
      document.querySelector("main").classList.remove("hidden");
    }

    
    function shouldSkipCaptcha() {
      try {
        const sp = new URLSearchParams(location.search);
        const metaDisableEl = document.querySelector('meta[name="recaptcha:disable"]');
        const metaDisabled = !!(metaDisableEl && (metaDisableEl.getAttribute('content') || '').toLowerCase() === 'true');
        // Único switch opcional: ?nocaptcha=1 o meta disable
        return sp.get('nocaptcha') === '1' || metaDisabled;
      } catch {
        return false;
      }
    }

    // Carga dinámica del script de reCAPTCHA sólo si no se salta
    async function loadRecaptchaScript() {
      if (shouldSkipCaptcha()) return;
      try {
        await new Promise((resolve) => {
          const s = document.createElement('script');
          s.src = `https://www.google.com/recaptcha/api.js?render=${RECAPTCHA_SITE_KEY}`;
          s.async = true;
          s.onload = resolve;
          s.onerror = () => { console.warn('reCAPTCHA bloqueado/abortado; continuando sin bloquear'); resolve(); };
          document.head.appendChild(s);
        });
      } catch (e) {
        try { console.debug('Error cargando reCAPTCHA', e); } catch {}
      }
    }
    // Iniciar carga en background
    loadRecaptchaScript();

    async function getRecaptchaToken(action = "submit") {
      if (shouldSkipCaptcha()) {
        return `skip-${action}-token`;
      }
      if (window.grecaptcha && typeof grecaptcha.ready === 'function') {
        await new Promise(resolve => grecaptcha.ready(resolve));
        if (RECAPTCHA_PROVIDER === 'enterprise' && grecaptcha.enterprise && typeof grecaptcha.enterprise.execute === 'function') {
          return grecaptcha.enterprise.execute(RECAPTCHA_SITE_KEY, { action });
        }
        if (typeof grecaptcha.execute === 'function') {
          return grecaptcha.execute(RECAPTCHA_SITE_KEY, { action });
        }
      }
      // Si reCAPTCHA no está disponible, no bloquear flujo: devolver token de fallback
      console.warn('reCAPTCHA no disponible, usando token de fallback');
      return `fallback-${action}-token`;
    }

    // Verificación real en tu backend
    async function assertHuman(action) {
      if (shouldSkipCaptcha()) {
        return { success: true, action, score: 0.9, skipped: true };
      }
      try {
        const token = await getRecaptchaToken(action);
        const r = await fetch("/api/verify-recaptcha", {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify({ token, action })
        });
        const data = await r.json().catch(() => ({}));
        // Umbral laxo para evitar falsos negativos
        const scoreOk = typeof data.score !== "number" ? true : data.score >= 0.1;
        if (!data.success || data.action !== action || !scoreOk) {
          // No bloquear: registrar y continuar en modo degradado
          console.warn('reCAPTCHA verificación no pasó, continuando en modo degradado', data);
          return { success: true, action, degraded: true, data };
        }
        return data;
      } catch (error) {
        console.warn('reCAPTCHA fallo en verificación, continuando', error);
        // No bloquear login/registro si reCAPTCHA falla por red/extensiones
        return { success: true, action, degraded: true, error: String(error && error.message || error) };
      }
    }

    // Redirección post-autenticación según perfil
    async function afterAuthRedirect(user) {
      try {
        const snap = await firebase.firestore.getDoc(firebase.firestore.doc(db, "users", user.uid));
        const data = snap.exists() ? snap.data() : {};
        const dest = !data.profileComplete ? "/perfil.html" : "/";
        location.href = dest;
      } catch (e) {
        console.error("Redirección post-auth falló", e);
      }
    }

    // Auth Functions
    async function handleLogin(email, password) {
      try {
        loginLoader.classList.remove("hidden");
        loginBtnText.textContent = "Verificando...";

        await assertHuman("login");

        const cred = await firebase.auth.signInWithEmailAndPassword(auth, email, password);

        loginMsg.textContent = "✅ Login exitoso";
        showToast("¡Bienvenido de nuevo!", "success");

        setTimeout(async () => {
          hideAuthModal();
          await afterAuthRedirect(cred.user);
        }, 1000);

      } catch (error) {
        console.error("Error:", error);
        let msg = "Error al iniciar sesión";
        
        if (error.code === "auth/user-not-found") msg = "Usuario no encontrado";
        else if (error.code === "auth/wrong-password") msg = "Contraseña incorrecta";
        else if (error.code === "auth/invalid-email") msg = "Email inválido";
        else if (error.code === "auth/too-many-requests") msg = "Demasiados intentos";

        loginMsg.textContent = "❌ " + msg;
        showToast(msg, "error");

      } finally {
        loginLoader.classList.add("hidden");
        loginBtnText.textContent = "Entrar";
      }
    }


    async function handleRegister(email, password, gender, alias) {
      try {
        registerLoader.classList.remove("hidden");
        registerBtnText.textContent = "Creando...";

        await assertHuman("register");

        const cred = await firebase.auth.createUserWithEmailAndPassword(auth, email, password);

        await firebase.firestore.setDoc(firebase.firestore.doc(db, "users", cred.user.uid), {
          email: email,
          gender: gender,
          alias: alias,
          createdAt: firebase.firestore.serverTimestamp(),
          reputation: 0,
          level: "Oro",
          stats: { citas: 0, defaults: 0 },
          lastLogin: firebase.firestore.serverTimestamp(),
          // Como alias y género se piden en el registro, el perfil queda completo
          profileComplete: true
        });

        // Crear documento privado inicial
        try {
          await firebase.firestore.setDoc(firebase.firestore.doc(db, "users_private", cred.user.uid), {
            phoneVerified: false,
            createdAt: firebase.firestore.serverTimestamp(),
            updatedAt: firebase.firestore.serverTimestamp()
          });
        } catch (e) {
          console.warn("No se pudo crear users_private inicial", e);
        }

        // Envía un correo de verificación
        try {
          await firebase.auth.sendEmailVerification(cred.user);
          console.log("✅ Email de verificación enviado a", email);
        } catch (e) {
          console.error("Error enviando email de verificación", e);
        }

        registerMsg.textContent = "✅ Cuenta creada. Revisa tu email para verificar tu cuenta.";
        showToast("¡Cuenta creada! Verifica tu email antes de acceder al perfil.", "success");

        // Da tiempo para mostrar el mensaje y luego redirige
        setTimeout(async () => {
          hideAuthModal();
          await afterAuthRedirect(cred.user);
        }, 2000);
  
      } catch (error) {
        console.error("Error:", error);
        let msg = "Error al crear cuenta";

        if (error.code === "auth/email-already-in-use") msg = "Email ya registrado";
        else if (error.code === "auth/weak-password") msg = "Contraseña débil (mín. 6 caracteres)";
        else if (error.code === "auth/invalid-email") msg = "Email inválido";

        registerMsg.textContent = "❌ " + msg;
        showToast(msg, "error");

      } finally {
        registerLoader.classList.add("hidden");
        registerBtnText.textContent = "Crear cuenta";
      }
    }

    async function handleForgotPassword(email) {
      try {
        forgotLoader.classList.remove("hidden");
        forgotBtnText.textContent = "Enviando...";

        await assertHuman("forgot_password");
        await firebase.auth.sendPasswordResetEmail(auth, email);

        forgotMsg.textContent = "✅ Email enviado";
        showToast("Revisa tu email para restablecer contraseña", "success");

        setTimeout(() => {
          showLoginForm();
        }, 2000);

      } catch (error) {
        console.error("Error:", error);
        let msg = "Error al enviar email";

        if (error.code === "auth/user-not-found") msg = "Usuario no encontrado";
        else if (error.code === "auth/invalid-email") msg = "Email inválido";

        forgotMsg.textContent = "❌ " + msg;
        showToast(msg, "error");

      } finally {
        forgotLoader.classList.add("hidden");
        forgotBtnText.textContent = "Enviar enlace";
      }
    }

    // Event Listeners
    // heroLoginBtn will be configured in onAuthStateChanged depending on auth status
    heroRegisterBtn.addEventListener("click", () => {
      showAuthModal();
      showRegisterForm();
    });

    // Top navigation events (initial behaviours)
    if (navLoginBtn) {
      navLoginBtn.addEventListener("click", () => {
        showAuthModal();
        showLoginForm();
      });
    }
    if (navRegisterBtn) {
      navRegisterBtn.addEventListener("click", () => {
        showAuthModal();
        showRegisterForm();
      });
    }
    if (pricingRegisterBtn) {
      pricingRegisterBtn.addEventListener("click", () => {
        showAuthModal();
        showRegisterForm();
      });
    }

    closeModalBtn.addEventListener("click", hideAuthModal);
    loginTab.addEventListener("click", showLoginForm);
    registerTab.addEventListener("click", showRegisterForm);
    forgotPasswordBtn.addEventListener("click", showForgotForm);
    backToLoginBtn.addEventListener("click", showLoginForm);

    // Abrir modal automáticamente para depuración si ?openmodal=1
    try {
      const sp = new URLSearchParams(location.search);
      if (sp.get('openmodal') === '1') {
        showAuthModal();
        showRegisterForm();
      }
    } catch {}

    // Perfil: enviar email de verificación y cerrar sesión
    verifyEmailBtn.addEventListener("click", async () => {
      const user = auth.currentUser;
      if (!user) return;
      try {
        await firebase.auth.sendEmailVerification(user);
        profileMessage.textContent = "✅ Email de verificación enviado. Revisa tu bandeja de entrada.";
        profileMessage.classList.remove("text-red-400");
        profileMessage.classList.add("text-green-400");
      } catch (e) {
        console.error("Error enviando verificación", e);
        profileMessage.textContent = "❌ No se pudo enviar el email de verificación";
        profileMessage.classList.remove("text-green-400");
        profileMessage.classList.add("text-red-400");
      }
    });

    // Logout from inside modal
    modalLogoutBtn.addEventListener("click", async () => {
      try {
        await firebase.auth.signOut(auth);
        hideAuthModal();
        hideProfileSectionFn();
        showToast("Sesión cerrada", "info");
      } catch (e) {
        console.error("Error al cerrar sesión", e);
      }
    });

    // Form Submissions
    loginForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const email = authEmail.value.trim();
      const password = authPass.value;

      if (!email || !password) {
        showToast("Completa todos los campos", "warning");
        return;
      }

      await handleLogin(email, password);
    });

    registerForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const email = document.getElementById("registerEmail").value.trim();
      const emailConfirm = document.getElementById("registerEmailConfirm").value.trim();
      const password = document.getElementById("registerPassword").value;
      const gender = document.getElementById("registerGender").value;
      const alias = document.getElementById("registerAlias").value.trim();

      if (!email || !password || !gender || !alias) {
        showToast("Completa los campos requeridos", "warning");
        return;
      }
      // Verificar que ambos emails coinciden
      if (email !== emailConfirm) {
        registerMsg.textContent = "❌ Los emails no coinciden";
        showToast("Los emails no coinciden", "error");
        return;
      }
      // Validación de alias: mínimo 5 letras
      const letterCount = (alias.match(/[A-Za-zÁÉÍÓÚÑáéíóúñ]/g) || []).length;
      if (alias.length < 5 || letterCount < 5) {
        registerMsg.textContent = "❌ Alias demasiado corto (mínimo 5 letras)";
        showToast("Alias mínimo 5 letras", "warning");
        return;
      }

      await handleRegister(email, password, gender, alias);
    });

    forgotForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const email = document.getElementById("forgotEmail").value.trim();

      if (!email) {
        showToast("Ingresa tu email", "warning");
        return;
      }

      await handleForgotPassword(email);
    });

    // Listen to auth changes
    firebase.auth.onAuthStateChanged(auth, (user) => {
      if (user) {
        console.log("✅ Usuario autenticado:", user.email);
        heroLoginBtn.textContent = "Mi Perfil";
        // Redirigir directamente a la página de perfil
        heroLoginBtn.onclick = () => { location.href = "/perfil.html"; };

        // Actualizar navegación: mostrar "Mi Perfil" y ocultar registro
        if (navLoginBtn) {
          navLoginBtn.textContent = "Mi Perfil";
          // Redirigir a la página de perfil para evitar mostrar el cuadro inline
          navLoginBtn.onclick = () => { location.href = "/perfil.html"; };
        }
        if (navRegisterBtn) {
          navRegisterBtn.classList.add("hidden");
        }

        // Consultar profileComplete y aplicar restricciones de enlaces
        (async () => {
          try {
            const snap = await firebase.firestore.getDoc(firebase.firestore.doc(db, 'users', user.uid));
            const data = snap.exists() ? snap.data() : {};
            const incomplete = !data.profileComplete;
            setProfileLinkRestrictions(incomplete);
          } catch (e) {
            console.error('Error obteniendo profileComplete', e);
            setProfileLinkRestrictions(false);
          }
        })();
      } else {
        // Si no está autenticado, el botón abre el modal de login
        heroLoginBtn.textContent = "Iniciar Sesión";
        heroLoginBtn.onclick = showAuthModal;

        // Restablecer navegación cuando no hay usuario
        if (navLoginBtn) {
          navLoginBtn.textContent = "Iniciar Sesión";
          navLoginBtn.onclick = showAuthModal;
        }
        if (navRegisterBtn) {
          navRegisterBtn.classList.remove("hidden");
          navRegisterBtn.onclick = () => {
            showAuthModal();
            showRegisterForm();
          };
        }

        // Sin usuario: no restringir enlaces
        setProfileLinkRestrictions(false);
      }
    });

    // Close on ESC
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") hideAuthModal();
    });

    // reCAPTCHA Ready
    if (!shouldSkipCaptcha() && window.grecaptcha && typeof grecaptcha.ready === 'function') {
      grecaptcha.ready(() => {
        const label = RECAPTCHA_PROVIDER === 'enterprise' ? 'Enterprise' : 'v3';
        console.log(`✅ reCAPTCHA ${label} listo`);
      });
    } else {
      console.log("ℹ️ reCAPTCHA desactivado en modo preview");
    }

    // Show toast notification function
    function showToast(message, type = 'info') {
      const toast = document.getElementById('toast');
      if (toast) {
        toast.textContent = message;
        toast.className = `toast ${type}`;
        toast.classList.add('show');
        setTimeout(() => {
          toast.classList.remove('show');
        }, 3000);
      } else {
        console.log(`Toast: ${message}`);
      }
    }

    // Initialize the app
    initializeApp();
  </script>
  <!-- Guardia de sesión/perfil/teléfono: redirige usuarios autenticados sin phoneVerified -->
  <script src="./js/guards.js"></script>
  <script>
    async function diagnoseAppCheck(banner) {
      try {
        const auth = window.firebaseAuth;
        if (!auth) {
          banner.innerHTML = '⚠️ <b>App Check</b>: Firebase no está disponible.';
          return;
        }
        
        const token = (localStorage.getItem('firebaseAppCheckDebugToken') || (typeof self.FIREBASE_APPCHECK_DEBUG_TOKEN === 'string' ? self.FIREBASE_APPCHECK_DEBUG_TOKEN : '')).trim();
        if (!token) {
          banner.innerHTML = '⚠️ <b>App Check</b>: sin token de depuración. Genera y registra uno en Firebase Console y recarga con <code>?debugtoken=EL_TOKEN</code>.';
          return;
        }
        const appId = auth.app.options.appId;
        const projectId = auth.app.options.projectId;
        const apiKey = auth.app.options.apiKey;
        const url = `https://content-firebaseappcheck.googleapis.com/v1/projects/${encodeURIComponent(projectId)}/apps/${encodeURIComponent(appId)}:exchangeDebugToken?key=${encodeURIComponent(apiKey)}`;
        const res = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ debug_token: token })
        });
        const text = await res.text();
        if (res.ok) {
          // Oculta el banner si el intercambio fue exitoso
          banner.style.display = 'none';
          return;
        } else {
          let json; try { json = JSON.parse(text); } catch {}
          const apiMsg = (json && json.error && json.error.message) ? json.error.message : (text || '');
          let message = '';
          if (res.status === 403) {
            if (/UNREGISTERED|NOT_REGISTERED|NOT ALLOWED|DEBUG_TOKEN/i.test(apiMsg)) {
              message = 'Token de depuración no registrado para esta app. Añádelo en Firebase Console → App Check → Debug Tokens.';
            } else if (/API key|referer|restricted/i.test(apiMsg)) {
              message = 'API key restringida para App Check o dominio. Ajusta restricciones en Google Cloud Console.';
            } else {
              message = 'Token rechazado (403). Registra el token y revisa restricciones de API key.';
            }
          } else if (res.status === 404) {
            message = 'App/Proyecto no encontrados (404). Verifica <code>appId</code> y <code>projectId</code>.';
          } else {
            message = `Error ${res.status}. ${apiMsg}`;
          }
          banner.innerHTML = `⚠️ <b>App Check</b>: ${message}`;
        }
      } catch (e) {
        banner.innerHTML = '⚠️ <b>App Check</b>: no se pudo diagnosticar. Revisa conexión/CSP.';
      }
    }

    (async () => {
      const banner = document.getElementById('tcsRecaptchaBanner');
      if (!banner) {
        console.warn('Banner de App Check no encontrado');
        return;
      }
      
      let show = false;
      try {
        const ready = globalThis.__appCheckReady;
        if (!ready || typeof ready.then !== 'function') {
          show = true;
        } else {
          const token = await Promise.race([
            ready,
            new Promise(resolve => setTimeout(() => resolve(null), 3000))
          ]);
          if (!token || (token.length || 0) < 10) show = true;
        }
      } catch (error) {
        show = true;
      }
      if (show) {
        banner.style.display = 'block';
        diagnoseAppCheck(banner);
      }
    })();
  </script>
  <script>
    // Wait for Firebase to load
    function waitForFirebase() {
      return new Promise(resolve => {
        if (typeof firebase !== 'undefined') resolve();
        else {
          const checkInterval = setInterval(() => {
            if (typeof firebase !== 'undefined') {
              clearInterval(checkInterval);
              resolve();
            }
          }, 100);
          // Timeout after 10 seconds
          setTimeout(() => {
            clearInterval(checkInterval);
            resolve();
          }, 10000);
        }
      });
    }

    // Wait for scripts to load and initialize components
    function waitForComponents() {
      return Promise.all([
        new Promise(resolve => {
          if (typeof AppCheckManager !== 'undefined') resolve();
          else {
            const checkInterval = setInterval(() => {
              if (typeof AppCheckManager !== 'undefined') {
                clearInterval(checkInterval);
                resolve();
              }
            }, 100);
            // Timeout after 5 seconds
            setTimeout(() => {
              clearInterval(checkInterval);
              resolve();
            }, 5000);
          }
        }),
        new Promise(resolve => {
          if (typeof MobileMenu !== 'undefined') resolve();
          else {
            const checkInterval = setInterval(() => {
              if (typeof MobileMenu !== 'undefined') {
                clearInterval(checkInterval);
                resolve();
              }
            }, 100);
            // Timeout after 5 seconds
            setTimeout(() => {
              clearInterval(checkInterval);
              resolve();
            }, 5000);
          }
        })
      ]);
    }

    // Initialize components when ready
    async function initializeComponents() {
      try {
        // Wait for Firebase and components to load
        await waitForFirebase();
        await waitForComponents();
        
        // Check if Firebase is available
        if (typeof firebase === 'undefined') {
          console.error('❌ Firebase no está disponible');
          return;
        }
        
        // Get Firebase app
        const firebaseApp = firebase.app();
        
        // Initialize App Check Manager
        const appCheckManager = new AppCheckManager(firebaseApp, {
          siteKey: "6LfdTvQrAAAAACkGjvbbFIkqHMsTHwRYYZS_CGq2",
          autoRefresh: true,
          debugMode: true
        });
        
        // Initialize Mobile Menu
        const mobileMenu = new MobileMenu();
        
        // Initialize App Check with smart fallback
        await appCheckManager.init();
        
        // Show status banner
        appCheckManager.showStatusBanner();
        
        console.log('✅ App Check Manager y Mobile Menu inicializados');
        
      } catch (error) {
        console.error('Error inicializando componentes:', error);
      }
    }
    
    // Start initialization when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializeComponents);
    } else {
      initializeComponents();
    }
  </script>
</body>
</html>
